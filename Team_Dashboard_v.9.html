<!DOCTYPE html>
<html lang="en" data-theme="light" data-print-mode="off">
<head>
  <meta charset="UTF-8">
  <title>Business Analysis &amp; Product Management – Portfolio Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Executive Portfolio View for Business Analysis &amp; Product Management: Duration, Risk profile, Client coverage and LoS. Reads directly from CSV or Excel uploads in your browser.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f3f4f6;
      --surface: #ffffff;
      --surface-subtle: #f9fafb;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;

      --pwc-orange: #dc6900;
      --pwc-light-orange: #f39c12;
      --pwc-red: #e0301e;
      --pwc-dark-red: #a32020;

      --accent: var(--pwc-orange);
      --accent-soft: rgba(220,105,0,0.06);
      --accent-soft-strong: rgba(220,105,0,0.12);

      --green: #16a34a;
      --amber: var(--pwc-light-orange);
      --red: var(--pwc-red);
      --hold: #6b7280;

      --row-alt: #ffffff;
      --focus-ring: #2563eb;

      --topbar-bg: linear-gradient(90deg, #111827, #1f2937);
      --topbar-border: rgba(148,163,184,0.25);
      --topbar-text: #f9fafb;
      --topbar-muted: #e5e7eb;

      --shadow-strong: 0 18px 45px rgba(15,23,42,0.16);
      --shadow-card: 0 6px 16px rgba(15,23,42,0.06);
      --shadow-card-strong: 0 8px 24px rgba(15,23,42,0.09);

      --chart-axis: #4b5563;
      --chart-grid: #e5e7eb;
      --chart-label: #111827;

      --message-info-bg: #e0f2fe;
      --message-info-text: #0f172a;
      --message-error-bg: #fee2e2;
      --message-error-text: #7f1d1d;
      --message-success-bg: #dcfce7;
      --message-success-text: #14532d;

      --font-xs: 0.7rem;
      --font-sm: 0.78rem;
      --font-base: 0.84rem;
      --font-md: 0.9rem;
      --font-lg: 1rem;
      --line-tight: 1.2;
      --line-normal: 1.45;

      --icon-neutral: #6b7280;
      --icon-active: var(--accent);

      --transition-fast: 150ms ease-out;
      --transition-med: 200ms ease-out;
    }

    html[data-theme="dark"] {
      --bg: #020617;
      --surface: #020617;
      --surface-subtle: #0b1120;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;

      --accent: #f97316;
      --accent-soft: rgba(249,115,22,0.1);
      --accent-soft-strong: rgba(249,115,22,0.2);

      --green: #22c55e;
      --amber: #facc15;
      --red: #f97373;
      --hold: #9ca3af;

      --row-alt: #020617;
      --focus-ring: #60a5fa;

      --topbar-bg: linear-gradient(90deg, #020617, #111827);
      --topbar-border: #020617;
      --topbar-text: #f9faff;
      --topbar-muted: #cbd5f5;

      --shadow-strong: 0 18px 45px rgba(15,23,42,0.9);
      --shadow-card: 0 8px 24px rgba(15,23,42,0.8);
      --shadow-card-strong: 0 12px 40px rgba(15,23,42,0.95);

      --chart-axis: #e5e7eb;
      --chart-grid: #111827;
      --chart-label: #f9fafb;

      --message-info-bg: #1d4ed8;
      --message-info-text: #eff6ff;
      --message-error-bg: #7f1d1d;
      --message-error-text: #fee2e2;
      --message-success-bg: #166534;
      --message-success-text: #dcfce7;

      --icon-neutral: #9ca3af;
      --icon-active: var(--accent);
    }

    * { box-sizing: border-box; }
    html, body { max-width: 100%; overflow-x: hidden; }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top left, #fff7ed 0, var(--bg) 38%, #e5e7eb 100%);
      color: var(--text);
      font-size: var(--font-base);
      line-height: var(--line-normal);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      transition: background var(--transition-med), color var(--transition-med);
    }

    html[data-theme="dark"] body {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .top-bar {
      border-bottom: 1px solid var(--topbar-border);
      background: var(--topbar-bg);
      color: var(--topbar-text);
      padding: 0.5rem 0 0.3rem;
      box-shadow: 0 10px 32px rgba(15,23,42,0.4);
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(12px);
    }

    .top-bar-inner {
      max-width: 72rem;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .top-bar-title {
      font-size: var(--font-md);
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .asof-pill {
      font-size: var(--font-xs);
      color: var(--topbar-muted);
      opacity: 0.9;
      white-space: nowrap;
    }

    .pwc-mark {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(148,163,184,0.4);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .logo-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(15,23,42,0.35);
    }
    html[data-theme="dark"] .logo-chip {
      background: #020617;
      border-color: #334155;
    }

    .logo-img {
      height: 1.25rem;
      width: auto;
      display: block;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: var(--font-xs);
      color: var(--topbar-muted);
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .theme-toggle input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .toggle-track {
      width: 2rem;
      height: 1rem;
      border-radius: 999px;
      background: rgba(148,163,184,0.4);
      position: relative;
      transition: background var(--transition-fast);
    }
    .toggle-thumb {
      width: 0.875rem;
      height: 0.875rem;
      border-radius: 999px;
      background: #f9fafb;
      position: absolute;
      top: 1px;
      left: 1px;
      transition: transform var(--transition-fast),
                  background var(--transition-fast),
                  box-shadow var(--transition-fast);
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    .theme-toggle input:checked + .toggle-track {
      background: var(--accent-soft-strong);
    }
    .theme-toggle input:checked + .toggle-track .toggle-thumb {
      transform: translateX(1rem);
      background: #fffbeb;
      box-shadow: 0 1px 4px rgba(0,0,0,0.7);
    }

    .message-bar {
      max-width: 72rem;
      margin: 0.25rem auto 0;
      padding: 0 1rem 0.25rem;
    }
    .message-bar-inner {
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      font-size: var(--font-xs);
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      box-shadow: 0 4px 14px rgba(15,23,42,0.2);
    }
    .message-bar-inner.info {
      background: var(--message-info-bg);
      color: var(--message-info-text);
    }
    .message-bar-inner.error {
      background: var(--message-error-bg);
      color: var(--message-error-text);
    }
    .message-bar-inner.success {
      background: var(--message-success-bg);
      color: var(--message-success-text);
    }
    .message-bar-text {
      flex: 1;
    }
    .message-bar-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.75rem;
      color: inherit;
      padding: 0;
      line-height: 1;
    }

    .page {
      max-width: 72rem;
      width: 100%;
      margin: 0.45rem auto 1.4rem;
      padding: 0.9rem 0.8rem 1.1rem;
      background: radial-gradient(circle at top, var(--surface) 0, var(--surface-subtle) 40%, var(--bg) 100%);
      border-radius: 1rem;

      /* Expanded / stronger border */
      border: 2px solid rgba(148,163,184,0.6);
      box-shadow: var(--shadow-strong);

      transition: box-shadow var(--transition-med), background var(--transition-med), border-color var(--transition-med);
    }
    html[data-theme="dark"] .page {
      box-shadow: var(--shadow-strong);
      border-color: #334155;
    }

    .header-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.6rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.55rem;
    }

    .heading-block { flex: 1; min-width: 0; }
    .heading {
      font-size: 1.05rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      margin: 0;
      color: var(--text);
      line-height: var(--line-tight);
    }
    .subheading {
      font-size: var(--font-base);
      color: var(--muted);
      max-width: 980px;
      margin-top: 0.35rem;
      line-height: var(--line-normal);
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.4rem;
      white-space: nowrap;
    }

    .timestamp {
      font-size: var(--font-xs);
      color: var(--muted);
      margin: 0.2rem 0 0.8rem;
    }

    .btn {
      font-size: var(--font-xs);
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.9);
      background: var(--surface);
      cursor: pointer;
      white-space: nowrap;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      min-height: 2.1rem;
      transition: background var(--transition-fast),
                  border-color var(--transition-fast),
                  color var(--transition-fast),
                  box-shadow var(--transition-fast),
                  transform var(--transition-fast);
    }
    .btn:hover {
      background: var(--surface-subtle);
      border-color: #9ca3af;
      transform: translateY(-0.5px);
      box-shadow: 0 3px 8px rgba(15,23,42,0.15);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }
    .btn:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 2px;
    }

    .btn-secondary {
      border-color: #d1d5db;
      color: var(--text);
      background: var(--surface-subtle);
    }
    html[data-theme="dark"] .btn,
    html[data-theme="dark"] .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border-color: #334155;
    }
    html[data-theme="dark"] .btn:hover,
    html[data-theme="dark"] .btn-secondary:hover {
      background: #0f172a;
      border-color: #475569;
    }

    .btn-icon {
      font-size: 0.875rem;
      line-height: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-small {
      font-size: 0.7rem;
      padding: 0.25rem 0.6rem;
      min-height: 1.75rem;
    }

    .btn.btn-filter {
      padding: 0.35rem 0.8rem;
      min-height: 2.25rem;
      min-width: 40px;
    }
    .btn-print-now-hidden {
      display: none;
    }

    .filter-icon {
      width: 16px;
      height: 16px;
      display: block;
      color: var(--icon-neutral);
    }
    .filters-header-icon .filter-icon,
    #toggleFilters .filter-icon {
      color: var(--icon-neutral);
    }

    .filters-active #toggleFilters {
      border-color: var(--icon-active);
      background: var(--accent-soft);
      color: var(--icon-active);
    }
    .filters-active #toggleFilters .filter-icon {
      color: var(--icon-active);
    }

    #toggleFilters .btn-icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .filters-header-icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 0.7rem;
    }
    @media (max-width: 960px) {
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .grid { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0.625rem;
      padding: 0.7rem 0.8rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: var(--shadow-card);
      transition: box-shadow var(--transition-med),
                  transform var(--transition-fast),
                  border-color var(--transition-fast),
                  background var(--transition-fast);
    }
    .card:hover {
      box-shadow: var(--shadow-card-strong);
      transform: translateY(-1px);
      border-color: rgba(148,163,184,0.8);
    }

    .card-header {
      font-size: var(--font-xs);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
    }

    .kpi-label { flex: 1; }

    .kpi-icon {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      color: #fff;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.05);
    }
    .kpi-icon.total    { background: var(--accent); }
    .kpi-icon.closed   { background: var(--pwc-dark-red); }
    .kpi-icon.duration { background: var(--pwc-light-orange); }
    .kpi-icon.upcoming { background: var(--amber); }

    .kpi-value {
      font-size: 1.55rem;
      font-weight: 600;
      margin-bottom: 1px;
      color: var(--accent);
    }

    .kpi-caption {
      font-size: var(--font-xs);
      color: var(--muted);
      line-height: 1.4;
    }

    .filters-header {
      max-width: 72rem;
      margin: 0.15rem auto 0.3rem;
      padding: 0.35rem 0.4rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: var(--font-xs);
      color: var(--muted);
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(249,250,251,0.95), rgba(255,255,255,0.95));
      position: relative;
      overflow: hidden;
    }
    .filters-header::before {
      content: '';
      position: absolute;
      inset-inline: 0;
      bottom: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent-soft-strong), transparent);
      opacity: 0.9;
      pointer-events: none;
    }

    .filters-header-left {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 0;
    }

    .filters-header-title {
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-weight: 600;
      color: var(--text);
    }

    .filters-header-subtitle {
      font-size: 0.68rem;
      color: var(--muted);
      margin-top: 1px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .filters-header-right {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: var(--font-xs);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .filters-header-badge {
      padding: 0.12rem 0.55rem;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid var(--accent-soft-strong);
      color: var(--accent);
      font-weight: 500;
    }

    .filters-header-clear-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: var(--font-xs);
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .filters-header-clear-btn:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 2px;
    }

    .filter-bar {
      background: radial-gradient(circle at top left, var(--surface) 0, var(--surface-subtle) 70%);
      border: 1px solid var(--border);
      border-radius: 0.85rem;
      padding: 0.6rem 0.75rem 0.65rem;
      margin: 0 auto 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      box-shadow: var(--shadow-card);
      max-width: 72rem;
      position: relative;
    }
    .filter-bar[hidden] {
      display: none !important;
    }
    .filter-bar.dragover::after {
      content: "Drop CSV or Excel file to upload";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(37,99,235,0.08);
      border: 2px dashed var(--focus-ring);
      color: var(--text);
      font-size: var(--font-md);
      border-radius: 0.85rem;
      pointer-events: none;
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 0.45rem;
      width: 100%;
    }
    @media (max-width: 960px) {
      .filter-row { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .filter-row { grid-template-columns: minmax(0, 1fr); }
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
      min-width: 0;
    }

    .filter-group.search-group {
      grid-column: span 2;
    }
    @media (max-width: 960px) {
      .filter-group.search-group { grid-column: span 3; }
    }
    @media (max-width: 640px) {
      .filter-group.search-group { grid-column: span 1; }
    }

    .filter-label {
      font-size: var(--font-xs);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.25rem;
    }

    .filter-control {
      font-size: var(--font-xs);
      padding: 0.34rem 0.48rem;
      border-radius: 0.45rem;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: var(--text);
      width: 100%;
      transition: border-color var(--transition-fast),
                  box-shadow var(--transition-fast),
                  background var(--transition-fast);
    }

    .filter-control:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 1px;
      border-color: var(--focus-ring);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }

    .filter-search-wrap { position: relative; }
    .filter-search-icon {
      position: absolute;
      top: 50%;
      left: 0.4rem;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
    }
    .filter-search {
      padding-left: 1.5rem;
    }

    .multiselect {
      position: relative;
      font-size: var(--font-xs);
    }

    .multiselect-display {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.25rem;
      padding: 0.3rem 0.45rem;
      border-radius: 0.45rem;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      min-height: 1.9rem;
      transition: border-color var(--transition-fast),
                  box-shadow var(--transition-fast),
                  background var(--transition-fast);
    }

    .multiselect-display:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 1px;
      border-color: var(--focus-ring);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }

    .multiselect-display span.placeholder {
      color: #9ca3af;
    }

    .multiselect-display-items {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.2rem;
      overflow: hidden;
    }

    .multiselect-arrow {
      font-size: 0.6rem;
      color: var(--muted);
      flex-shrink: 0;
    }

    .multiselect-clear {
      border: none;
      background: transparent;
      font-size: 0.6rem;
      color: var(--muted);
      cursor: pointer;
      padding: 0 0 0 0.25rem;
      flex-shrink: 0;
    }

    .multiselect-menu {
      position: absolute;
      z-index: 30;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--surface);
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card-strong);
      max-height: 220px;
      overflow-y: auto;
      padding: 0.25rem 0;
      display: none;
    }

    .multiselect-menu[data-open="true"] {
      display: block;
    }

    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.65rem;
      font-size: var(--font-xs);
      cursor: pointer;
    }

    .multiselect-option input {
      accent-color: var(--accent);
      cursor: pointer;
    }

    .multiselect-option:hover {
      background: var(--accent-soft);
    }

    .multiselect-empty {
      padding: 0.4rem 0.65rem;
      font-size: var(--font-xs);
      color: var(--muted);
    }

    .multiselect-pill {
      padding: 0.08rem 0.35rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--text);
      white-space: nowrap;
    }

    .filter-actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      padding-top: 0.4rem;
      margin-top: 0.35rem;
      border-top: 1px dashed var(--border);
    }

    .filter-actions-left {
      font-size: var(--font-xs);
      color: var(--muted);
    }

    .filter-actions-right {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.35rem;
      justify-content: flex-end;
      width: 100%;
      overflow-x: auto;
      padding-bottom: 1px;
    }

    .active-filters {
      max-width: 72rem;
      margin: 0.2rem auto 0.65rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      font-size: var(--font-xs);
      color: var(--muted);
      align-items: center;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.14rem 0.55rem;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid var(--accent-soft-strong);
      color: var(--text);
    }

    .filter-chip-label {
      font-weight: 500;
    }

    .filter-chip-clear,
    .filter-chip-clear-all {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.7rem;
      color: var(--muted);
      padding: 0 0 0 0.25rem;
    }

    .filter-chip-clear-all {
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .filter-chip-clear:focus-visible,
    .filter-chip-clear-all:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 2px;
    }

    .chart-wrap {
      width: 100%;
      max-width: 100%;
      position: relative;
      overflow: hidden;
      min-height: 230px;
    }

    .portfolio-chart-wrap {
      padding-top: 0;
      margin-top: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .industry-panel {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .industry-chart-scroll {
      max-height: 320px;
      overflow-y: auto;
      padding-right: 2px;
    }
    .industry-chart-inner {
      position: relative;
      min-height: 200px;
    }
    #industryChart {
      display: block;
      width: 100% !important;
    }

    .chart-empty-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xs);
      color: var(--muted);
      padding: 0.6rem;
      text-align: center;
      background: radial-gradient(circle at top, rgba(249,250,251,0.9), rgba(249,250,251,0.7));
      pointer-events: none;
    }
    html[data-theme="dark"] .chart-empty-overlay {
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
    }

    .donut-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      font-weight: 600;
      color: var(--text);
      pointer-events: none;
      text-align: center;
    }
    .donut-caption {
      font-size: var(--font-xs);
      font-weight: 400;
      margin-top: 0.15rem;
      color: var(--muted);
    }

    .section-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1.2rem;
      margin-bottom: 0.45rem;
      padding: 0.2rem 0.2rem 0.2rem 0;
      border-bottom: 1px solid var(--border);
    }

    .section-title {
      font-size: var(--font-md);
      font-weight: 600;
      color: var(--text);
    }

    .pill {
      padding: 0.18rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: var(--font-xs);
      color: var(--muted);
      background: var(--surface);
    }

    .projects-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.55rem 0.7rem 0.75rem;
      page-break-before: always;
      box-shadow: var(--shadow-card);
    }

    .table-wrap {
      border-radius: 0.6rem;
      border: 1px solid var(--border);
      background: var(--surface);
      overflow-x: auto;
      overflow-y: auto;
      max-height: 40rem;
      width: 100%;
      box-sizing: border-box;
    }

    table.data-table {
      border-collapse: collapse;
      table-layout: auto;
      width: max-content;
      min-width: 100%;
      font-size: 0.8rem;
      font-weight: 400;
      border: 1px solid #e5e7eb;
      color: var(--text);
      background: var(--surface);
    }
    html[data-theme="dark"] table.data-table {
      border-color: #374151;
    }

    table.data-table.compact {
      font-size: 0.75rem;
    }
    table.data-table.compact th,
    table.data-table.compact td {
      padding: 0.3rem 0.4rem;
    }

    .data-table thead {
      background: #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 2;
      box-shadow: 0 1px 0 var(--border);
    }
    html[data-theme="dark"] .data-table thead {
      background: #0f172a;
      box-shadow: 0 1px 0 #1f2937;
    }

    .data-table th,
    .data-table td {
      padding: 0.5rem 0.55rem;
      border-bottom: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      text-align: center;
      vertical-align: middle;
      font-weight: 400;
    }
    html[data-theme="dark"] .data-table th,
    html[data-theme="dark"] .data-table td {
      border-color: #374151;
    }

    .data-table th:last-child,
    .data-table td:last-child {
      border-right: 1px solid #e5e7eb;
    }

    .data-table th {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      cursor: pointer;
      white-space: nowrap;
      position: relative;
      background-clip: padding-box;
    }

    .data-table th:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: -2px;
    }

    .data-table th .sort-indicator {
      margin-left: 0.25rem;
      font-size: 0.55rem;
      opacity: 0.8;
    }

    .data-table tbody tr:nth-child(even) td {
      background: #ffffff;
    }
    html[data-theme="dark"] .data-table tbody tr:nth-child(even) td {
      background: #020617;
    }

    .data-table tbody tr:hover td {
      background: rgba(220,105,0,0.06);
    }

    .data-table td.col-name,
    .data-table td.col-capability,
    .data-table td.col-status,
    .data-table td.col-rag,
    .data-table td.col-date,
    .data-table td.col-territory,
    .data-table td.col-client,
    .data-table td.col-short,
    .data-table td.col-notes {
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .data-table td.col-name       { max-width: 260px; }
    .data-table td.col-capability { max-width: 200px; }
    .data-table td.col-client     { max-width: 200px; }
    .data-table td.col-notes      { max-width: 400px; }

    .status-pill,
    .rag-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      border-radius: 999px;
      padding: 0.18rem 0.48rem;
      border: 1px solid currentColor;
      font-size: 0.7rem;
      background: var(--surface);
      white-space: nowrap;
      text-align: center;
    }
    html[data-theme="dark"] .status-pill,
    html[data-theme="dark"] .rag-pill {
      background: #020617;
    }

    .status-dot,
    .rag-dot {
      width: 0.45rem;
      height: 0.45rem;
      border-radius: 999px;
      flex-shrink: 0;
    }

    .table-footer {
      margin-top: 0.45rem;
      padding-top: 0.3rem;
      border-top: 1px dashed var(--border);
      font-size: var(--font-xs);
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .portfolio-card {
      padding: 0.9rem 0.95rem 0.85rem;
      margin-bottom: 0.9rem;
      background: var(--surface);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card);
      page-break-inside: avoid;
    }

    .portfolio-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
      padding-bottom: 0.35rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.4rem;
    }

    .portfolio-title {
      font-size: var(--font-md);
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text);
      margin: 0;
    }

    .portfolio-subtitle {
      font-size: var(--font-xs);
      color: var(--muted);
      margin-top: 0.15rem;
    }

    .portfolio-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      justify-content: flex-end;
    }

    .portfolio-chip {
      font-size: 0.625rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.18rem 0.48rem;
      background: var(--surface-subtle);
      color: var(--text);
    }

    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.85rem;
      margin-top: 0.45rem;
      align-items: stretch;
      justify-content: stretch;
    }
    @media (max-width: 960px) {
      .portfolio-grid { grid-template-columns: minmax(0, 1fr); }
    }

    .portfolio-panel {
      background: var(--surface);
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      padding: 0.45rem 0.55rem 0.45rem;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.01);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      transition: box-shadow var(--transition-fast),
                  transform var(--transition-fast),
                  border-color var(--transition-fast);
    }
    .portfolio-panel:hover {
      box-shadow: var(--shadow-card-strong);
      transform: translateY(-1px);
      border-color: rgba(148,163,184,0.8);
    }

    .portfolio-panel-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.35rem;
      margin-bottom: 0.15rem;
    }

    .panel-title {
      font-size: var(--font-sm);
      font-weight: 600;
      color: var(--text);
    }

    .panel-subtitle {
      font-size: var(--font-xs);
      color: var(--muted);
      margin-top: 0.1rem;
    }

    .panel-actions {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .metrics-summary {
      font-size: var(--font-xs);
      color: var(--muted);
      margin: 0.35rem 0 0.6rem;
    }

    .footnote {
      margin-top: 0.9rem;
      font-size: var(--font-xs);
      color: var(--muted);
      line-height: 1.4;
      text-align: center;
    }

    .getting-started {
      margin: 0.4rem 0 0.8rem;
      padding: 0.6rem 0.75rem;
      border-radius: 0.6rem;
      border: 1px dashed var(--border);
      background: var(--surface-subtle);
      font-size: var(--font-xs);
      color: var(--muted);
    }

    .getting-started-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text);
    }

    .getting-started-steps {
      margin: 0.25rem 0 0;
      padding-left: 1.1rem;
    }
    .getting-started-steps li {
      margin-bottom: 0.15rem;
    }

    .getting-started.is-hidden { display: none; }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    .site-footer {
      padding: 12px 16px;
      text-align: center;
      font-size: 11px;
      color: #6b7280;
    }

    .site-footer-inner {
      max-width: 1320px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    @media (max-width: 640px) {
      .header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        align-items: flex-start;
      }
      .top-bar-inner {
        flex-wrap: wrap;
      }
      .filters-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .filters-header-right {
        width: 100%;
        justify-content: flex-start;
      }
      .top-bar-title {
        white-space: normal;
      }
    }

    @media print {
      :root {
        --bg: #ffffff;
        --surface: #ffffff;
        --surface-subtle: #ffffff;
        --border: #d1d5db;
        --shadow-strong: none;
        --shadow-card: none;
      }

      body {
        background: #ffffff !important;
      }

      .top-bar,
      .message-bar,
      #toggleFilters,
      #btnExportCsv,
      #btnDownloadHtml,
      #printModeToggle,
      #btnResetDashboard,
      #toggleDensity,
      #uploadData,
      [data-export-chart],
      .site-footer {
        display: none !important;
      }

      .page {
        box-shadow: none;
        margin: 0;
        border-radius: 0;
        padding: 0.5rem 0.25rem;
        border: none;
      }

      .table-wrap {
        max-height: none !important;
        overflow: visible !important;
      }
    }

    .los-territory-strip {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 0.85rem;
      margin-top: 0.45rem;
    }
    @media (max-width: 960px) {
      .los-territory-strip {
        grid-template-columns: minmax(0,1fr);
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="top-bar" role="banner">
    <div class="top-bar-inner">
      <div>
        <div class="top-bar-title">Business Analysis &amp; Product Management Team</div>
      </div>
      <div class="top-bar-right">
        <label class="theme-toggle" title="Toggle dark mode">
          <span class="sr-only">Toggle dark mode</span>
          <input id="themeToggle" type="checkbox" aria-label="Toggle dark mode">
          <span class="toggle-track">
            <span class="toggle-thumb"></span>
          </span>
          <span>Dark mode</span>
        </label>

        <span class="asof-pill" id="asOfTop" aria-live="polite">As of —</span>
        <div class="pwc-mark" aria-label="PwC brand">
          <span class="logo-chip">
            <img class="logo-img" src="https://upload.wikimedia.org/wikipedia/commons/c/c3/PwC_Company_Logo.svg" alt="PwC logo">
          </span>
        </div>
      </div>
    </div>
    <div class="message-bar" aria-live="polite">
      <div id="messageBarInner" class="message-bar-inner" role="status">
        <span id="messageBarText" class="message-bar-text"></span>
        <button id="messageBarClose" class="message-bar-close" type="button" aria-label="Dismiss message">✕</button>
      </div>
    </div>
  </div>
  <main role="main">
    <div class="page">
      <header class="header-row" aria-label="Dashboard header">
        <div class="heading-block">
          <h1 class="heading">All Project Portfolio – Executive View</h1>
          <p class="subheading">
            Single View Of Portfolio Delivery, Risk, Client Coverage and LoS for the Business Analysis &amp; Product Management team.
          </p>
        </div>
        <div class="header-right">
          <button id="toggleFilters" class="btn btn-filter" aria-expanded="true" aria-controls="filterBar" type="button">
            <span class="btn-icon" aria-hidden="true">
              <svg class="filter-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M4 5h16M7 12h10M10 19h4"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                      stroke-linecap="round"
                      stroke-linejoin="round" />
              </svg>
            </span>
            <span>Hide filters</span>
          </button>
        </div>
      </header>

      <p class="timestamp" id="asOf" aria-live="polite">As of —</p>


      <div class="filters-header" id="filtersHeader" aria-label="Filter summary">
        <div class="filters-header-left">
          <span class="filters-header-icon" aria-hidden="true">
            <svg class="filter-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M4 5h16M7 12h10M10 19h4"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
          </span>
          <div>
            <div class="filters-header-title">Filters</div>
          </div>
        </div>

        <div class="filters-header-right">
          <span id="filtersSummary" class="filters-header-badge">No filters applied</span>
          <button id="filtersHeaderClear" class="filters-header-clear-btn" type="button">Clear all</button>
        </div>
      </div>

      <section id="filterBar" class="filter-bar" aria-label="Portfolio filters">
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label" for="filterStatus">Status</label>
            <div class="multiselect" data-key="status" id="filterStatus">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="filterStatusMenu">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear status filter" aria-label="Clear status filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div id="filterStatusMenu" class="multiselect-menu" data-open="false" role="listbox" aria-label="Status options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterRag">RAG</label>
            <div class="multiselect" data-key="rag" id="filterRag">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="filterRagMenu">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear RAG filter" aria-label="Clear RAG filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div id="filterRagMenu" class="multiselect-menu" data-open="false" role="listbox" aria-label="RAG options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterTerritory">Territory</label>
            <div class="multiselect" data-key="territory" id="filterTerritory">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="filterTerritoryMenu">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear territory filter" aria-label="Clear territory filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div id="filterTerritoryMenu" class="multiselect-menu" data-open="false" role="listbox" aria-label="Territory options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterIndustry">
              Industry
            </label>
            <div class="multiselect" data-key="industry" id="filterIndustry">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="filterIndustryMenu">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear industry filter" aria-label="Clear industry filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div id="filterIndustryMenu" class="multiselect-menu" data-open="false" role="listbox" aria-label="Industry options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterDuration">Duration</label>
            <select id="filterDuration" class="filter-control">
              <option value="">All</option>
              <option value="0-6">0 – 6 months</option>
              <option value="6-12">6 – 12 months</option>
              <option value="12+">More than 1 year</option>
            </select>
          </div>

          <div></div>
        </div>

        <div class="filter-row" style="margin-top:0.15rem;">
          <div class="filter-group">
            <label class="filter-label" for="filterCapability">Capability</label>
            <div class="multiselect" data-key="capability" id="filterCapability">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="filterCapabilityMenu">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear capability filter" aria-label="Clear capability filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div id="filterCapabilityMenu" class="multiselect-menu" data-open="false" role="listbox" aria-label="Capability options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterMultiTower">Multi‑tower</label>
            <div class="multiselect" data-key="multiTower" id="filterMultiTower">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="filterMultiTowerMenu">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear multi‑tower filter" aria-label="Clear multi‑tower filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div id="filterMultiTowerMenu" class="multiselect-menu" data-open="false" role="listbox" aria-label="Multi‑tower options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterResources">Team resources</label>
            <div class="multiselect" data-key="resources" id="filterResources">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="filterResourcesMenu">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear team resources filter" aria-label="Clear team resources filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div id="filterResourcesMenu" class="multiselect-menu" data-open="false" role="listbox" aria-label="Team resources options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterUtilisation">Team utilisation %</label>
            <div class="multiselect" data-key="utilisation" id="filterUtilisation">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="filterUtilisationMenu">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear utilisation filter" aria-label="Clear utilisation filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div id="filterUtilisationMenu" class="multiselect-menu" data-open="false" role="listbox" aria-label="Utilisation options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterLoS">LoS</label>
            <div class="multiselect" data-key="LoS" id="filterLoS">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false" aria-controls="filterLoSMenu">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear LoS filter" aria-label="Clear LoS filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div id="filterLoSMenu" class="multiselect-menu" data-open="false" role="listbox" aria-label="LoS options"></div>
            </div>
          </div>

          <div class="filter-group search-group">
            <label class="filter-label" for="filterSearch">Search</label>
            <div class="filter-search-wrap">
              <span class="filter-search-icon" aria-hidden="true">
                <svg class="filter-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <circle cx="11" cy="11" r="6" fill="none" stroke="currentColor" stroke-width="1.6"/>
                  <line x1="16" y1="16" x2="21" y2="21" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
              </span>
              <input id="filterSearch" class="filter-control filter-search" type="text"
                     placeholder="Search by project, client, industry, scope or risks…" aria-label="Search projects" />
            </div>
          </div>
        </div>

        <div class="filter-actions-row">
          <div class="filter-actions-left">
            Data actions
          </div>
          <div class="filter-actions-right">
            <label class="btn btn-secondary" style="cursor:pointer;">
              <span class="btn-icon" aria-hidden="true">⬆</span>
              <span>Upload (CSV / Excel)</span>
              <input
                id="uploadData"
                class="upload-input"
                type="file"
                aria-label="Upload CSV or Excel file"
                accept=".csv,.xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv"
                style="display:none;">
            </label>
            <button id="btnResetDashboard" class="btn btn-secondary" type="button" title="Clear data and reset view">
              <span class="btn-icon" aria-hidden="true">↺</span>
              <span>Reset (clear data)</span>
            </button>
          </div>
        </div>
      </section>

      <section aria-label="Active filters" id="activeFilters" class="active-filters"></section>

      <section class="grid" style="margin-bottom: 8px;" aria-label="Key portfolio indicators">
        <article class="card" aria-label="Total projects">
          <div class="card-header">
            <span class="kpi-label">Total projects</span>
            <span class="kpi-icon total" aria-hidden="true">Σ</span>
          </div>
          <div class="kpi-value" id="kpiTotal">–</div>
          <div class="kpi-caption">All initiatives in the current view.</div>
        </article>

        <article class="card" aria-label="At-risk projects">
          <div class="card-header">
            <span class="kpi-label">At risk (Amber / Red)</span>
            <span class="kpi-icon duration" aria-hidden="true">⚠</span>
          </div>
          <div class="kpi-value" id="kpiAtRisk">–</div>
          <div class="kpi-caption">Projects flagged Amber or Red in the current view.</div>
        </article>

        <article class="card" aria-label="Projects finishing in the next 30 days">
          <div class="card-header">
            <span class="kpi-label">Finishing in next 30 days</span>
            <span class="kpi-icon upcoming" aria-hidden="true">📅</span>
          </div>
          <div class="kpi-value" id="kpiUpcoming">–</div>
          <div class="kpi-caption">Projects with planned end dates in the next 30 days.</div>
        </article>

        <article class="card" aria-label="Closed projects">
          <div class="card-header">
            <span class="kpi-label">Closed projects</span>
            <span class="kpi-icon closed" aria-hidden="true">✔</span>
          </div>
          <div class="kpi-value" id="kpiClosed">–</div>
          <div class="kpi-caption">Engagements that have formally completed.</div>
        </article>

        <article class="card" aria-label="Multi‑tower projects">
          <div class="card-header">
            <span class="kpi-label">Multi‑tower projects</span>
          </div>
          <div class="kpi-value" id="kpiMultiTower">–</div>
          <div class="kpi-caption">
            Share of projects involving more than one tower (current view).
          </div>
        </article>
      </section>

      <p class="metrics-summary" id="metricsSummary" aria-live="polite">
        No projects in view. Upload data from a CSV or Excel file to get started.
      </p>

      <section id="gettingStarted" class="getting-started" aria-label="Getting started" aria-hidden="false">
        <div class="getting-started-title">Load your portfolio to begin</div>
        <p style="margin:4px 0 6px;">
          Data stays in your browser – nothing is uploaded to a server. CSV and Excel files are parsed locally for security and speed.
        </p>
        <ol class="getting-started-steps">
          <li>Use your existing portfolio export (CSV or Excel, one row per project).</li>
          <li>Click “Upload (CSV / Excel)” or drag‑and‑drop the file onto the filter bar to refresh this dashboard.</li>
        </ol>
      </section>

      <section class="card portfolio-card" aria-label="Portfolio analysis overview">
        <div class="portfolio-header">
          <div>
            <h2 class="portfolio-title">Portfolio analysis</h2>
            <p class="portfolio-subtitle">
              Coverage, duration and risk profile for the filtered portfolio, plus LoS split in key territories.
            </p>
          </div>
          <div class="portfolio-meta">
            <span class="portfolio-chip" id="portfolioProjectsChip">0 projects in view</span>
            <span class="portfolio-chip muted" id="portfolioIndustriesChip">0 industries</span>
          </div>
        </div>

        <!-- ROW 1 – RAG distribution + Projects by industry -->
        <div class="portfolio-grid" style="margin-bottom:0.85rem;">
          <!-- RAG DONUT -->
          <article class="portfolio-panel" aria-label="RAG distribution">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">RAG distribution</span><br>
                <span class="panel-subtitle" id="ragSubtitle">
                  Risk split across projects with a defined RAG rating (Green / Amber / Red).
                </span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button"
                        data-export-chart="ragDonut"
                        aria-label="Export RAG chart as PNG">
                  Export RAG PNG
                </button>
              </div>
            </div>
            <div class="chart-wrap portfolio-chart-wrap"
                 role="img"
                 aria-label="Projects by RAG status (Green, Amber, Red)">
              <canvas id="ragDonut"></canvas>
              <div class="chart-empty-overlay" id="ragEmpty" style="display:flex;">
                No RAG data in this view. Assign Green / Amber / Red to see the risk split.
              </div>
              <div class="donut-center" id="ragDonutCenter">
                <span id="ragDonutNumber">–</span>
                <div class="donut-caption" id="ragDonutCaption">Projects with RAG set</div>
              </div>
            </div>
          </article>

          <!-- Projects by industry -->
          <article class="portfolio-panel industry-panel" aria-label="Projects by industry">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">Projects by industry</span><br>
                <span class="panel-subtitle" id="industrySubtitle">
                  Number of projects per industry. Scroll if the list is long.
                </span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button"
                        data-export-chart="industryChart"
                        aria-label="Export industry chart as PNG">
                  Export industry PNG
                </button>
              </div>
            </div>
            <div class="industry-chart-scroll">
              <div class="industry-chart-inner">
                <canvas id="industryChart"></canvas>
                <div class="chart-empty-overlay" id="industryEmpty" style="display:flex;">
                  No industry data in the current view.
                </div>
              </div>
            </div>
          </article>
        </div>

        <!-- ROW 2 – Projects by duration range + Projects by territory -->
        <div class="portfolio-grid" style="margin-bottom:0.85rem;">
          <!-- DURATION BUCKETS (LEFT) -->
          <article class="portfolio-panel" aria-label="Projects by duration range">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">Projects by duration range</span><br>
                <span class="panel-subtitle" id="durationSubtitle">
                  Projects grouped by planned duration (months) based on valid start/end dates.
                </span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button"
                        data-export-chart="statusChart"
                        aria-label="Export duration chart as PNG">
                  Export duration PNG
                </button>
              </div>
            </div>
            <div class="chart-wrap portfolio-chart-wrap"
                 role="img"
                 aria-label="Projects by duration bucket">
              <canvas id="statusChart"></canvas>
              <div class="chart-empty-overlay" id="statusEmpty" style="display:flex;">
                No duration data in this view (missing or invalid start/end dates).
              </div>
            </div>
          </article>

          <!-- TERRITORY (RIGHT) -->
          <article class="portfolio-panel" aria-label="Projects by territory">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">Projects by territory</span><br>
                <span class="panel-subtitle">
                  Where the projects are delivered (territory field in your data).
                </span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button"
                        data-export-chart="territoryChart"
                        aria-label="Export territory chart as PNG">
                  Export territory PNG
                </button>
              </div>
            </div>
            <div class="chart-wrap portfolio-chart-wrap"
                 role="img"
                 aria-label="Projects by territory">
              <canvas id="territoryChart"></canvas>
              <div class="chart-empty-overlay" id="territoryEmpty" style="display:flex;">
                No territory data in the current view.
              </div>
            </div>
          </article>
        </div>

        <!-- ROW 3 – LoS by key territories (DE / UK / ME) -->
        <div class="los-territory-strip">
          <!-- LoS – DE -->
          <article class="portfolio-panel" aria-label="LoS – Germany (DE)">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">LoS – DE</span><br>
                <span class="panel-subtitle" id="losSubtitleDE">
                  LoS split for projects where territory is Germany (DE).
                </span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button"
                        data-export-chart="LoSChartDE" aria-label="Export LoS chart for DE as PNG">
                  Export DE PNG
                </button>
              </div>
            </div>
            <div class="chart-wrap portfolio-chart-wrap"
                 role="img"
                 aria-label="Projects by LoS – Germany (DE)">
              <canvas id="LoSChartDE"></canvas>
              <div class="chart-empty-overlay" id="LoSEmptyDE" style="display:flex;">
                No LoS data for DE in the current view.
              </div>
            </div>
          </article>

          <!-- LoS – UK -->
          <article class="portfolio-panel" aria-label="LoS – United Kingdom (UK)">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">LoS – UK</span><br>
                <span class="panel-subtitle" id="losSubtitleUK">
                  LoS split for projects where territory is the United Kingdom (UK).
                </span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button"
                        data-export-chart="LoSChartUK" aria-label="Export LoS chart for UK as PNG">
                  Export UK PNG
                </button>
              </div>
            </div>
            <div class="chart-wrap portfolio-chart-wrap"
                 role="img"
                 aria-label="Projects by LoS – United Kingdom (UK)">
              <canvas id="LoSChartUK"></canvas>
              <div class="chart-empty-overlay" id="LoSEmptyUK" style="display:flex;">
                No LoS data for UK in the current view.
              </div>
            </div>
          </article>

          <!-- LoS – ME -->
          <article class="portfolio-panel" aria-label="LoS – Middle East (ME)">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">LoS – ME</span><br>
                <span class="panel-subtitle" id="losSubtitleME">
                  LoS split for projects where territory is Middle East (ME).
                </span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button"
                        data-export-chart="LoSChartME" aria-label="Export LoS chart for ME as PNG">
                  Export ME PNG
                </button>
              </div>
            </div>
            <div class="chart-wrap portfolio-chart-wrap"
                 role="img"
                 aria-label="Projects by LoS – Middle East (ME)">
              <canvas id="LoSChartME"></canvas>
              <div class="chart-empty-overlay" id="LoSEmptyME" style="display:flex;">
                No LoS data for ME in the current view.
              </div>
            </div>
          </article>
        </div>
      </section>

      <div class="section-title-row">
        <h2 class="section-title">Projects</h2>
        <span class="pill" id="projectsCount">0 projects</span>
      </div>

      <section class="projects-card" aria-label="Project list">
        <div class="table-wrap" role="region" aria-label="Projects table">
          <table class="data-table" id="projectsTable" aria-describedby="projectsCount tableInfo">
            <thead>
            <tr>
              <th data-key="name"        scope="col" class="col-name">
                Project Name <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="capability"  scope="col" class="col-capability">
                Capability <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="status"      scope="col" class="col-status">
                Status <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="rag"         scope="col" class="col-rag">
                RAG <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="start"       scope="col" class="col-date">
                Start_Date <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="end"         scope="col" class="col-date">
                End_Date <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="durationMonths" scope="col" class="col-short">
                Duration (months) <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="territory"   scope="col" class="col-territory">
                Territory <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="client"      scope="col" class="col-client">
                Client <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="multiTower"  scope="col" class="col-short">
                Multi Tower <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="resources"   scope="col" class="col-short">
                Team Resources <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="industry"    scope="col" class="col-capability">
                Industry <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="LoS"         scope="col" class="col-short los-col">
                LoS <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="partner"     scope="col" class="col-short">
                Engagement Lead/Partner <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="utilisation" scope="col" class="col-short">
                Team Utilization % <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="scope"       scope="col" class="col-notes">
                Project Scope <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="risks"       scope="col" class="col-notes">
                Risks/Challenges <span class="sort-indicator" aria-hidden="true"></span>
              </th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="table-footer">
          <span id="tableInfo" aria-live="polite">No projects loaded yet.</span>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn" id="toggleDensity" aria-pressed="false" type="button">Compact view</button>
            <button class="btn btn-secondary" id="btnExportCsv" type="button">Export CSV</button>
            <button class="btn btn-secondary" id="printModeToggle" type="button" aria-pressed="false">Print / PDF mode</button>
            <button class="btn btn-secondary" id="btnDownloadHtml" type="button">Download</button>
            <button class="btn btn-secondary btn-print-now-hidden" id="btnPrintNow" type="button">Print</button>
          </div>
        </div>
      </section>

      <p class="footnote">
        This dashboard is initially empty. Upload a CSV or Excel file to populate it.
        Expected logical columns (order): Project Name, Capability, Status, RAG, Start_Date, End_Date,
        Duration (months) (calculated from dates), Territory, Client, Multi Tower, Team Resources,
        Industry, LoS, Engagement Lead/Partner, Team Utilization %, Project Scope, Risks/Challenges.
      </p>
    </div>
  </main>
</div>

<footer class="site-footer">
  <div class="site-footer-inner">
    <span></span>
    <span>PwC internal tool – © Copyright Omar Eleraky</span>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
(function registerDatalabels() {
  if (window.Chart && window.ChartDataLabels) {
    try { window.Chart.register(window.ChartDataLabels); } catch (e) { console.error(e); }
  } else {
    window.addEventListener('load', function () {
      if (window.Chart && window.ChartDataLabels) {
        try { window.Chart.register(window.ChartDataLabels); } catch (e) { console.error(e); }
      }
    });
  }
})();

(function polyfillCssEscape() {
  if (window.CSS && typeof CSS.escape === 'function') return;
  var css = window.CSS || (window.CSS = {});
  css.escape = function(value) {
    var string = String(value);
    var length = string.length;
    var index = -1;
    var codeUnit;
    var result = '';
    var firstCodeUnit = string.charCodeAt(0);
    while (++index < length) {
      codeUnit = string.charCodeAt(index);
      if (codeUnit === 0x0000) { result += '\uFFFD'; continue; }
      if (
        (codeUnit >= 0x0001 && codeUnit <= 0x001F) ||
        codeUnit === 0x007F ||
        (index === 0 && codeUnit >= 0x0030 && codeUnit <= 0x0039) ||
        (index === 1 && codeUnit >= 0x0030 && codeUnit <= 0x0039 && firstCodeUnit === 0x002D)
      ) {
        result += '\\' + codeUnit.toString(16) + ' ';
        continue;
      }
      if (
        codeUnit >= 0x0080 ||
        codeUnit === 0x002D ||
        codeUnit === 0x005F ||
        (codeUnit >= 0x0030 && codeUnit <= 0x0039) ||
        (codeUnit >= 0x0041 && codeUnit <= 0x005A) ||
        (codeUnit >= 0x0061 && codeUnit <= 0x007A)
      ) {
        result += string.charAt(index);
        continue;
      }
      result += '\\' + string.charAt(index);
    }
    return result;
  };
})();
</script>

<script>
const Dashboard = (function() {
  function parseDate(value) {
    if (value == null) return null;
    let s = String(value).trim();
    if (!s) return null;
    if (value instanceof Date && !isNaN(value)) return value;
    s = s.replace(/[.]/g, '/').replace(/-/g, '/');
    let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) {
      const a = parseInt(m[1],10), b = parseInt(m[2],10), y = parseInt(m[3],10);
      const tryD = (d1,m1) => {
        const d = new Date(y,m1-1,d1);
        return (!isNaN(d) && d.getDate()===d1 && d.getMonth()===m1-1 && d.getFullYear()===y) ? d : null;
      };
      return tryD(a,b) || tryD(b,a);
    }
    m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
    if (m) {
      const y = parseInt(m[1],10), mo = parseInt(m[2],10)-1, d = parseInt(m[3],10);
      const dt = new Date(y,mo,d);
      if (!isNaN(dt) && dt.getDate()===d && dt.getMonth()===mo && dt.getFullYear()===y) return dt;
    }
    m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2})$/);
    if (m) {
      const d = parseInt(m[1],10), mo = parseInt(m[2],10)-1; let y = parseInt(m[3],10);
      y = y<=50 ? 2000+y : 1900+y;
      const dt = new Date(y,mo,d);
      if (!isNaN(dt) && dt.getDate()===d && dt.getMonth()===mo && dt.getFullYear()===y) return dt;
    }
    const fb = new Date(s); return isNaN(fb)?null:fb;
  }

  function fmtDate(d) {
    if (!d) return '';
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${day}-${m}-${y}`;
  }

  function normalizeXlsxDateValue(v){
    if (!window.XLSX) {
      if (v instanceof Date && !isNaN(v)) return fmtDate(v);
      if (typeof v === 'string') return v;
      return '';
    }
    if (v instanceof Date && !isNaN(v)) return fmtDate(v);
    if (typeof v === 'number' && isFinite(v)) {
      try {
        const d = XLSX.SSF.parse_date_code(v);
        if (!d) return '';
        const js = new Date(d.y,d.m-1,d.d);
        if (isNaN(js)) return '';
        return fmtDate(js);
      } catch { return ''; }
    }
    if (typeof v === 'string') return v;
    return '';
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function getChartColors(){
    const cs = getComputedStyle(document.documentElement);
    return {
      accent: cs.getPropertyValue('--accent').trim(),
      green: cs.getPropertyValue('--green').trim(),
      amber: cs.getPropertyValue('--amber').trim(),
      red: cs.getPropertyValue('--red').trim(),
      hold: cs.getPropertyValue('--hold').trim(),
      axis: cs.getPropertyValue('--chart-axis').trim(),
      grid: cs.getPropertyValue('--chart-grid').trim(),
      label: cs.getPropertyValue('--chart-label').trim()
    };
  }

  function statusColor(s){
    const colors = getChartColors();
    s=(s||'').toLowerCase();
    if(s==='active') return colors.accent;
    if(s==='closed') return '#9ca3af';
    if(s==='on hold'||s==='on-hold') return colors.hold;
    return '#9ca3af';
  }
  function ragColor(r){
    const colors=getChartColors();
    r=(r||'').toLowerCase();
    if(r==='green') return colors.green;
    if(r==='amber') return colors.amber;
    if(r==='red') return colors.red;
    return '#9ca3af';
  }

  function compare(a,b,key){
    const va=a[key], vb=b[key];
    if(key==='utilisation'){
      const na=parseFloat(String(a.utilisation||'').replace('%',''))||0;
      const nb=parseFloat(String(b.utilisation||'').replace('%',''))||0;
      return na-nb;
    }
    if(key==='durationMonths'){
      const na = a.durationMonths!=null ? a.durationMonths : -Infinity;
      const nb = b.durationMonths!=null ? b.durationMonths : -Infinity;
      return na - nb;
    }
    if(va==null && vb==null) return 0;
    if(va==null) return 1;
    if(vb==null) return -1;
    if(va instanceof Date && vb instanceof Date) return va-vb;
    return String(va).localeCompare(String(vb));
  }

  function debounce(fn,wait){
    let t=null;
    return function(...args){
      clearTimeout(t);
      t=setTimeout(()=>fn.apply(this,args),wait);
    };
  }

  const Message=(function(){
    const bar=document.getElementById('messageBarInner');
    const textEl=document.getElementById('messageBarText');
    const closeBtn=document.getElementById('messageBarClose');
    let timerId = null;
    if(closeBtn&&bar){
      closeBtn.addEventListener('click',()=>{bar.style.display='none';});
    }
    function show(msg,type='info',ms=5000){
      if(!bar||!textEl) return;
      textEl.textContent=msg;
      bar.className='message-bar-inner '+type;
      bar.style.display='flex';
      if(timerId) clearTimeout(timerId);
      if(ms){
        timerId = setTimeout(()=>{ if(bar.style.display==='flex') bar.style.display='none';},ms);
      }
    }
    return {show};
  })();

  const DataService=(function(){
    const headerMap={};
    Object.assign(headerMap,{
      'project name':'name','project':'name','name':'name',
      'capability':'capability','capabilities':'capability',
      'status':'status','rag':'rag',
      'start_date':'start','start date':'start','start':'start',
      'end_date':'end','end date':'end','end':'end',
      'territory':'territory','region':'territory','country':'territory',
      'client':'client','customer':'client',
      'multi tower':'multiTower','multi-tower':'multiTower','multitower':'multiTower',
      'team resources':'resources','resources':'resources','ba resources':'resources','ba resource':'resources',
      'industry':'industry','sector':'industry',
      'los':'LoS','los ':'LoS','line of service':'LoS','line-of-service':'LoS','line_of_service':'LoS',
      'engagement lead / partner':'partner','engagement lead/partner':'partner','engagement lead':'partner','partner':'partner','partner name':'partner',
      'team utilization %':'utilisationRaw','team utilisation %':'utilisationRaw',
      'current utilization %':'utilisationRaw','current utilisation %':'utilisationRaw',
      'current utilization':'utilisationRaw','utilisation':'utilisationRaw','utilization':'utilisationRaw',
      'notes':'notes','description':'notes',
      'project scope':'scope','scope':'scope',
      'risks/challenges':'risks','risks & challenges':'risks','risks':'risks','issues':'risks'
    });

    function detectDelimiter(h){
      const c={',':(h.match(/,/g)||[]).length,';':(h.match(/;/g)||[]).length,'\t':(h.match(/\t/g)||[]).length};
      const e=Object.entries(c).sort((a,b)=>b[1]-a[1]);
      return e[0][1]>0?e[0][0]:',';
    }

    function parseCsv(text){
      if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
      const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
      if(!lines.length) return [];
      const delim=detectDelimiter(lines[0]);
      const parseLine=l=>{
        const res=[]; let cur=''; let q=false;
        for(let i=0;i<l.length;i++){
          const ch=l[i];
          if(ch==='"'){
            if(q && l[i+1]==='"'){cur+='"';i++;} else q=!q;
          }else if(ch===delim && !q){res.push(cur);cur='';}
          else cur+=ch;
        }
        res.push(cur);
        return res.map(v=>v.trim());
      };
      const rawHeader=parseLine(lines[0]);
      const header=rawHeader.map(h=>String(h||'').trim());
      const rows=[];
      for(let i=1;i<lines.length;i++){
        const cols=parseLine(lines[i]);
        if(!cols.length || !cols.some(c=>c.trim().length)) continue;
        const row={};
        header.forEach((h,idx)=>{row[h]=cols[idx]!==undefined?cols[idx]:'';});
        rows.push(row);
      }
      return rows;
    }

    function normaliseUtilisation(u){
      if(u==null||u==='') return '';
      let s=String(u).trim();
      if(!s) return '';
      if(s.endsWith('%')) s=s.slice(0,-1).trim();
      const n=parseFloat(s.replace(',', '.'));
      if(!isFinite(n)) return '';
      if(n>0&&n<=1) return Math.round(n*100)+'%';
      if(n>=0&&n<=100) return Math.round(n)+'%';
      return '';
    }

    function splitNamesToArray(v){
      if(!v) return [];
      return String(v).split(/[;,]/).map(s=>s.trim()).filter(Boolean);
    }
    function normaliseNamesString(v){
      const a=splitNamesToArray(v);
      return Array.from(new Set(a)).join(', ');
    }

    function explodeMultiNames(values){
      const set=new Set();
      (values||[]).forEach(v=>{
        if(!v) return;
        String(v).split(/[;,]/).forEach(p=>{
          p=p.trim(); if(p) set.add(p);
        });
      });
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    function normalizeRow(row){
      const lowerKeys=Object.keys(row).reduce((acc,k)=>{acc[k.toLowerCase()]=k;return acc;},{});
      const get=(logical,fallback=[])=>{
        const srcKey=Object.entries(headerMap)
          .filter(([k,v])=>v===logical)
          .map(([k])=>lowerKeys[k])
          .find(Boolean);
        if(srcKey) return row[srcKey];
        for(const fk of fallback){if(row[fk]!=null && row[fk]!=='') return row[fk];}
        return '';
      };

      const rawName=get('name',['Project Name','Project']);
      const rawCapability=get('capability',['Capability']);
      const rawStatus=get('status',['Status']);
      const rawRag=get('rag',['RAG']);
      const rawStart=get('start',['Start_Date','Start Date']);
      const rawEnd=get('end',['End_Date','End Date']);
      const rawTerritory=get('territory',['Territory']);
      const rawClient=get('client',['Client']);
      const rawMultiTower=get('multiTower',['Multi Tower','Multi-Tower','MultiTower']);
      const rawResources=get('resources',['Team Resources','BA Resources','Resources']);
      const rawIndustry=get('industry',['Industry']);
      const rawLoS=get('LoS',['LoS','LoS ',' LoS']);
      const rawPartner=get('partner',[
        'Engagement Lead/Partner',
        'Engagement Lead / Partner',
        'Engagement Lead',
        'Partner',
        'Partner Name'
      ]);
      const rawUtil=get('utilisationRaw',[
        'Team Utilization %','Team Utilisation %',
        'Current Utilization %','Current Utilisation %',
        'Current Utilization','Utilisation','Utilization'
      ]);
      const rawNotes=get('notes',['Notes','Description']);
      const rawScope=get('scope',['Project Scope','Scope']);
      const rawRisks=get('risks',['Risks/Challenges','Risks','Issues']);

      const utilisationDisplay=normaliseUtilisation(rawUtil);
      const startDate=parseDate(rawStart);
      const endDate=parseDate(rawEnd);

      let durationMonths=null;
      if(startDate&&endDate&&endDate>=startDate){
        const days=(endDate-startDate)/86400000;
        durationMonths=days/30.44;
      }

      const capabilityNorm=normaliseNamesString(rawCapability);
      const resourcesNorm=normaliseNamesString(rawResources);
      const multiTowerNorm=normaliseNamesString(rawMultiTower);

      const industryNorm=normaliseNamesString(rawIndustry);
      const partnerNorm=normaliseNamesString(rawPartner);
      const territoryNorm=normaliseNamesString(rawTerritory);

      const statusNorm=(rawStatus||'').trim();
      const ragNorm=(rawRag||'').trim()||null;

      const LoSParts=splitNamesToArray(rawLoS).map(v=>v.trim()).filter(Boolean);
      const LoSDisplaySet=new Map();
      LoSParts.forEach(label=>{
        const key=label.toLowerCase();
        if(!LoSDisplaySet.has(key)) LoSDisplaySet.set(key,label);
      });
      const LoSDisplayArray=Array.from(LoSDisplaySet.values());
      const LoSDisplay=LoSDisplayArray.join(', ');
      const LoSCanonical=LoSDisplayArray.slice();
      const LoSCanonicalLower=LoSCanonical.map(v=>v.toLowerCase());

      return {
        name:(rawName||'').trim(),
        capability:capabilityNorm,
        status:statusNorm,
        rag:ragNorm,
        start:startDate,
        end:endDate,
        durationMonths,
        territory:territoryNorm || 'Unspecified',
        client:(rawClient||'').trim(),
        multiTower:multiTowerNorm,
        resources:resourcesNorm,
        industry:industryNorm || 'Unspecified',
        LoS:LoSCanonical,
        LoSLower:LoSCanonicalLower,
        LoSDisplay,
        partner:partnerNorm,
        utilisation:utilisationDisplay,
        notes:(rawNotes||'').trim(),
        scope:(rawScope||'').trim(),
        risks:(rawRisks||'').trim()
      };
    }

    function computeMetrics(rows){
      const total=rows.length;
      const normalizeStatus=v=>{
        const s=(v||'').toString().trim().toLowerCase();
        if(!s) return 'Unspecified';
        if(s==='on hold'||s==='on-hold') return 'On hold';
        if(s==='active') return 'Active';
        if(s==='closed') return 'Closed';
        return v.toString().trim();
      };
      const normalizeRag=v=>{
        const s=(v||'').toString().trim().toLowerCase();
        if(!s) return 'Unspecified';
        if(s==='green') return 'Green';
        if(s==='amber') return 'Amber';
        if(s==='red') return 'Red';
        return v.toString().trim();
      };

      const statusCounts=rows.reduce((a,r)=>{const k=normalizeStatus(r.status);a[k]=(a[k]||0)+1;return a;},{});
      const ragCounts=rows.reduce((a,r)=>{const k=normalizeRag(r.rag);a[k]=(a[k]||0)+1;return a;},{});
      const industryCounts=rows.reduce((a,r)=>{const k=(r.industry||'Unspecified');a[k]=(a[k]||0)+1;return a;},{});
      const territoryCounts=rows.reduce((a,r)=>{const k=(r.territory||'Unspecified');a[k]=(a[k]||0)+1;return a;},{});

      const LoSCounts=rows.reduce((a,r)=>{
        const arr=Array.isArray(r.LoSLower)?r.LoSLower:[];
        if(!arr.length){
          a['unspecified']=(a['unspecified']||0)+1;
        }else{
          arr.forEach(name=>{
            const k=(name || 'unspecified').toLowerCase();
            a[k]=(a[k]||0)+1;
          });
        }
        return a;
      },{});

      const LoSByTerritory = rows.reduce((acc, r) => {
        const terr = (r.territory || 'Unspecified').toString();
        if (!acc[terr]) acc[terr] = {};
        const terrMap = acc[terr];

        const arr = Array.isArray(r.LoSLower) ? r.LoSLower : [];
        if (!arr.length) {
          terrMap['unspecified'] = (terrMap['unspecified'] || 0) + 1;
        } else {
          arr.forEach(name => {
            const k = (name || 'unspecified').toLowerCase();
            terrMap[k] = (terrMap[k] || 0) + 1;
          });
        }
        return acc;
      }, {});

      const today=new Date();
      const upcoming30=new Date(today.getTime()+30*86400000);
      const upcoming=rows.filter(r=>r.end && r.end>=today && r.end<=upcoming30).length;

      const durations=rows
        .map(r=> (r.start&&r.end)?(r.end-r.start)/86400000:null)
        .filter(x=>x!=null && x>=0);
      const avgDuration=durations.length
        ? Math.round(durations.reduce((a,b)=>a+b,0)/durations.length)
        : 0;

      const clients=new Set(rows.map(r=>(r.client||'').trim()).filter(Boolean));
      const industriesCount=Object.keys(industryCounts).length;
      const atRisk=(ragCounts['Amber']||0)+(ragCounts['Red']||0);
      const multiTowerCount=rows.filter(r=>{
        const v=(r.multiTower||'').toString().trim().toLowerCase();
        return v && v!=='no' && v!=='n';
      }).length;
      const closed=statusCounts['Closed']||0;

      return {
        total,
        statusCounts,
        ragCounts,
        industryCounts,
        territoryCounts,
        LoSCounts,
        LoSByTerritory,
        upcoming,
        avgDuration,
        uniqueClients:clients.size,
        industries:industriesCount,
        atRisk,
        multiTowerCount,
        closed
      };
    }

    return {parseCsv,normalizeRow,computeMetrics,explodeMultiNames,fmtDate,escapeHtml,normalizeXlsxDateValue};
  })();

  const MultiSelect=(function(){
    const STORAGE_KEY='dashboard-filters-multi-v1';
    const KEYS=['status','rag','territory','industry','capability','multiTower','resources','utilisation','LoS'];

    function getState(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY);
        return raw?JSON.parse(raw):{};
      }catch{return {};}
    }
    function saveState(s){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(s||{}));}catch{}}

    function getValues(){
      const s=getState(),res={};
      KEYS.forEach(k=>{res[k]=Array.isArray(s[k])?s[k]:[];});
      return res;
    }
    function setValues(v){
      const s=getState();
      KEYS.forEach(k=>{s[k]=v[k]?Array.from(v[k]):[];});
      saveState(s);
    }

    function createOptions(id,options){
      const root=document.getElementById(id);
      if(!root) return;
      const menu=root.querySelector('.multiselect-menu');
      if(!menu) return;
      if(!options||!options.length){
        menu.innerHTML='<div class="multiselect-empty">No values available</div>';
        return;
      }
      const norm=options.map(o=>{
        if(typeof o==='string'){return {key:o.toLowerCase(),label:o};}
        return {key:String(o.key),label:String(o.label)};
      });
      const map=new Map();
      norm.forEach(o=>{if(!map.has(o.key)) map.set(o.key,o);});
      const unique=Array.from(map.values());
      if(!unique.length){
        menu.innerHTML='<div class="multiselect-empty">No values available</div>';
        return;
      }
      menu.innerHTML=unique.map(o=>`
        <label class="multiselect-option">
          <input type="checkbox" value="${DataService.escapeHtml(o.key)}" data-label="${DataService.escapeHtml(o.label)}">
          <span>${DataService.escapeHtml(o.label)}</span>
        </label>
      `).join('');
    }

    function applySelectionsToDom(){
      const state=getState();
      KEYS.forEach(k=>{
        const root=document.getElementById('filter'+k.charAt(0).toUpperCase()+k.slice(1));
        if(!root) return;
        const menu=root.querySelector('.multiselect-menu');
        const display=root.querySelector('.multiselect-display-items');
        const displayWrap=root.querySelector('.multiselect-display');
        if(!menu||!display||!displayWrap) return;
        const want=Array.isArray(state[k])?state[k]:[];
        const labels=[];
        Array.from(menu.querySelectorAll('input[type="checkbox"]')).forEach(input=>{
          const key=input.value,label=input.dataset.label;
          const checked=want.includes(key);
          input.checked=checked;
          if(checked && label) labels.push(label);
        });
        if(!want.length){
          display.innerHTML='<span class="placeholder">All</span>';
          displayWrap.setAttribute('aria-expanded','false');
        }else{
          const uni=Array.from(new Set(labels));
          const combined=uni.join('; ');
          display.innerHTML=`<span class="multiselect-pill">${DataService.escapeHtml(combined)}</span>`;
          displayWrap.setAttribute('aria-expanded','false');
        }
      });
    }

    function clearFilter(key){
      const s=getState();
      s[key]=[];
      saveState(s);
      applySelectionsToDom();
    }

    function attachHandlers(onChange){
      const docClickHandler = (e) => {
        KEYS.forEach(key => {
          const id='filter'+key.charAt(0).toUpperCase()+key.slice(1);
          const root=document.getElementById(id);
          if(!root) return;
          const menu=root.querySelector('.multiselect-menu');
          const display=root.querySelector('.multiselect-display');
          if(!menu || !display) return;
          if(!root.contains(e.target)){
            menu.dataset.open='false';
            display.setAttribute('aria-expanded','false');
          }
        });
      };
      document.addEventListener('click', docClickHandler);

      KEYS.forEach(key=>{
        const id='filter'+key.charAt(0).toUpperCase()+key.slice(1);
        const root=document.getElementById(id);
        if(!root) return;
        const display=root.querySelector('.multiselect-display');
        const menu=root.querySelector('.multiselect-menu');
        const clearBtn=root.querySelector('.multiselect-clear');
        const toggleMenu=open=>{
          if(!menu||!display) return;
          menu.dataset.open=open?'true':'false';
          display.setAttribute('aria-expanded',open?'true':'false');
        };
        if(display){
          display.addEventListener('click',()=>toggleMenu(menu.dataset.open!=='true'));
          display.addEventListener('keydown',e=>{
            if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleMenu(menu.dataset.open!=='true');}
            else if(e.key==='Escape'){toggleMenu(false);display.blur();}
          });
        }
        if(clearBtn){
          clearBtn.addEventListener('click',e=>{
            e.stopPropagation();
            clearFilter(key);
            if(typeof onChange==='function') onChange();
          });
        }
        if(menu){
          menu.addEventListener('change',()=>{
            const s=getState();
            const sel=Array.from(menu.querySelectorAll('input[type="checkbox"]'))
              .filter(i=>i.checked)
              .map(i=>i.value);
            s[key]=sel;
            saveState(s);
            applySelectionsToDom();
            if(typeof onChange==='function') onChange();
          });
        }
      });
    }

    return {KEYS,getValues,setValues,createOptions,applySelectionsToDom,clearFilter,attachHandlers};
  })();

  const Filters=(function(){
    const STORAGE_KEY_SIMPLE='dashboard-filters-simple-v1';

    function getElsSimple(){
      return {
        durationEl:document.getElementById('filterDuration'),
        searchEl:document.getElementById('filterSearch')
      };
    }

    function getValues(){
      const {durationEl,searchEl}=getElsSimple();
      const multi=MultiSelect.getValues();
      const trimVal=v=>(typeof v==='string'?v.trim():v);
      return {
        status:(multi.status||[]).map(trimVal),
        rag:(multi.rag||[]).map(trimVal),
        territory:(multi.territory||[]).map(trimVal),
        industry:(multi.industry||[]).map(trimVal),
        resources:(multi.resources||[]).map(trimVal),
        utilisation:(multi.utilisation||[]).map(trimVal),
        capability:(multi.capability||[]).map(trimVal),
        multiTower:(multi.multiTower||[]).map(trimVal),
        LoS:(multi.LoS||[]).map(trimVal),
        duration:trimVal(durationEl?.value||''),
        search:trimVal(searchEl?.value||'').toLowerCase()
      };
    }

    function applyToInputs(values){
      const {durationEl,searchEl}=getElsSimple();
      if(!values) return;
      if(durationEl) durationEl.value=values.duration||'';
      if(searchEl)  searchEl.value=values.search||'';
      const multi={};
      MultiSelect.KEYS.forEach(k=>{multi[k]=Array.isArray(values[k])?values[k]:[];});
      MultiSelect.setValues(multi);
      MultiSelect.applySelectionsToDom();
    }

    function clear(){
      const {durationEl,searchEl}=getElsSimple();
      if(durationEl) durationEl.value='';
      if(searchEl)  searchEl.value='';
      const cleared={};
      MultiSelect.KEYS.forEach(k=>{cleared[k]=[];});
      MultiSelect.setValues(cleared);
      MultiSelect.applySelectionsToDom();
      save();
    }

    function save(){
      try{
        const {durationEl,searchEl}=getElsSimple();
        const s={duration:durationEl?.value||'',search:searchEl?.value||''};
        localStorage.setItem(STORAGE_KEY_SIMPLE,JSON.stringify(s));
      }catch{}
    }

    function renderChips(){
      const container=document.getElementById('activeFilters');
      const summaryBadge=document.getElementById('filtersSummary');
      if(!container||!summaryBadge) return;
      const v=getValues();
      const chips=[];
      if(v.status&&v.status.length)      chips.push({key:'status',label:'Status',value:v.status.join(', ')});
      if(v.rag&&v.rag.length)            chips.push({key:'rag',label:'RAG',value:v.rag.join(', ')});
      if(v.territory&&v.territory.length)chips.push({key:'territory',label:'Territory',value:v.territory.join(', ')});
      if(v.industry&&v.industry.length)  chips.push({key:'industry',label:'Industry',value:v.industry.join(', ')});
      if(v.resources&&v.resources.length)chips.push({key:'resources',label:'Team resources',value:v.resources.join(', ')});
      if(v.utilisation&&v.utilisation.length) chips.push({key:'utilisation',label:'Team utilisation %',value:v.utilisation.join(', ')});
      if(v.capability&&v.capability.length) chips.push({key:'capability',label:'Capability',value:v.capability.join(', ')});
      if(v.multiTower&&v.multiTower.length) chips.push({key:'multiTower',label:'Multi‑tower',value:v.multiTower.join(', ')});
      if(v.LoS&&v.LoS.length)            chips.push({key:'LoS',label:'LoS',value:v.LoS.join(', ')});
      if(v.duration)                     chips.push({key:'duration',label:'Duration',value:v.duration});
      if(v.search)                       chips.push({key:'search',label:'Search',value:v.search});

      const root=document.documentElement;
      if(!chips.length){
        container.innerHTML='<span>No filters applied.</span>';
        summaryBadge.textContent='No filters applied';
        root.classList.remove('filters-active');
        return;
      }
      const summaryText=`${chips.length} filter${chips.length===1?'':'s'}${v.search?' + search':''} applied`;
      summaryBadge.textContent=summaryText;
      container.innerHTML=`
        <span>${summaryText}</span>
        ${chips.map(ch=>`
          <span class="filter-chip" data-filter-key="${ch.key}">
            <span class="filter-chip-label">${DataService.escapeHtml(ch.label)}:</span>
            <span>${DataService.escapeHtml(ch.value)}</span>
            <button class="filter-chip-clear" type="button" aria-label="Clear ${DataService.escapeHtml(ch.label)} filter">×</button>
          </span>
        `).join('')}
        <button class="filter-chip-clear-all" type="button" aria-label="Clear all filters">Clear all</button>
      `;
      root.classList.add('filters-active');
    }

    function attachChipHandlers(onChange){
      const container=document.getElementById('activeFilters');
      if(!container) return;
      container.addEventListener('click',e=>{
        const clearAllBtn=e.target.closest && e.target.closest('.filter-chip-clear-all');
        if(clearAllBtn){
          clear();
          if(typeof onChange==='function') onChange();
          return;
        }
        const btn=e.target.closest && e.target.closest('.filter-chip-clear');
        if(!btn) return;
        const chip=btn.closest('.filter-chip');
        if(!chip) return;
        const key=chip.getAttribute('data-filter-key');
        if(!key) return;
        const {durationEl,searchEl}=getElsSimple();
        if(key==='duration'&&durationEl) durationEl.value='';
        if(key==='search'&&searchEl)     searchEl.value='';
        if(MultiSelect.KEYS.includes(key)) MultiSelect.clearFilter(key);
        save();
        if(typeof onChange==='function') onChange();
      });
    }

    return {getValues,applyToInputs,clear,save,renderChips,attachChipHandlers};
  })();

  const Charts=(function(){
    let statusChart=null, territoryChart=null, ragChart=null, industryChart=null;

    function ensureChartAvailable(){return typeof Chart!=='undefined';}
    function hasDatalabels(){return !!(window.Chart && window.ChartDataLabels);}

    function buildStatusChart(rowsForDuration){
      if(!ensureChartAvailable()) return;
      const ctx=document.getElementById('statusChart');
      const empty=document.getElementById('statusEmpty');
      const subtitle=document.getElementById('durationSubtitle');
      if(!ctx) return;

      const labels=['0 – 6 months','6 – 12 months','More than 1 year'];
      const counts={'0-6':0,'6-12':0,'12+':0};
      let validDurationProjects=0;

      (rowsForDuration||[]).forEach(r=>{
        if(r.durationMonths==null||r.durationMonths<0) return;
        validDurationProjects++;
        const m=r.durationMonths;
        if(m>=0&&m<=6) counts['0-6']++;
        else if(m>6&&m<=12) counts['6-12']++;
        else if(m>12) counts['12+']++;
      });

      const data=[counts['0-6'],counts['6-12'],counts['12+']];
      const hasData=data.some(v=>v>0);

      if(subtitle){
        subtitle.textContent = validDurationProjects
          ? `Projects with valid dates: ${validDurationProjects.toLocaleString()}.`
          : 'No valid start/end date pairs in this view.';
      }

      if(empty) empty.style.display=hasData?'none':'flex';
      if(!hasData){
        if(statusChart) statusChart.destroy();
        statusChart=null;
        return;
      }
      const colors=getChartColors();
      const dataset={
        data,
        backgroundColor:[colors.accent,'#9ca3af',colors.hold],
        borderWidth:0,
        borderRadius:22,
        maxBarThickness:60,
        barThickness:46
      };
      const options={
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{
            enabled:true,
            callbacks:{
              label:c=>{
                const count=c.parsed.y||0;
                return `${c.label}: ${count} project${count===1?'':'s'}`;
              }
            }
          },
          datalabels: hasDatalabels()?{
            anchor:'end',align:'end',offset:4,color:colors.label,
            font:{size:12,weight:'600'},
            formatter:v=>v?`${v}`:''
          }:undefined
        },
        scales:{
          x:{grid:{display:false},ticks:{color:colors.label,font:{size:11}}},
          y:{
            beginAtZero:true,
            ticks:{color:colors.label,font:{size:11}},
            grid:{color:colors.grid},
            title:{display:true,text:'Number of projects',color:colors.label,font:{size:11}}
          }
        },
        onClick:(evt,els)=>{
          if(!els||!els.length) return;
          const idx=els[0].index;
          const label=labels[idx];
          const durationEl=document.getElementById('filterDuration');
          if(!durationEl) return;
          if(label==='0 – 6 months') durationEl.value='0-6';
          else if(label==='6 – 12 months') durationEl.value='6-12';
          else if(label==='More than 1 year') durationEl.value='12+';
          Filters.save();
          Dashboard.App.applyFiltersAndRender();
        }
      };
      if(statusChart){
        statusChart.data.labels=labels;
        statusChart.data.datasets[0]=dataset;
        statusChart.options=options;
        statusChart.update();
      }else{
        statusChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[dataset]},options});
      }
    }

    function buildTerritoryChart(territoryCounts,onClickFilter){
      if(!ensureChartAvailable()) return;
      const ctx=document.getElementById('territoryChart');
      const empty=document.getElementById('territoryEmpty');
      if(!ctx) return;
      const entries=Object.entries(territoryCounts).sort((a,b)=>b[1]-a[1]);
      const labels=entries.map(([k])=>k||'Unspecified');
      const data=entries.map(([,v])=>v);
      const total=data.reduce((a,b)=>a+b,0);
      if(empty) empty.style.display=total?'none':'flex';
      if(!total){
        if(territoryChart) territoryChart.destroy();
        territoryChart=null;
        return;
      }
      const colors=getChartColors();
      const palette = [
        colors.accent,
        '#10b981',
        '#3b82f6',
        '#f97316',
        '#6366f1',
        '#22c55e',
        '#ec4899',
        '#0ea5e9'
      ];
      const barColors=data.map((_,i)=>palette[i % palette.length]);
      const dataset={
        data,
        backgroundColor:barColors,
        borderWidth:0,
        borderRadius:12,
        barThickness:20,
        maxBarThickness:26
      };
      const options={
        indexAxis:'y',
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{
            enabled:true,
            callbacks:{
              title:items=>items[0]?.label||'',
              label:c=>{
                const v=c.parsed.x||0;
                const pct=total?(v/total*100):0;
                return `${v.toLocaleString()} project${v===1?'':'s'} (${pct.toFixed(1)}%)`;
              }
            }
          },
          datalabels: hasDatalabels()?{
            anchor:'end',align:'right',clamp:true,clip:true,
            color:colors.label,font:{size:11,weight:'600'},
            formatter:v=>v?v.toLocaleString():''
          }:undefined
        },
        scales:{
          x:{ticks:{color:colors.label,font:{size:11}},grid:{color:colors.grid}},
          y:{ticks:{color:colors.label,font:{size:11}},grid:{display:false}}
        },
        onClick:(evt,els)=>{
          if(!els||!els.length||!onClickFilter) return;
          const idx=els[0].index;
          const label=labels[idx] || 'Unspecified';
          const key = label.toLowerCase();
          onClickFilter('territory', key);
        }
      };
      if(territoryChart){
        territoryChart.data.labels=labels;
        territoryChart.data.datasets[0]=dataset;
        territoryChart.options=options;
        territoryChart.update();
      }else{
        territoryChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[dataset]},options});
      }
    }

    function buildIndustryChart(industryCounts, onClickFilter) {
      if (!ensureChartAvailable()) return;
      const ctx   = document.getElementById('industryChart');
      const empty = document.getElementById('industryEmpty');
      const subtitle = document.getElementById('industrySubtitle');
      if (!ctx) return;

      const entries = Object.entries(industryCounts || {}).sort((a,b)=>b[1]-a[1]);
      const labels  = entries.map(([k]) => k || 'Unspecified');
      const data    = entries.map(([,v]) => v);
      const total   = data.reduce((a,b)=>a+b,0);

      if (subtitle) {
        subtitle.textContent = total
          ? `Projects by industry (${labels.length.toString()} industries; total ${total.toLocaleString()} project${total===1?'':'s'}).`
          : 'No industry information available in this view.';
      }

      if (empty) empty.style.display = total ? 'none' : 'flex';
      if (!total) {
        if (industryChart) industryChart.destroy();
        industryChart = null;
        return;
      }

      const perBar = 22;
      const minHeight = 220;
      const calcHeight = Math.max(minHeight, labels.length * perBar);
      const inner = document.querySelector('.industry-chart-inner');
      if (inner) {
        inner.style.height = calcHeight + 'px';
      }

      const colors = getChartColors();
      const palette = [
        colors.accent,
        '#10b981',
        '#3b82f6',
        '#f97316',
        '#6366f1',
        '#22c55e',
        '#ec4899',
        '#0ea5e9'
      ];
      const barColors = data.map((_,i)=>palette[i % palette.length]);

      const dataset = {
        data,
        backgroundColor: barColors,
        borderWidth: 0,
        borderRadius: 10,
        barThickness: 18,
        maxBarThickness: 22
      };

      const options = {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              title: items => items[0]?.label || '',
              label: c => {
                const v   = c.parsed.x || 0;
                const pct = total ? (v/total*100) : 0;
                return `${v.toLocaleString()} project${v===1?'':'s'} (${pct.toFixed(1)}%)`;
              }
            }
          },
          datalabels: hasDatalabels() ? {
            anchor: 'end',
            align: 'right',
            clamp: true,
            clip: true,
            color: colors.label,
            font: { size: 10, weight: '600' },
            formatter: v => v ? v.toLocaleString() : ''
          } : undefined
        },
        scales: {
          x: {
            ticks: { color: colors.label, font: { size: 10 } },
            grid:  { color: colors.grid }
          },
          y: {
            ticks: { color: colors.label, font: { size: 10 } },
            grid:  { display: false }
          }
        },
        onClick: (evt, els) => {
          if (!els || !els.length || !onClickFilter) return;
          const idx   = els[0].index;
          const label = labels[idx];
          onClickFilter('industry', label);
        }
      };

      if (industryChart) {
        industryChart.data.labels       = labels;
        industryChart.data.datasets[0]  = dataset;
        industryChart.options           = options;
        industryChart.update();
      } else {
        industryChart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [dataset] },
          options
        });
      }
    }

    function buildRagDonut(ragCounts,onClickFilter){
      if(!ensureChartAvailable()) return;
      const ctx=document.getElementById('ragDonut');
      const center=document.getElementById('ragDonutCenter');
      const numberEl=document.getElementById('ragDonutNumber');
      const empty=document.getElementById('ragEmpty');
      const subtitle=document.getElementById('ragSubtitle');
      const caption=document.getElementById('ragDonutCaption');
      if(!ctx||!center) return;

      const labels=['Green','Amber','Red'];
      const data=labels.map(l=>ragCounts[l]||0);

      const colors=getChartColors();
      const ringColors=[colors.green,colors.amber,colors.red];

      const totalDefined=data.reduce((a,b)=>a+b,0);
      const totalUnspecified = ragCounts['Unspecified'] || 0;

      if (numberEl) {
        numberEl.textContent = totalDefined ? totalDefined.toLocaleString() : '–';
      }

      if(caption){
        if(totalUnspecified>0){
          caption.textContent = `${totalDefined.toLocaleString()} with RAG set · ${totalUnspecified.toLocaleString()} unspecified`;
        }else{
          caption.textContent = 'Number of projects with a RAG rating';
        }
      }

      if(subtitle){
        subtitle.textContent = totalDefined
          ? 'Risk split across projects with a defined RAG rating (Green / Amber / Red).'
          : 'No RAG information available in the current view.';
      }

      if(empty) empty.style.display=totalDefined?'none':'flex';
      if(!totalDefined){
        if(ragChart) ragChart.destroy();
        ragChart=null;
        return;
      }

      const options={
        plugins:{
          legend:{display:false},
          tooltip:{
            enabled:true,
            callbacks:{
              label:c=>{
                const v=c.parsed||0;
                const ds=c.chart.data.datasets[c.datasetIndex];
                const tot=ds.data.reduce((a,b)=>a+(b||0),0);
                const pct=tot?(v/tot*100):0;
                return `${c.label}: ${v.toLocaleString()} project${v===1?'':'s'} (${pct.toFixed(1)}%)`;
              }
            }
          },
          datalabels:{display:false}
        },
        maintainAspectRatio:false,
        onClick:(evt,els)=>{
          if(!els||!els.length||!onClickFilter) return;
          const idx=els[0].index;
          const label=labels[idx];
          onClickFilter('rag', label);
        }
      };
      const dataset={
        data,
        backgroundColor:ringColors,
        borderWidth:0,
        cutout:'65%'
      };
      if(ragChart){
        ragChart.data.labels=labels;
        ragChart.data.datasets[0]=dataset;
        ragChart.options=options;
        ragChart.update();
      }else{
        ragChart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[dataset]},options});
      }
    }

    function buildLoSByTerritoryCharts(LoSCounts, LoSByTerritory, onClickFilter){
      if(!ensureChartAvailable()) return;

      const configs = [
        { terrCode: 'DE', label: 'Germany (DE)', canvasId: 'LoSChartDE', emptyId: 'LoSEmptyDE', subtitleId: 'losSubtitleDE' },
        { terrCode: 'UK', label: 'United Kingdom (UK)', canvasId: 'LoSChartUK', emptyId: 'LoSEmptyUK', subtitleId: 'losSubtitleUK' },
        { terrCode: 'ME', label: 'Middle East (ME)', canvasId: 'LoSChartME', emptyId: 'LoSEmptyME', subtitleId: 'losSubtitleME' }
      ];

      const colors = getChartColors();
      const palette = [
        colors.accent,
        '#2563eb',
        '#10b981',
        '#f97316',
        '#a855f7',
        '#ec4899',
        '#0ea5e9',
        '#22c55e'
      ];

      configs.forEach(cfg => {
        const ctx = document.getElementById(cfg.canvasId);
        const empty = document.getElementById(cfg.emptyId);
        const subtitleEl = document.getElementById(cfg.subtitleId);
        if(!ctx) return;

        const terrMap = (LoSByTerritory && LoSByTerritory[cfg.terrCode]) || {};
        const labelsRaw = Object.keys(terrMap || {}).filter(k => k);
        const labels = labelsRaw.sort((a,b)=>a.localeCompare(b));
        const data = labels.map(k => terrMap[k] || 0);
        const total = data.reduce((a,b)=>a+b,0);

        if(subtitleEl){
          subtitleEl.textContent = total
            ? `LoS split for ${total.toLocaleString()} project${total === 1 ? '' : 's'} in ${cfg.label}.`
            : `No projects with LoS tagged in ${cfg.label} in this view.`;
        }

        if(empty) empty.style.display = total ? 'none' : 'flex';

        let chartInstance = ctx._losChartInstance;

        if(!total){
          if(chartInstance){
            chartInstance.destroy();
            ctx._losChartInstance = null;
          }
          return;
        }

        const barColors = data.map((_,i)=>palette[i % palette.length]);
        const dataset = {
          data,
          backgroundColor: barColors,
          borderWidth: 0,
          borderRadius: 10,
          barThickness: 14,
          maxBarThickness: 18
        };

        const options = {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                title: items => `${items[0]?.label || ''} – ${cfg.label}`,
                label: c => {
                  const v = c.parsed.x || 0;
                  const pct = total ? (v/total*100) : 0;
                  return `${v.toLocaleString()} project${v===1?'':'s'} (${pct.toFixed(1)}%)`;
                }
              }
            },
            datalabels: hasDatalabels() ? {
              anchor: 'end',
              align: 'right',
              clamp: true,
              clip: true,
              color: colors.label,
              font: { size: 11, weight: '600' },
              formatter: v => v ? `${v.toLocaleString()}` : ''
            } : undefined
          },
          scales: {
            x: { ticks: { color: colors.label,font:{size:11} }, grid: { color: colors.grid } },
            y: { ticks: { color: colors.label,font:{size:11} }, grid: { display: false } }
          },
          onClick: (evt, els) => {
            if(!els || !els.length || !onClickFilter) return;
            const idx = els[0].index;
            const keyRaw = labels[idx] || '';
            const losKey = keyRaw.toLowerCase();
            onClickFilter('LoS', losKey);
          }
        };

        const displayLabels = labels.map(k =>
          k === 'unspecified' ? 'UNSPECIFIED' : k.toUpperCase()
        );

        if(chartInstance){
          chartInstance.data.labels = displayLabels;
          chartInstance.data.datasets[0] = dataset;
          chartInstance.options = options;
          chartInstance.update();
        }else{
          chartInstance = new Chart(ctx,{
            type: 'bar',
            data: {
              labels: displayLabels,
              datasets: [dataset]
            },
            options
          });
          ctx._losChartInstance = chartInstance;
        }
      });
    }

    function exportChartPng(id){
      const canvas=document.getElementById(id);
      if(!canvas){Message.show('Chart not found for export.','error');return;}
      try{
        const link=document.createElement('a');
        link.href=canvas.toDataURL('image/png');
        const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        link.download=id+'_'+ts+'.png';
        link.click();
      }catch(e){
        Message.show('Unable to export chart as PNG in this browser.','error',5000);
      }
    }

    function rebuildAll(m,onClickFilter,rows){
      buildStatusChart(rows);
      buildTerritoryChart(m.territoryCounts,onClickFilter);
      buildIndustryChart(m.industryCounts,onClickFilter);
      buildRagDonut(m.ragCounts,onClickFilter);
      buildLoSByTerritoryCharts(m.LoSCounts, m.LoSByTerritory, onClickFilter);
    }

    return {rebuildAll,exportChartPng};
  })();

  const UI=(function(){
    let allRows=[], filteredRows=[];
    let sortKey='name', sortDir='asc', compact=false;

    const KPI_CONFIG=[
      {id:'kpiTotal',valueKey:'total'},
      {id:'kpiAtRisk',valueKey:'atRisk'},
      {id:'kpiUpcoming',valueKey:'upcoming'},
      {id:'kpiClosed',valueKey:'closed'}
    ];

    function setData(rows){allRows=rows||[]; filteredRows=[...allRows]; updateGettingStartedVisibility();}
    function getAllRows(){return allRows;}
    function getFilteredRows(){return filteredRows;}
    function setFilteredRows(r){filteredRows=r||[];}

    function getSort(){return {sortKey,sortDir};}
    function setSort(k,d){
      sortKey=k; sortDir=d;
      try{localStorage.setItem('dashboard-sort-v1',JSON.stringify({sortKey,sortDir}));}catch{}
    }
    function initSortFromStorage(){
      try{
        const raw=localStorage.getItem('dashboard-sort-v1');
        if(!raw) return;
        const o=JSON.parse(raw);
        if(o&&o.sortKey){sortKey=o.sortKey;sortDir=o.sortDir==='desc'?'desc':'asc';}
      }catch{}
    }

    function updateKpis(m){
      KPI_CONFIG.forEach(({id,valueKey})=>{
        const el=document.getElementById(id); if(!el) return;
        const v=m[valueKey];
        el.textContent=(v||v===0)?v.toLocaleString():'–';
      });
      const multi=document.getElementById('kpiMultiTower');
      if(multi){
        if(m.total&&m.total>0){
          const pct=(m.multiTowerCount/m.total)*100;
          multi.textContent=pct.toFixed(0)+'%';
        }else multi.textContent='–';
      }
      const summary=document.getElementById('metricsSummary');
      if(summary){
        summary.textContent=m.total
          ? `${m.total.toLocaleString()} project${m.total===1?'':'s'} in view across ${m.industries.toLocaleString()} industr${m.industries===1?'y':'ies'} and ${m.uniqueClients.toLocaleString()} client${m.uniqueClients===1?'':'s'}.`
          : 'No projects in view. Upload data from a CSV or Excel file to get started.';
      }
    }

    function updatePortfolioChips(m){
      const pc=document.getElementById('portfolioProjectsChip');
      const ic=document.getElementById('portfolioIndustriesChip');
      if(pc) pc.textContent=m.total?`${m.total.toLocaleString()} project${m.total===1?'':'s'} in view`:'0 projects in view';
      if(ic) ic.textContent=`${m.industries.toLocaleString()} industr${m.industries===1?'y':'ies'}`;
    }

    function populateFilterOptions(rows){
      const norm = v => (v == null ? '' : String(v).trim());
      const normLower = v => norm(v).toLowerCase();

      const territoriesSet = new Map();
      const industriesSet  = new Map();

      rows.forEach(r => {
        const tLabel = norm(r.territory) || 'Unspecified';
        const tKey   = tLabel.toLowerCase();
        if (tKey && !territoriesSet.has(tKey)) {
          territoriesSet.set(tKey, tLabel);
        }

        const iLabel = norm(r.industry) || 'Unspecified';
        const iKey   = iLabel.toLowerCase();
        if (iKey && !industriesSet.has(iKey)) {
          industriesSet.set(iKey, iLabel);
        }
      });

      const territories = Array.from(territoriesSet.entries())
        .sort((a,b) => a[1].localeCompare(b[1]))
        .map(([key,label]) => ({ key, label }));

      const industries = Array.from(industriesSet.entries())
        .sort((a,b) => a[1].localeCompare(b[1]))
        .map(([key,label]) => ({ key, label }));

      const resourcesRaw    = rows.map(r => r.resources).filter(Boolean);
      const capabilitiesRaw = rows.map(r => r.capability).filter(Boolean);
      const resources       = DataService.explodeMultiNames(resourcesRaw);
      const capabilities    = DataService.explodeMultiNames(capabilitiesRaw);

      const utilisations = Array.from(new Set(
        rows.map(r => norm(r.utilisation)).filter(Boolean).map(normLower)
      )).sort().map(key => ({ key, label: key.toUpperCase() }));

      const multiTowers = Array.from(new Set(
        rows.map(r => norm(r.multiTower)).filter(Boolean).map(normLower)
      )).sort().map(key => ({ key, label: key.toUpperCase() }));

      const statuses = Array.from(new Set(
        rows.map(r => norm(r.status)).filter(Boolean).map(normLower)
      )).sort().map(key => ({ key, label: key.toUpperCase() }));

      const rags = Array.from(new Set(
        rows.map(r => norm(r.rag)).filter(Boolean).map(normLower)
      )).sort().map(key => ({
        key,
        label: key.charAt(0).toUpperCase() + key.slice(1)
      }));

      const LoSMap = new Map();
      rows.forEach(r => {
        if (Array.isArray(r.LoS)) {
          r.LoS.forEach(label => {
            const display = norm(label);
            if (!display) return;
            const k = display.toLowerCase();
            if (!LoSMap.has(k)) LoSMap.set(k, display);
          });
        }
      });
      const LoSValues = Array.from(LoSMap.entries())
        .sort((a,b) => a[1].localeCompare(b[1]))
        .map(([key,label]) => ({ key, label }));

      MultiSelect.createOptions('filterStatus',
        statuses.length ? statuses : [
          { key:'active',   label:'Active' },
          { key:'on hold',  label:'On hold' },
          { key:'closed',   label:'Closed' }
        ]
      );
      MultiSelect.createOptions('filterRag',
        rags.length ? rags : [
          { key:'green', label:'Green' },
          { key:'amber', label:'Amber' },
          { key:'red',   label:'Red' }
        ]
      );

      MultiSelect.createOptions('filterTerritory', territories);
      MultiSelect.createOptions('filterIndustry', industries);

      MultiSelect.createOptions('filterCapability',
        capabilities.map(label => ({ key: label.toLowerCase(), label }))
      );
      MultiSelect.createOptions('filterMultiTower', multiTowers);
      MultiSelect.createOptions('filterResources',
        resources.map(label => ({ key: label.toLowerCase(), label }))
      );
      MultiSelect.createOptions('filterUtilisation', utilisations);
      MultiSelect.createOptions('filterLoS', LoSValues);

      MultiSelect.applySelectionsToDom();
    }

    function renderTable(){
      const tbody=document.querySelector('#projectsTable tbody');
      if(!tbody) return;
      const rows=filteredRows;
      if(!rows.length){
        tbody.innerHTML=`
          <tr>
            <td colspan="17" style="text-align:center; padding:16px; color:var(--muted); font-size:11px;">
              No projects to display. Upload a CSV or Excel dataset from a file, or adjust your filters.
            </td>
          </tr>`;
      }else{
        tbody.innerHTML=rows.map(r=>{
          const sc=statusColor(r.status);
          const rc=ragColor(r.rag);
          const ragLabel=r.rag||'Unspecified';
          const statusLabel=r.status||'Unspecified';
          return `
            <tr>
              <td class="col-name">${DataService.escapeHtml(r.name)}</td>
              <td class="col-capability">${DataService.escapeHtml(r.capability||'')}</td>
              <td class="col-status">
                <span class="status-pill" style="color:${sc}">
                  <span class="status-dot" style="background:${sc}"></span>${DataService.escapeHtml(statusLabel)}
                </span>
              </td>
              <td class="col-rag">
                <span class="rag-pill" style="color:${rc}">
                  <span class="rag-dot" style="background:${rc}"></span>${DataService.escapeHtml(ragLabel)}
                </span>
              </td>
              <td class="col-date">${DataService.fmtDate(r.start)}</td>
              <td class="col-date">${DataService.fmtDate(r.end)}</td>
              <td class="col-short">${
                r.durationMonths != null ? r.durationMonths.toFixed(1) : ''
              }</td>
              <td class="col-territory">${DataService.escapeHtml(r.territory||'')}</td>
              <td class="col-client">${DataService.escapeHtml(r.client||'')}</td>
              <td class="col-short">${DataService.escapeHtml(r.multiTower||'')}</td>
              <td class="col-short">${DataService.escapeHtml(r.resources||'')}</td>
              <td class="col-capability">${DataService.escapeHtml(r.industry||'')}</td>
              <td class="col-short los-col">${DataService.escapeHtml(r.LoSDisplay||'')}</td>
              <td class="col-short">${DataService.escapeHtml(r.partner||'')}</td>
              <td class="col-short">${DataService.escapeHtml(r.utilisation||'')}</td>
              <td class="col-notes">${DataService.escapeHtml(r.scope||'')}</td>
              <td class="col-notes">${DataService.escapeHtml(r.risks||'')}</td>
            </tr>`;
        }).join('');
      }
      const totalFiltered=rows.length;
      const totalAll=allRows.length;
      const projectsCountEl=document.getElementById('projectsCount');
      const tableInfoEl=document.getElementById('tableInfo');
      if(projectsCountEl) projectsCountEl.textContent=`${totalFiltered.toLocaleString()} project${totalFiltered===1?'':'s'}`;
      if(tableInfoEl){
        if(!totalAll) tableInfoEl.textContent='No projects loaded yet.';
        else if(!totalFiltered) tableInfoEl.textContent=`No projects match the current filters (out of ${totalAll.toLocaleString()} total).`;
        else tableInfoEl.textContent=`Showing ${totalFiltered.toLocaleString()} of ${totalAll.toLocaleString()} projects`;
      }
    }

    function updateSortIndicators(){
      const {sortKey:sk,sortDir:sd}=getSort();
      document.querySelectorAll('#projectsTable thead th').forEach(th=>{
        const key=th.getAttribute('data-key');
        const indicator=th.querySelector('.sort-indicator');
        if(!indicator) return;
        if(key===sk){
          indicator.textContent=sd==='asc'?'▲':'▼';
          th.setAttribute('aria-sort',sd==='asc'?'ascending':'descending');
        }else{
          indicator.textContent='';
          th.setAttribute('aria-sort','none');
        }
      });
    }

    function exportCsv(){
      const rows=filteredRows;
      if(!rows.length){Message.show('No projects in the current view to export.','info');return;}
      const headers=[
        'Project Name','Capability','Status','RAG','Start_Date','End_Date',
        'Duration_Months',
        'Territory','Client','Multi Tower','Team Resources','Industry','LoS',
        'Engagement Lead/Partner','Team Utilization %','Project Scope','Risks/Challenges'
      ];
      const records=rows.map(r=>({
        'Project Name':r.name,
        'Capability':r.capability||'',
        'Status':r.status,
        'RAG':r.rag||'',
        'Start_Date':r.start?DataService.fmtDate(r.start):'',
        'End_Date':r.end?DataService.fmtDate(r.end):'',
        'Duration_Months':r.durationMonths!=null ? r.durationMonths.toFixed(1) : '',
        'Territory':r.territory||'',
        'Client':r.client||'',
        'Multi Tower':r.multiTower||'',
        'Team Resources':r.resources||'',
        'Industry':r.industry||'',
        'LoS':r.LoSDisplay||'',
        'Engagement Lead/Partner':r.partner||'',
        'Team Utilization %':r.utilisation||'',
        'Project Scope':r.scope||'',
        'Risks/Challenges':r.risks||''
      }));
      const escapeField=v=>{
        const s=String(v ?? '');
        if(/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
        return s;
      };
      const csv=[headers.join(',')];
      records.forEach(row=>{
        csv.push(headers.map(h=>escapeField(row[h])).join(','));
      });
      const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download=`portfolio_export_${ts}.csv`;
      a.href=url;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      Message.show('CSV exported for current view.','success',3000);
    }

    function toggleDensity(){
      const btn=document.getElementById('toggleDensity');
      const table=document.getElementById('projectsTable');
      if(!btn||!table) return;
      compact=!compact;
      btn.setAttribute('aria-pressed',compact?'true':'false');
      btn.textContent=compact?'Comfortable view':'Compact view';
      table.classList.toggle('compact',compact);
      try{localStorage.setItem('dashboard-density-v1',compact?'compact':'comfortable');}catch{}
    }
    function initDensityFromStorage(){
      try{
        const mode=localStorage.getItem('dashboard-density-v1');
        const btn=document.getElementById('toggleDensity');
        const table=document.getElementById('projectsTable');
        if(!mode||!btn||!table) return;
        compact=mode==='compact';
        btn.setAttribute('aria-pressed',compact?'true':'false');
        btn.textContent=compact?'Comfortable view':'Compact view';
        table.classList.toggle('compact',compact);
      }catch{}
    }

    function updateGettingStartedVisibility(){
      const panel=document.getElementById('gettingStarted');
      if(!panel) return;
      const hasData = allRows.length > 0;
      panel.classList.toggle('is-hidden',hasData);
      panel.setAttribute('aria-hidden',hasData?'true':'false');
    }

    return {
      setData,getAllRows,getFilteredRows,setFilteredRows,
      getSort,setSort,initSortFromStorage,
      updateKpis,updatePortfolioChips,
      populateFilterOptions,renderTable,updateSortIndicators,
      exportCsv,toggleDensity,initDensityFromStorage,
      updateGettingStartedVisibility
    };
  })();

  const App=(function(){
    let applyFiltersAndRenderFn=null;

    function applyStoredTheme(){
      let stored=null;
      try{stored=localStorage.getItem('dashboard-theme');}catch{}
      const mm = (function(){try{return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');}catch{return null;}})();
      const theme=stored || (mm&&mm.matches?'dark':'light');
      document.documentElement.setAttribute('data-theme',theme);
      const t=document.getElementById('themeToggle');
      if(t) t.checked=theme==='dark';
    }

    function handleChartClickFilter(type, value) {
      const values = MultiSelect.getValues();
      if (value == null) return;

      const rawLabel = String(value).trim();
      if (!rawLabel) return;

      const key = rawLabel.toLowerCase();

      if (type === 'rag') {
        values.rag = [key];
      } else if (type === 'industry') {
        values.industry = [key];
      } else if (type === 'territory') {
        values.territory = [key];
      } else if (type === 'LoS') {
        values.LoS = [key];
      } else {
        return;
      }

      MultiSelect.setValues(values);
      MultiSelect.applySelectionsToDom();
      Filters.save();
      applyFiltersAndRenderFn();

      const labelForMessage = rawLabel;
      Message.show(`Filter applied from chart: ${type.toUpperCase()} = ${labelForMessage}`, 'info', 3000);
    }

    function applyFiltersAndRender(){
      const allRows=UI.getAllRows();
      const f=Filters.getValues();
      const normList=arr=>(arr||[]).map(v=>(v==null?'':String(v).trim().toLowerCase())).filter(Boolean);
      const statusSet=new Set(normList(f.status));
      const ragSet=new Set(normList(f.rag));
      const territorySet=new Set(normList(f.territory));
      const industrySet=new Set(normList(f.industry));
      const resourcesSet=new Set(normList(f.resources));
      const utilisationSet=new Set(normList(f.utilisation));
      const capabilitySet=new Set(normList(f.capability));
      const multiTowerSet=new Set(normList(f.multiTower));
      const LoSSet=new Set(normList(f.LoS));

      const filtered=allRows.filter(r=>{
        const norm=v=>(v==null?'':String(v).trim().toLowerCase());
        if(statusSet.size && !statusSet.has(norm(r.status))) return false;
        if(ragSet.size && !ragSet.has(norm(r.rag))) return false;
        if(territorySet.size && !territorySet.has(norm(r.territory))) return false;
        if(industrySet.size && !industrySet.has(norm(r.industry))) return false;

        if(resourcesSet.size){
          const parts=(r.resources||'').split(/[;,]/).map(v=>v.trim().toLowerCase()).filter(Boolean);
          if(!parts.some(p=>resourcesSet.has(p))) return false;
        }
        if(utilisationSet.size && !utilisationSet.has(norm(r.utilisation))) return false;

        if(capabilitySet.size){
          const parts=(r.capability||'').split(/[;,]/).map(v=>v.trim().toLowerCase()).filter(Boolean);
          if(!parts.some(p=>capabilitySet.has(p))) return false;
        }

        if(multiTowerSet.size && !multiTowerSet.has(norm(r.multiTower))) return false;

        if(LoSSet.size){
          const arr=Array.isArray(r.LoSLower)?r.LoSLower.map(v=>(v||'').trim().toLowerCase()).filter(Boolean):[];
          if(!arr.length || !arr.some(v=>LoSSet.has(v))) return false;
        }

        if(f.duration){
          if(r.durationMonths==null) return false;
          const m=r.durationMonths;
          if(f.duration==='0-6' && !(m>=0&&m<=6)) return false;
          if(f.duration==='6-12' && !(m>6&&m<=12)) return false;
          if(f.duration==='12+' && !(m>12)) return false;
        }

        if(f.search){
          const txt=(r.name+' '+(r.capability||'')+' '+(r.client||'')+' '+
                     (r.notes||'')+' '+(r.scope||'')+' '+(r.risks||'')+' '+
                     (r.resources||'')+' '+(r.utilisation||'')+' '+
                     (r.multiTower||'')+' '+(r.LoSDisplay||'')+' '+(r.partner||'')
                   ).toLowerCase();
          if(!txt.includes(f.search)) return false;
        }
        return true;
      });

      const {sortKey,sortDir}=UI.getSort();
      const dir=sortDir==='asc'?1:-1;
      filtered.sort((a,b)=>compare(a,b,sortKey)*dir);
      UI.setFilteredRows(filtered);
      const m=DataService.computeMetrics(filtered);
      UI.updateKpis(m);
      UI.updatePortfolioChips(m);
      Charts.rebuildAll(m,handleChartClickFilter,filtered);
      UI.renderTable();
      UI.updateSortIndicators();
      Filters.renderChips();
    }

    const applyFiltersDebounced = debounce(applyFiltersAndRender,150);
    applyFiltersAndRenderFn = applyFiltersAndRender;

    function parseExcel(file,callback,errorCallback){
      const reader=new FileReader();
      reader.onload=e=>{
        try{
          if(!window.XLSX) throw new Error('XLSX library not loaded.');
          const data=e.target.result;
          const wb=XLSX.read(data,{type:'array'});
          const sheet=wb.Sheets[wb.SheetNames[0]];
          const rawRows=XLSX.utils.sheet_to_json(sheet,{defval:'',raw:true});
          const normalized=rawRows.map(row=>{
            const nr={...row};
            Object.keys(nr).forEach(k=>{
              const lk=k.toLowerCase();
              if(lk==='start_date'||lk==='start date'||lk==='start') nr[k]=DataService.normalizeXlsxDateValue(nr[k]);
              if(lk==='end_date'||lk==='end date'||lk==='end') nr[k]=DataService.normalizeXlsxDateValue(nr[k]);
            });
            return nr;
          });
          callback(normalized);
        }catch(err){
          console.error(err);
          if(errorCallback) errorCallback(err);
        }
      };
      reader.onerror=err=>{if(errorCallback) errorCallback(err);};
      reader.readAsArrayBuffer(file);
    }

    function handleUpload(file){
      const name=file.name.toLowerCase();
      const isExcel=name.endsWith('.xls')||name.endsWith('.xlsx');
      const isCsv=name.endsWith('.csv');
      const post=(raw,label)=>{
        if(!raw||!raw.length){Message.show(`No rows detected in the uploaded ${label}.`,'error');return;}
        const rows=raw.map(DataService.normalizeRow);
        UI.setData(rows);
        UI.populateFilterOptions(rows);
        Filters.clear();
        applyFiltersAndRender();
        Message.show(`Loaded ${rows.length.toLocaleString()} rows from uploaded ${label}.`,'success',4000);
      };
      if(isExcel){
        if(!window.XLSX){Message.show('Excel support library is not available. Please use CSV.','error');return;}
        parseExcel(file,raw=>post(raw,'Excel file'),()=>Message.show('Error parsing uploaded Excel file.','error'));
        return;
      }
      if(isCsv){
        const reader=new FileReader();
        reader.onload=e=>{
          try{
            const text=e.target.result;
            const raw=DataService.parseCsv(text);
            post(raw,'CSV file');
          }catch(err){
            console.error(err);
            Message.show('Error parsing uploaded CSV file.','error');
          }
        };
        reader.readAsText(file);
        return;
      }
      Message.show('Unsupported file type. Please upload a CSV or Excel (.xls, .xlsx) file.','error');
    }

    function initTheme(){
      applyStoredTheme();
      const t=document.getElementById('themeToggle');
      if(t){
        t.addEventListener('change',()=>{
          const theme=t.checked?'dark':'light';
          document.documentElement.setAttribute('data-theme',theme);
          try{localStorage.setItem('dashboard-theme',theme);}catch{}
          const rows=UI.getFilteredRows();
          const m=DataService.computeMetrics(rows);
          Charts.rebuildAll(m,handleChartClickFilter,rows);
        });
      }
    }

    function initAsOf(){
      const asOfEl=document.getElementById('asOf');
      const asOfTopEl=document.getElementById('asOfTop');
      const now=new Date();
      const fmt=new Intl.DateTimeFormat('en-GB',{dateStyle:'medium',timeStyle:'short'});
      const text='As of '+fmt.format(now);
      if(asOfEl) asOfEl.textContent=text;
      if(asOfTopEl) asOfTopEl.textContent=text;
    }

    function initFilters(){
      MultiSelect.attachHandlers(()=>{Filters.save();applyFiltersDebounced();});
      const durationEl=document.getElementById('filterDuration');
      const searchEl=document.getElementById('filterSearch');
      const onChange=()=>{Filters.save();applyFiltersDebounced();};
      if(durationEl) durationEl.addEventListener('change',onChange);
      if(searchEl)  searchEl.addEventListener('input',onChange);
      const headerClear=document.getElementById('filtersHeaderClear');
      if(headerClear) headerClear.addEventListener('click',()=>{Filters.clear();applyFiltersAndRender();});
      Filters.attachChipHandlers(applyFiltersAndRender);
    }

    function initTableSorting(){
      document.querySelectorAll('#projectsTable thead th').forEach(th=>{
        th.addEventListener('click',()=>{
          const key=th.getAttribute('data-key');
          if(!key||!UI.getAllRows().length) return;
          const {sortKey,sortDir}=UI.getSort();
          if(sortKey===key) UI.setSort(key,sortDir==='asc'?'desc':'asc');
          else UI.setSort(key,'asc');
          applyFiltersAndRender();
        });
        th.tabIndex=0;
        th.setAttribute('aria-sort','none');
        th.addEventListener('keydown',e=>{
          if(e.key==='Enter'||e.key===' '){e.preventDefault();th.click();}
        });
      });
      const toggleDensityBtn=document.getElementById('toggleDensity');
      if(toggleDensityBtn) toggleDensityBtn.addEventListener('click',UI.toggleDensity);
    }

    function initDragAndDrop(){
      const zone=document.getElementById('filterBar');
      if(!zone) return;
      zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('dragover');});
      ['dragleave','dragend'].forEach(ev=>zone.addEventListener(ev,()=>zone.classList.remove('dragover')));
      zone.addEventListener('drop',e=>{
        e.preventDefault();
        zone.classList.remove('dragover');
        const file=e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        if(file) handleUpload(file);
      });
    }

    function initUpload(){
      const input=document.getElementById('uploadData');
      if(!input) return;
      input.addEventListener('change',()=>{
        const file=input.files && input.files[0];
        if(file) handleUpload(file);
        input.value='';
      });
    }

    function initExportButtons(){
      const btnCsv=document.getElementById('btnExportCsv');
      if(btnCsv) btnCsv.addEventListener('click',UI.exportCsv);

      document.querySelectorAll('[data-export-chart]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id=btn.getAttribute('data-export-chart');
          Charts.exportChartPng(id);
        });
      });
    }

    function initPrintAndSnapshot(){
      const printToggle=document.getElementById('printModeToggle');
      const printNow=document.getElementById('btnPrintNow');
      const downloadHtml=document.getElementById('btnDownloadHtml');

      if(printToggle){
        printToggle.addEventListener('click',()=>{
          const root=document.documentElement;
          const isPrint=root.getAttribute('data-print-mode')==='on';
          const next=!isPrint;
          root.setAttribute('data-print-mode',next?'on':'off');
          printToggle.setAttribute('aria-pressed', next ? 'true' : 'false');
          if(printNow) {
            printNow.classList.toggle('btn-print-now-hidden',!next);
          }
          printToggle.textContent = next ? 'Exit print / PDF mode' : 'Print / PDF mode';
        });
      }
      if(printNow){
        printNow.addEventListener('click',()=>window.print());
      }

      if(downloadHtml){
        downloadHtml.addEventListener('click',()=>{
          const html='<!DOCTYPE html>\n'+document.documentElement.outerHTML;
          const blob=new Blob([html],{type:'text/html;charset=utf-8;'});
          const url=URL.createObjectURL(blob);
          const a=document.createElement('a');
          const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
          a.download=`portfolio_snapshot_${ts}.html`;
          a.href=url;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          Message.show('Snapshot downloaded.','success',3000);
        });
      }
    }

    function initReset(){
      const btnReset=document.getElementById('btnResetDashboard');
      if(!btnReset) return;
      btnReset.addEventListener('click',()=>{
        if(!confirm('Clear loaded data and reset filters?')) return;
        UI.setData([]);
        UI.renderTable();
        UI.updateKpis({
          total:0,
          industries:0,
          uniqueClients:0,
          upcoming:0,
          atRisk:0,
          multiTowerCount:0,
          closed:0,
          statusCounts:{},ragCounts:{},industryCounts:{},territoryCounts:{},LoSCounts:{},LoSByTerritory:{}
        });
        UI.updatePortfolioChips({total:0,industries:0});
        Filters.clear();
        Charts.rebuildAll({
          statusCounts:{},
          industryCounts:{},
          territoryCounts:{},
          LoSCounts:{},
          LoSByTerritory:{},
          ragCounts:{},
          total:0,
          upcoming:0,
          avgDuration:0,
          uniqueClients:0,
          industries:0,
          atRisk:0,
          multiTowerCount:0,
          closed:0
        },handleChartClickFilter,[]);
        Message.show('Dashboard reset. You can upload a new CSV or Excel file.','success',3000);
      });
    }

    function initFilterToggle(){
      const toggle = document.getElementById('toggleFilters');
      const filterBar = document.getElementById('filterBar');
      if (!toggle || !filterBar) return;

      filterBar.removeAttribute('hidden');
      toggle.setAttribute('aria-expanded','true');
      const labelSpan0 = toggle.querySelector('span:last-child');
      if (labelSpan0) labelSpan0.textContent = 'Hide filters';

      toggle.addEventListener('click', () => {
        const isCurrentlyVisible = !filterBar.hasAttribute('hidden');
        const nextVisible = !isCurrentlyVisible;

        if (nextVisible) {
          filterBar.removeAttribute('hidden');
        } else {
          filterBar.setAttribute('hidden','hidden');
        }

        toggle.setAttribute('aria-expanded', nextVisible ? 'true' : 'false');

        const labelSpan = toggle.querySelector('span:last-child');
        if (labelSpan) {
          labelSpan.textContent = nextVisible ? 'Hide filters' : 'Show filters';
        }
      });
    }

    function init(){
      initTheme();
      initAsOf();
      initFilters();
      UI.initSortFromStorage();
      initTableSorting();
      initDragAndDrop();
      initUpload();
      initExportButtons();
      initPrintAndSnapshot();
      initReset();
      UI.initDensityFromStorage();
      initFilterToggle();

      UI.updateGettingStartedVisibility();
      Filters.renderChips();
      applyFiltersAndRender();
    }

    return {init,applyFiltersAndRender};
  })();

  return {
    DataService,
    UI,
    Filters,
    App
  };
})();
document.addEventListener('DOMContentLoaded', () => {
  Dashboard.App.init();
});
</script>
</body>
</html>
