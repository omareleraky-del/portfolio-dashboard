<!DOCTYPE html>
<html lang="en" data-theme="light" data-print-mode="off">
<head>
  <meta charset="UTF-8" />
  <title>Business Analysis and Product Management Team</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Executive portfolio view for Business Analysis & Product Management: duration, risk profile, client coverage, and team utilisation." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #f3f4f6;
      --surface: #ffffff;
      --surface-subtle: #f9fafb;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;

      --pwc-orange: #dc6900;
      --pwc-light-orange: #f39c12;
      --pwc-red: #e0301e;
      --pwc-dark-red: #a32020;

      --accent: var(--pwc-orange);
      --accent-soft: rgba(220,105,0,0.06);
      --accent-soft-strong: rgba(220,105,0,0.12);

      --green: #16a34a;
      --amber: var(--pwc-light-orange);
      --red: var(--pwc-red);
      --hold: #6b7280;

      --row-alt: #ffffff;
      --focus-ring: #2563eb;

      --topbar-bg: linear-gradient(90deg, #121826, #1b2838);
      --topbar-border: rgba(148,163,184,0.25);
      --topbar-text: #f9fafb;
      --topbar-muted: #e5e7eb;

      --shadow-strong: 0 18px 45px rgba(15,23,42,0.16);
      --shadow-card: 0 6px 16px rgba(15,23,42,0.06);
      --shadow-card-strong: 0 8px 24px rgba(15,23,42,0.07);

      --chart-axis: #6b7280;
      --chart-grid: #e5e7eb;
      --chart-label: #374151;

      --message-info-bg: #e0f2fe;
      --message-info-text: #0f172a;
      --message-error-bg: #fee2e2;
      --message-error-text: #7f1d1d;
      --message-success-bg: #dcfce7;
      --message-success-text: #14532d;

      --font-xs: 0.6875rem;
      --font-sm: 0.75rem;
      --font-base: 0.8125rem;
      --font-md: 0.875rem;
      --font-lg: 1rem;
      --line-tight: 1.2;
      --line-normal: 1.45;

      --icon-neutral: #6b7280;
      --icon-active: var(--accent);

      --transition-fast: 150ms ease-out;
      --transition-med: 200ms ease-out;
    }

    html[data-theme="dark"] {
      --bg: #020617;
      --surface: #020617;
      --surface-subtle: #0b1120;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;

      --accent: #f97316;
      --accent-soft: rgba(249,115,22,0.1);
      --accent-soft-strong: rgba(249,115,22,0.2);

      --green: #22c55e;
      --amber: #facc15;
      --red: #f97373;
      --hold: #9ca3af;

      --row-alt: #020617;
      --focus-ring: #60a5fa;

      --topbar-bg: linear-gradient(90deg, #020617, #0b1120);
      --topbar-border: #020617;
      --topbar-text: #f9fafb;
      --topbar-muted: #cbd5f5;

      --shadow-strong: 0 18px 45px rgba(15,23,42,0.9);
      --shadow-card: 0 8px 24px rgba(15,23,42,0.8);
      --shadow-card-strong: 0 12px 40px rgba(15,23,42,0.9);

      --chart-axis: #9ca3af;
      --chart-grid: #111827;
      --chart-label: #e5e7eb;

      --message-info-bg: #1d4ed8;
      --message-info-text: #eff6ff;
      --message-error-bg: #7f1d1d;
      --message-error-text: #fee2e2;
      --message-success-bg: #166534;
      --message-success-text: #dcfce7;

      --icon-neutral: #9ca3af;
      --icon-active: var(--accent);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top left, #fff7ed 0, var(--bg) 38%, #e5e7eb 100%);
      color: var(--text);
      font-size: var(--font-base);
      line-height: var(--line-normal);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      transition:
        background var(--transition-med),
        color var(--transition-med);
    }

    html[data-theme="dark"] body {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* TOP BAR */
    .top-bar {
      border-bottom: 1px solid var(--topbar-border);
      background: var(--topbar-bg);
      color: var(--topbar-text);
      padding: 0.5rem 0 0.25rem;
      box-shadow: 0 8px 30px rgba(15,23,42,0.25);
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
    }

    .top-bar-inner {
      max-width: 72rem;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .top-bar-title {
      font-size: var(--font-md);
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .asof-pill {
      font-size: var(--font-xs);
      color: var(--topbar-muted);
      opacity: 0.9;
      white-space: nowrap;
    }

    .pwc-mark {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(148,163,184,0.4);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .logo-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15,23,42,0.2);
    }

    html[data-theme="dark"] .logo-chip {
      background: #020617;
      border-color: #334155;
    }

    .logo-img {
      height: 1.25rem;
      width: auto;
      display: block;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: var(--font-xs);
      color: var(--topbar-muted);
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .theme-toggle input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .toggle-track {
      width: 2rem;
      height: 1rem;
      border-radius: 999px;
      background: rgba(148,163,184,0.4);
      position: relative;
      transition: background var(--transition-fast);
    }

    .toggle-thumb {
      width: 0.875rem;
      height: 0.875rem;
      border-radius: 999px;
      background: #f9fafb;
      position: absolute;
      top: 1px;
      left: 1px;
      transition:
        transform var(--transition-fast),
        background var(--transition-fast),
        box-shadow var(--transition-fast);
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }

    .theme-toggle input:checked + .toggle-track {
      background: var(--accent-soft-strong);
    }

    .theme-toggle input:checked + .toggle-track .toggle-thumb {
      transform: translateX(1rem);
      background: #fffbeb;
      box-shadow: 0 1px 4px rgba(0,0,0,0.7);
    }

    /* MESSAGE BAR */
    .message-bar {
      max-width: 72rem;
      margin: 0.25rem auto 0;
      padding: 0 1rem 0.25rem;
    }

    .message-bar-inner {
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      font-size: var(--font-xs);
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      box-shadow: 0 4px 14px rgba(15,23,42,0.2);
    }

    .message-bar-inner.info {
      background: var(--message-info-bg);
      color: var(--message-info-text);
    }

    .message-bar-inner.error {
      background: var(--message-error-bg);
      color: var(--message-error-text);
    }

    .message-bar-inner.success {
      background: var(--message-success-bg);
      color: var(--message-success-text);
    }

    .message-bar-text {
      flex: 1;
    }

    .message-bar-close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.75rem;
      color: inherit;
      padding: 0;
      line-height: 1;
    }

    /* PAGE SHELL */
    .page {
      max-width: 72rem;
      width: 100%;
      margin: 0.45rem auto 1.4rem;
      padding: 0.8rem 0.75rem 1.1rem;
      box-sizing: border-box;
      background: radial-gradient(circle at top, var(--surface) 0, var(--surface-subtle) 45%, var(--bg) 100%);
      border-radius: 1rem;
      box-shadow: var(--shadow-strong), 0 0 0 1px rgba(148,163,184,0.18);
      transition: box-shadow var(--transition-med), background var(--transition-med);
    }

    html[data-theme="dark"] .page {
      box-shadow: var(--shadow-strong);
    }

    /* HEADER ROW */
    .header-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.6rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.6rem;
    }

    .heading-block {
      flex: 1;
      min-width: 0;
    }

    .heading {
      font-size: 1.05rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      margin: 0;
      color: var(--text);
      line-height: var(--line-tight);
    }

    .subheading {
      font-size: var(--font-base);
      color: var(--muted);
      max-width: 980px;
      margin-top: 0.35rem;
      line-height: var(--line-normal);
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.4rem;
      white-space: nowrap;
    }

    .timestamp {
      font-size: var(--font-xs);
      color: var(--muted);
      margin: 0.2rem 0 0.8rem;
    }

    /* BUTTONS */
    .btn {
      font-size: var(--font-xs);
      padding: 0.35rem 0.85rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.9);
      background: var(--surface);
      cursor: pointer;
      white-space: nowrap;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      min-height: 2.1rem;
      transition:
        background var(--transition-fast),
        border-color var(--transition-fast),
        color var(--transition-fast),
        box-shadow var(--transition-fast),
        transform var(--transition-fast);
    }

    .btn:hover {
      background: var(--surface-subtle);
      border-color: #9ca3af;
      transform: translateY(-0.5px);
      box-shadow: 0 3px 8px rgba(15,23,42,0.15);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 2px;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: #ea7a1a;
      border-color: #ea7a1a;
    }

    .btn-secondary {
      border-color: #d1d5db;
      color: var(--text);
      background: var(--surface-subtle);
    }

    html[data-theme="dark"] .btn,
    html[data-theme="dark"] .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border-color: #334155;
    }

    html[data-theme="dark"] .btn:hover,
    html[data-theme="dark"] .btn-secondary:hover {
      background: #0f172a;
      border-color: #475569;
    }

    .btn-icon {
      font-size: 0.875rem;
      line-height: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-small {
      font-size: 0.7rem;
      padding: 0.25rem 0.6rem;
      min-height: 1.75rem;
    }

    .btn.btn-filter {
      padding: 0.35rem 0.8rem;
      min-height: 2.25rem;
      min-width: 40px;
    }

    .btn-print-now-hidden {
      display: none;
    }

    /* FILTER ICONS */
    .filter-icon {
      width: 16px;
      height: 16px;
      display: block;
      color: var(--icon-neutral);
    }

    .filters-header-icon .filter-icon,
    #toggleFilters .filter-icon {
      color: var(--icon-neutral);
    }

    .filters-active #toggleFilters {
      border-color: var(--icon-active);
      background: var(--accent-soft);
      color: var(--icon-active);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.02);
    }

    .filters-active #toggleFilters .filter-icon {
      color: var(--icon-active);
    }

    #toggleFilters .btn-icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .filters-header-icon {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-soft);
      color: var(--accent);
    }

    /* KPI GRID */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 0.7rem;
    }

    @media (max-width: 960px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0.625rem;
      padding: 0.7rem 0.8rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: var(--shadow-card);
      transition:
        box-shadow var(--transition-med),
        transform var(--transition-fast),
        border-color var(--transition-fast),
        background var(--transition-fast);
    }

    .card:hover {
      box-shadow: var(--shadow-card-strong);
      transform: translateY(-1px);
      border-color: rgba(148,163,184,0.8);
    }

    .card-header {
      font-size: var(--font-xs);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
    }

    .kpi-label {
      flex: 1;
    }

    .kpi-icon {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      color: #fff;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.05);
    }

    .kpi-icon.total { background: var(--accent); }
    .kpi-icon.closed { background: var(--pwc-dark-red); }
    .kpi-icon.duration { background: var(--pwc-light-orange); }
    .kpi-icon.upcoming { background: var(--amber); }
    .kpi-icon.onhold { background: var(--pwc-red); }

    .kpi-value {
      font-size: 1.35rem;
      font-weight: 600;
      margin-bottom: 1px;
      color: var(--accent);
    }

    .kpi-caption {
      font-size: var(--font-xs);
      color: var(--muted);
      line-height: 1.4;
    }

    .span-2 { grid-column: span 1; }
    .span-12 { grid-column: span 1; }

    /* FILTERS HEADER */
    .filters-header {
      max-width: 72rem;
      margin: 0.15rem auto 0.3rem;
      padding: 0.35rem 0.4rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: var(--font-xs);
      color: var(--muted);
      border-radius: 999px;
      border: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(249,250,251,0.95), rgba(255,255,255,0.95));
      position: relative;
      overflow: hidden;
    }

    .filters-header::before {
      content: '';
      position: absolute;
      inset-inline: 0;
      bottom: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent-soft-strong), transparent);
      opacity: 0.9;
      pointer-events: none;
    }

    .filters-header-left {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 0;
    }

    .filters-header-title {
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-weight: 600;
      color: var(--text);
    }

    .filters-header-subtitle {
      font-size: 0.68rem;
      color: var(--muted);
      margin-top: 1px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .filters-header-right {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: var(--font-xs);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .filters-header-badge {
      padding: 0.12rem 0.55rem;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid var(--accent-soft-strong);
      color: var(--accent);
      font-weight: 500;
    }

    .filters-header-clear-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: var(--font-xs);
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .filters-header-clear-btn:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 2px;
    }

    /* FILTER BAR */
    .filter-bar {
      background: radial-gradient(circle at top left, var(--surface) 0, var(--surface-subtle) 70%);
      border: 1px solid var(--border);
      border-radius: 0.85rem;
      padding: 0.6rem 0.75rem 0.65rem;
      margin: 0 auto 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      box-shadow: var(--shadow-card);
      max-width: 72rem;
    }

    .filter-row {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 0.45rem;
      width: 100%;
    }

    @media (max-width: 960px) {
      .filter-row {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .filter-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.12rem;
      min-width: 0;
    }

    .filter-group.search-group {
      grid-column: span 2;
    }

    @media (max-width: 960px) {
      .filter-group.search-group {
        grid-column: span 3;
      }
    }

    @media (max-width: 640px) {
      .filter-group.search-group {
        grid-column: span 1;
      }
    }

    .filter-label {
      font-size: var(--font-xs);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .filter-control {
      font-size: var(--font-xs);
      padding: 0.34rem 0.48rem;
      border-radius: 0.45rem;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: var(--text);
      width: 100%;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .filter-control:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 1px;
      border-color: var(--focus-ring);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }

    .filter-search-wrap {
      position: relative;
    }

    .filter-search-icon {
      position: absolute;
      top: 50%;
      left: 0.4rem;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
    }

    .filter-search {
      padding-left: 1.5rem;
    }

    /* MULTISELECT */
    .multiselect {
      position: relative;
      font-size: var(--font-xs);
    }

    .multiselect-display {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.25rem;
      padding: 0.3rem 0.45rem;
      border-radius: 0.45rem;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
      min-height: 1.9rem;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .multiselect-display:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 1px;
      border-color: var(--focus-ring);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.4);
    }

    .multiselect-display span.placeholder {
      color: #9ca3af;
    }

    .multiselect-display-items {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.2rem;
      overflow: hidden;
    }

    .multiselect-arrow {
      font-size: 0.6rem;
      color: var(--muted);
      flex-shrink: 0;
    }

    .multiselect-clear {
      border: none;
      background: transparent;
      font-size: 0.6rem;
      color: var(--muted);
      cursor: pointer;
      padding: 0 0 0 0.25rem;
      flex-shrink: 0;
    }

    .multiselect-menu {
      position: absolute;
      z-index: 30;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--surface);
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card-strong);
      max-height: 220px;
      overflow-y: auto;
      padding: 0.25rem 0;
      display: none;
    }

    .multiselect-menu[data-open="true"] {
      display: block;
    }

    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.65rem;
      font-size: var(--font-xs);
      cursor: pointer;
    }

    .multiselect-option input {
      accent-color: var(--accent);
      cursor: pointer;
    }

    .multiselect-option:hover {
      background: var(--accent-soft);
    }

    .multiselect-empty {
      padding: 0.4rem 0.65rem;
      font-size: var(--font-xs);
      color: var(--muted);
    }

    .multiselect-pill {
      padding: 0.08rem 0.35rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--text);
      white-space: nowrap;
    }

    /* FILTER ACTIONS */
    .filter-actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      padding-top: 0.4rem;
      margin-top: 0.35rem;
      border-top: 1px dashed var(--border);
    }

    .filter-actions-left {
      font-size: var(--font-xs);
      color: var(--muted);
    }

    .filter-actions-right {
      display: flex;
      flex-wrap: nowrap;
      gap: 0.35rem;
      justify-content: flex-end;
      width: 100%;
      overflow-x: auto;
      padding-bottom: 1px;
    }

    /* ACTIVE FILTER CHIPS */
    .active-filters {
      max-width: 72rem;
      margin: 0.2rem auto 0.65rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      font-size: var(--font-xs);
      color: var(--muted);
      align-items: center;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.14rem 0.55rem;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid var(--accent-soft-strong);
      color: var(--text);
    }

    .filter-chip-label {
      font-weight: 500;
    }

    .filter-chip-clear,
    .filter-chip-clear-all {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.7rem;
      color: var(--muted);
      padding: 0 0 0 0.25rem;
    }

    .filter-chip-clear-all {
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .filter-chip-clear:focus-visible,
    .filter-chip-clear-all:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: 2px;
    }

    /* CHARTS COMMON */
    .chart-wrap {
      width: 100%;
      max-width: 100%;
      position: relative;
      overflow: hidden;
      min-height: 180px;
    }

    .portfolio-chart-wrap {
      padding-top: 4px;
      margin-top: 4px;
    }

    .chart-empty-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xs);
      color: var(--muted);
      padding: 0.6rem;
      text-align: center;
      background: radial-gradient(circle at top, rgba(249,250,251,0.9), rgba(249,250,251,0.7));
      pointer-events: none;
    }

    html[data-theme="dark"] .chart-empty-overlay {
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
    }

    .donut-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
      pointer-events: none;
    }

    .donut-caption {
      font-size: var(--font-xs);
      font-weight: 400;
      margin-top: 0.1rem;
      color: var(--muted);
    }

    /* SECTION TITLES */
    .section-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1.2rem;
      margin-bottom: 0.45rem;
      padding: 0.2rem 0.2rem 0.2rem 0;
      border-bottom: 1px solid var(--border);
    }

    .section-title {
      font-size: var(--font-md);
      font-weight: 600;
      color: var(--text);
    }

    .pill {
      padding: 0.18rem 0.55rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: var(--font-xs);
      color: var(--muted);
      background: var(--surface);
    }

    .projects-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.55rem 0.7rem 0.75rem;
      page-break-before: always;
      box-shadow: var(--shadow-card);
    }

    /* TABLE */
    .table-wrap {
      border-radius: 0.6rem;
      border: 1px solid var(--border);
      background: var(--surface);
      overflow-x: auto;
      overflow-y: auto;
      max-height: 40rem;
      width: 100%;
      box-sizing: border-box;
    }

    table.data-table {
      border-collapse: collapse;
      table-layout: auto;
      width: max-content;
      min-width: 100%;
      font-size: 0.8rem;
      font-weight: 400;
      border: 1px solid #e5e7eb;
      color: var(--text);
      background: var(--surface);
    }

    html[data-theme="dark"] table.data-table {
      border-color: #374151;
    }

    table.data-table.compact {
      font-size: 0.75rem;
    }

    table.data-table.compact th,
    table.data-table.compact td {
      padding: 0.3rem 0.4rem;
    }

    .data-table thead {
      background: #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 2;
      box-shadow: 0 1px 0 var(--border);
    }

    html[data-theme="dark"] .data-table thead {
      background: #0f172a;
      box-shadow: 0 1px 0 #1f2937;
    }

    .data-table th,
    .data-table td {
      padding: 0.5rem 0.55rem;
      border-bottom: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
      font-weight: 400;
    }

    html[data-theme="dark"] .data-table th,
    html[data-theme="dark"] .data-table td {
      border-color: #374151;
    }

    .data-table th:last-child,
    .data-table td:last-child {
      border-right: 1px solid #e5e7eb;
    }

    .data-table th {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      cursor: pointer;
      white-space: nowrap;
      position: relative;
      background-clip: padding-box;
    }

    .data-table th:focus-visible {
      outline: 2px solid var(--focus-ring);
      outline-offset: -2px;
    }

    .data-table th .sort-indicator {
      margin-left: 0.25rem;
      font-size: 0.55rem;
      opacity: 0.8;
    }

    .data-table tbody tr:nth-child(even) td {
      background: #ffffff;
    }

    html[data-theme="dark"] .data-table tbody tr:nth-child(even) td {
      background: #020617;
    }

    .data-table tbody tr:hover td {
      background: rgba(220,105,0,0.06);
    }

    .data-table td.col-name,
    .data-table td.col-capability,
    .data-table td.col-status,
    .data-table td.col-rag,
    .data-table td.col-date,
    .data-table td.col-territory,
    .data-table td.col-client,
    .data-table td.col-short,
    .data-table td.col-notes {
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .data-table td.col-name { max-width: 260px; }
    .data-table td.col-capability { max-width: 200px; }
    .data-table td.col-client { max-width: 200px; }
    .data-table td.col-notes { max-width: 400px; }

    .status-pill,
    .rag-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      border-radius: 999px;
      padding: 0.18rem 0.48rem;
      border: 1px solid currentColor;
      font-size: 0.7rem;
      background: var(--surface);
      white-space: nowrap;
    }

    html[data-theme="dark"] .status-pill,
    html[data-theme="dark"] .rag-pill {
      background: #020617;
    }

    .status-dot,
    .rag-dot {
      width: 0.45rem;
      height: 0.45rem;
      border-radius: 999px;
      flex-shrink: 0;
    }

    .table-footer {
      margin-top: 0.45rem;
      padding-top: 0.3rem;
      border-top: 1px dashed var(--border);
      font-size: var(--font-xs);
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* PORTFOLIO PANELS */
    .portfolio-card {
      padding: 0.9rem 0.95rem 0.85rem;
      margin-bottom: 0.9rem;
      background: var(--surface);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card);
      page-break-inside: avoid;
    }

    .portfolio-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.75rem;
      padding-bottom: 0.45rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.5rem;
    }

    .portfolio-title {
      font-size: var(--font-md);
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text);
      margin: 0;
    }

    .portfolio-subtitle {
      font-size: var(--font-xs);
      color: var(--muted);
      margin-top: 0.15rem;
    }

    .portfolio-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      justify-content: flex-end;
    }

    .portfolio-chip {
      font-size: 0.625rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.18rem 0.48rem;
      background: var(--surface-subtle);
      color: var(--text);
    }

    .portfolio-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.85rem;
      margin-top: 0.45rem;
      align-items: stretch;
      justify-content: stretch;
    }

    @media (max-width: 960px) {
      .portfolio-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .portfolio-panel {
      background: var(--surface);
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      padding: 0.55rem 0.65rem 0.65rem;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.01);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      transition: box-shadow var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
    }

    .portfolio-panel:hover {
      box-shadow: var(--shadow-card-strong);
      transform: translateY(-1px);
      border-color: rgba(148,163,184,0.8);
    }

    .portfolio-panel-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .panel-title {
      font-size: var(--font-sm);
      font-weight: 600;
      color: var(--text);
    }

    .panel-subtitle {
      font-size: var(--font-xs);
      color: var(--muted);
    }

    .panel-actions {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .industry-summary-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
      font-size: var(--font-xs);
    }

    .industry-count {
      font-weight: 600;
      margin-right: 0.25rem;
    }

    .metrics-summary {
      font-size: var(--font-xs);
      color: var(--muted);
      margin: 0.35rem 0 0.6rem;
    }

    .footnote {
      margin-top: 0.9rem;
      font-size: var(--font-xs);
      color: var(--muted);
      line-height: 1.4;
      text-align: center;
    }

    .getting-started {
      margin: 0.4rem 0 0.8rem;
      padding: 0.6rem 0.75rem;
      border-radius: 0.6rem;
      border: 1px dashed var(--border);
      background: var(--surface-subtle);
      font-size: var(--font-xs);
      color: var(--muted);
    }

    .getting-started-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text);
    }

    .getting-started-steps {
      margin: 0.25rem 0 0;
      padding-left: 1.1rem;
    }

    .getting-started-steps li {
      margin-bottom: 0.15rem;
    }

    .getting-started.is-hidden {
      display: none;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    /* FOOTER */
    .site-footer {
      padding: 12px 16px;
      text-align: center;
      font-size: 11px;
      color: #6b7280;
    }

    .site-footer-inner {
      max-width: 1320px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    @media (max-width: 640px) {
      .header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        align-items: flex-start;
      }
      .top-bar-inner {
        flex-wrap: wrap;
      }
      .filters-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .filters-header-right {
        width: 100%;
        justify-content: flex-start;
      }
      .top-bar-title {
        white-space: normal;
      }
    }

    /* PRINT */
    @media print {
      :root {
        --bg: #ffffff;
        --surface: #ffffff;
        --surface-subtle: #ffffff;
        --border: #d1d5db;
        --shadow-strong: none;
        --shadow-card: none;
      }

      body {
        background: #ffffff !important;
      }

      .top-bar,
      .message-bar,
      #toggleFilters,
      #btnExportCsv,
      #btnShareView,
      #btnDownloadHtml,
      #printModeToggle,
      #btnLoadFromUrl,
      #btnResetDashboard,
      #toggleDensity,
      #uploadData,
      [data-export-chart],
      .site-footer {
        display: none !important;
      }

      .page {
        box-shadow: none;
        margin: 0;
        border-radius: 0;
        padding: 0.5rem 0.25rem;
      }

      .table-wrap {
        max-height: none !important;
        overflow: visible !important;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="top-bar" role="banner">
    <div class="top-bar-inner">
      <div>
        <div class="top-bar-title">Business Analysis and Product Management Team</div>
      </div>
      <div class="top-bar-right">
        <label class="theme-toggle" title="Toggle dark mode">
          <span class="sr-only">Toggle dark mode</span>
          <input id="themeToggle" type="checkbox" aria-label="Toggle dark mode">
          <span class="toggle-track">
            <span class="toggle-thumb"></span>
          </span>
          <span>Dark mode</span>
        </label>

        <span class="asof-pill" id="asOfTop" aria-live="polite">As of —</span>
        <div class="pwc-mark" aria-label="PwC brand">
          <span class="logo-chip">
            <img class="logo-img" src="https://upload.wikimedia.org/wikipedia/commons/c/c3/PwC_Company_Logo.svg" alt="PwC logo">
          </span>
        </div>
      </div>
    </div>
    <div class="message-bar" aria-live="polite">
      <div id="messageBarInner" class="message-bar-inner" role="status">
        <span id="messageBarText" class="message-bar-text"></span>
        <button id="messageBarClose" class="message-bar-close" type="button" aria-label="Dismiss message">✕</button>
      </div>
    </div>
  </div>

  <main role="main">
    <div class="page">
      <header class="header-row" aria-label="Dashboard header">
        <div class="heading-block">
          <h1 class="heading">All Project Portfolio – Executive View</h1>
          <p class="subheading">
            High‑level view of portfolio duration, risk profile and client coverage for the projects.
            Filter the view or upload your latest portfolio file to update the analysis.
          </p>
        </div>
        <div class="header-right">
          <button id="toggleFilters" class="btn btn-filter" aria-expanded="true" aria-controls="filterBar" type="button">
            <span class="btn-icon" aria-hidden="true">
              <svg class="filter-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M4 5h16M7 12h10M10 19h4"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                      stroke-linecap="round"
                      stroke-linejoin="round" />
              </svg>
            </span>
            <span>Hide filters</span>
          </button>
        </div>
      </header>

      <p class="timestamp" id="asOf" aria-live="polite">As of —</p>

      <div class="filters-header" id="filtersHeader" aria-label="Filter summary">
        <div class="filters-header-left">
          <span class="filters-header-icon" aria-hidden="true">
            <svg class="filter-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M4 5h16M7 12h10M10 19h4"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
          </span>
          <div>
            <div class="filters-header-title">Filters</div>
            <div class="filters-header-subtitle">Narrow down the portfolio by status, risk, coverage and search</div>
          </div>
        </div>

        <div class="filters-header-right">
          <span id="filtersSummary" class="filters-header-badge">No filters applied</span>
          <button id="filtersHeaderClear" class="filters-header-clear-btn" type="button">Clear all</button>
        </div>
      </div>

      <section id="filterBar" class="filter-bar" aria-label="Portfolio filters">
        <!-- ROW 1 -->
        <div class="filter-row">
          <div class="filter-group">
            <label class="filter-label" for="filterStatus">Status</label>
            <div class="multiselect" data-key="status" id="filterStatus">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear status filter" aria-label="Clear status filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div class="multiselect-menu" data-open="false" role="listbox" aria-label="Status options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterRag">RAG</label>
            <div class="multiselect" data-key="rag" id="filterRag">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear RAG filter" aria-label="Clear RAG filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div class="multiselect-menu" data-open="false" role="listbox" aria-label="RAG options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterTerritory">Territory</label>
            <div class="multiselect" data-key="territory" id="filterTerritory">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear territory filter" aria-label="Clear territory filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div class="multiselect-menu" data-open="false" role="listbox" aria-label="Territory options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterIndustry">Industry</label>
            <div class="multiselect" data-key="industry" id="filterIndustry">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear industry filter" aria-label="Clear industry filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div class="multiselect-menu" data-open="false" role="listbox" aria-label="Industry options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterDuration">
              Duration
            </label>
            <select id="filterDuration" class="filter-control">
              <option value="">All</option>
              <option value="0-6">0 – 6 months</option>
              <option value="6-12">6 – 12 months</option>
              <option value="12+">More than 1 year</option>
            </select>
          </div>

          <div></div>
        </div>

        <!-- ROW 2 -->
        <div class="filter-row" style="margin-top:0.15rem;">
          <div class="filter-group">
            <label class="filter-label" for="filterCapability">Capability</label>
            <div class="multiselect" data-key="capability" id="filterCapability">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear capability filter" aria-label="Clear capability filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div class="multiselect-menu" data-open="false" role="listbox" aria-label="Capability options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterMultiTower">Multi Tower</label>
            <div class="multiselect" data-key="multiTower" id="filterMultiTower">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear multi tower filter" aria-label="Clear multi tower filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div class="multiselect-menu" data-open="false" role="listbox" aria-label="Multi tower options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterResources">Team Resources</label>
            <div class="multiselect" data-key="resources" id="filterResources">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear team resources filter" aria-label="Clear team resources filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div class="multiselect-menu" data-open="false" role="listbox" aria-label="Team resources options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterUtilisation">Team Utilization %</label>
            <div class="multiselect" data-key="utilisation" id="filterUtilisation">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear utilization filter" aria-label="Clear utilization filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div class="multiselect-menu" data-open="false" role="listbox" aria-label="Utilization options"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterLoS">LoS</label>
            <div class="multiselect" data-key="los" id="filterLoS">
              <div class="multiselect-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false">
                <div class="multiselect-display-items">
                  <span class="placeholder">All</span>
                </div>
                <div style="display:flex; align-items:center; gap:0.15rem;">
                  <button class="multiselect-clear" type="button" title="Clear LoS filter" aria-label="Clear LoS filter">×</button>
                  <span class="multiselect-arrow" aria-hidden="true">▾</span>
                </div>
              </div>
              <div class="multiselect-menu" data-open="false" role="listbox" aria-label="LoS options"></div>
            </div>
          </div>

          <div class="filter-group search-group">
            <label class="filter-label" for="filterSearch">Search</label>
            <div class="filter-search-wrap">
              <span class="filter-search-icon" aria-hidden="true">
                <svg class="filter-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <circle cx="11" cy="11" r="6" fill="none" stroke="currentColor" stroke-width="1.6"/>
                  <line x1="16" y1="16" x2="21" y2="21" stroke="currentColor" stroke-width="1.6"
                        stroke-linecap="round"/>
                </svg>
              </span>
              <input id="filterSearch" class="filter-control filter-search" type="text"
                     placeholder="Search by project, client, industry, scope or risks…" aria-label="Search projects" />
            </div>
          </div>
        </div>

        <div class="filter-actions-row">
          <div class="filter-actions-left">
            Filter actions
          </div>
          <div class="filter-actions-right">
            <label class="btn btn-secondary" style="cursor:pointer;">
              <span class="btn-icon" aria-hidden="true">⬆</span>
              <span>Upload (CSV / Excel)</span>
              <input
                id="uploadData"
                class="upload-input"
                type="file"
                aria-label="Upload CSV or Excel file"
                accept=".csv,.xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                style="display:none;">
            </label>
            <button id="btnLoadFromUrl" class="btn btn-secondary" type="button">
              <span class="btn-icon" aria-hidden="true">🌐</span>
              <span>Load from URL</span>
            </button>
            <button id="btnResetDashboard" class="btn btn-secondary" type="button" title="Clear data and reset view">
              <span class="btn-icon" aria-hidden="true">↺</span>
              <span>Reset (clear data)</span>
            </button>
          </div>
        </div>
      </section>

      <section aria-label="Active filters" id="activeFilters" class="active-filters"></section>

      <section class="grid" style="margin-bottom: 8px;" aria-label="Key portfolio indicators">
        <article class="card span-2" aria-label="Total projects">
          <div class="card-header">
            <span class="kpi-label">Total projects</span>
            <span class="kpi-icon total" aria-hidden="true">Σ</span>
          </div>
          <div class="kpi-value" id="kpiTotal">–</div>
          <div class="kpi-caption">All initiatives in the current view.</div>
        </article>

        <article class="card span-2" aria-label="At risk projects">
          <div class="card-header">
            <span class="kpi-label">At risk (Amber / Red)</span>
            <span class="kpi-icon duration" aria-hidden="true">⚠</span>
          </div>
          <div class="kpi-value" id="kpiAtRisk">–</div>
          <div class="kpi-caption">Projects flagged Amber or Red in the current view.</div>
        </article>

        <article class="card span-2" aria-label="Projects finishing in the next 30 days">
          <div class="card-header">
            <span class="kpi-label">Finishing in next 30 days</span>
            <span class="kpi-icon upcoming" aria-hidden="true">📅</span>
          </div>
          <div class="kpi-value" id="kpiUpcoming">–</div>
          <div class="kpi-caption">Projects with planned end dates in the next 30 days.</div>
        </article>

        <article class="card span-2" aria-label="Closed projects">
          <div class="card-header">
            <span class="kpi-label">Closed projects</span>
            <span class="kpi-icon closed" aria-hidden="true">✔</span>
          </div>
          <div class="kpi-value" id="kpiClosed">–</div>
          <div class="kpi-caption">Engagements that have formally completed.</div>
        </article>

        <article class="card span-2" aria-label="Multi tower projects">
          <div class="card-header">
            <span class="kpi-label">Multi tower projects</span>
          </div>
          <div class="kpi-value" id="kpiMultiTower">–</div>
          <div class="kpi-caption">
            Share of projects involving more than one tower (current view).
          </div>
        </article>
      </section>

      <p class="metrics-summary" id="metricsSummary" aria-live="polite"></p>

      <section id="gettingStarted" class="getting-started" aria-label="Getting started">
        <div class="getting-started-title">Load your portfolio to begin</div>
        <p style="margin:4px 0 6px;">
          Data remains in your browser. No information is sent to a server.
        </p>
        <ol class="getting-started-steps">
          <li>Prepare your CSV or Excel file (one row per project).</li>
          <li>Use “Upload (CSV / Excel)” to load your data.</li>
          <li>Optionally use “Load from URL” if your CSV is hosted online.</li>
        </ol>
      </section>

      <section class="card span-12 portfolio-card" aria-label="Portfolio analysis overview">
        <div class="portfolio-header">
          <div>
            <h2 class="portfolio-title">Portfolio analysis</h2>
            <p class="portfolio-subtitle">
              Duration profile, risk profile and industry concentration (current filters)
            </p>
          </div>
          <div class="portfolio-meta">
            <span class="portfolio-chip" id="portfolioProjectsChip">0 projects in view</span>
            <span class="portfolio-chip muted" id="portfolioIndustriesChip">0 industries</span>
          </div>
        </div>

        <div class="portfolio-grid">
          <article class="portfolio-panel" aria-label="RAG distribution">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">RAG distribution</span><br>
                <span class="panel-subtitle">Risk split across the portfolio</span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button" data-export-chart="ragDonut" aria-label="Export RAG chart as PNG">Export PNG</button>
              </div>
            </div>
            <div class="panel-body">
              <div class="chart-wrap portfolio-chart-wrap" role="img" aria-label="Projects by RAG status">
                <canvas id="ragDonut"></canvas>
                <div class="chart-empty-overlay" id="ragEmpty" style="display:flex;">
                  No RAG status in this view. Assign Green / Amber / Red to see risk split.
                </div>
                <div class="donut-center" id="ragDonutCenter">
                  –
                  <div class="donut-caption">Projects with RAG set</div>
                </div>
              </div>
            </div>
          </article>

          <article class="portfolio-panel" aria-label="Projects by industry">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">Projects by industry</span><br>
                <span class="panel-subtitle">Top industries by project count</span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button" data-export-chart="industryChart" aria-label="Export industry chart as PNG">Export PNG</button>
              </div>
            </div>
            <div class="panel-body">
              <div class="industry-summary-row">
                <div class="industry-summary-main">
                  <span id="industryTotalProjects" class="industry-count">–</span>
                  <span class="industry-label">projects across selected industries</span>
                </div>
                <div class="industry-summary-legend" aria-hidden="true"></div>
              </div>

              <div class="chart-wrap portfolio-chart-wrap" role="img" aria-label="Top industries by project count">
                <canvas id="industryChart"></canvas>
                <div class="chart-empty-overlay" id="industryEmpty" style="display:flex;">
                  No industry data in the current view.
                </div>
              </div>
            </div>
          </article>

          <article class="portfolio-panel" aria-label="Projects by duration range">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">Projects by duration range</span><br>
                <span class="panel-subtitle">Number of projects by duration bucket</span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button" data-export-chart="statusChart" aria-label="Export duration chart as PNG">Export PNG</button>
              </div>
            </div>
            <div class="panel-body">
              <div class="chart-wrap portfolio-chart-wrap" role="img" aria-label="Projects by duration bucket">
                <canvas id="statusChart"></canvas>
                <div class="chart-empty-overlay" id="statusEmpty" style="display:flex;">
                  No duration data in this view.
                </div>
              </div>
            </div>
          </article>

          <article class="portfolio-panel" aria-label="Projects by territory">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">Projects by territory</span><br>
                <span class="panel-subtitle">Where work is being delivered</span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button" data-export-chart="territoryChart" aria-label="Export territory chart as PNG">Export PNG</button>
              </div>
            </div>
            <div class="panel-body">
              <div class="chart-wrap portfolio-chart-wrap" role="img" aria-label="Projects by territory">
                <canvas id="territoryChart"></canvas>
                <div class="chart-empty-overlay" id="territoryEmpty" style="display:flex;">
                  No territory data in the current view.
                </div>
              </div>
            </div>
          </article>

          <article class="portfolio-panel" aria-label="Projects by LoS">
            <div class="portfolio-panel-header">
              <div>
                <span class="panel-title">Projects by LoS</span><br>
                <span class="panel-subtitle">Top LoS by project count</span>
              </div>
              <div class="panel-actions">
                <button class="btn btn-secondary btn-small" type="button" data-export-chart="losChart" aria-label="Export LoS chart as PNG">Export PNG</button>
              </div>
            </div>
            <div class="panel-body">
              <div class="chart-wrap portfolio-chart-wrap" role="img" aria-label="Projects by LoS">
                <canvas id="losChart"></canvas>
                <div class="chart-empty-overlay" id="losEmpty" style="display:flex;">
                  No LoS data in the current view.
                </div>
              </div>
            </div>
          </article>

          <div></div>
        </div>
      </section>

      <div class="section-title-row">
        <h2 class="section-title">Projects</h2>
        <span class="pill" id="projectsCount">0 projects</span>
      </div>

      <section class="projects-card" aria-label="Project list">
        <div class="table-wrap" role="region" aria-label="Projects table">
          <table class="data-table" id="projectsTable" aria-describedby="projectsCount tableInfo">
            <thead>
            <tr>
              <th data-key="name" scope="col" class="col-name" role="button">
                Project Name <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="capability" scope="col" class="col-capability" role="button">
                Capability <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="status" scope="col" class="col-status" role="button">
                Status <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="rag" scope="col" class="col-rag" role="button">
                RAG <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="start" scope="col" class="col-date" role="button">
                Start_Date <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="end" scope="col" class="col-date" role="button">
                End_Date <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="durationMonths" scope="col" class="col-date" role="button">
                Duration (months) <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="territory" scope="col" class="col-territory" role="button">
                Territory <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="client" scope="col" class="col-client" role="button">
                Client <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="multiTower" scope="col" class="col-short" role="button">
                Multi Tower <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="resources" scope="col" class="col-short" role="button">
                Team Resources <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="industry" scope="col" class="col-capability" role="button">
                Industry <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="los" scope="col" class="col-short" role="button">
                LoS <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="partner" scope="col" class="col-short" role="button">
                Partner <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="utilisation" scope="col" class="col-short" role="button">
                Team Utilization % <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="scope" scope="col" class="col-notes" role="button">
                Project Scope <span class="sort-indicator" aria-hidden="true"></span>
              </th>
              <th data-key="risks" scope="col" class="col-notes" role="button">
                Risks/Challenges <span class="sort-indicator" aria-hidden="true"></span>
              </th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="table-footer">
          <span id="tableInfo" aria-live="polite">Showing 0 of 0 projects</span>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn" id="toggleDensity" aria-pressed="false" type="button">Compact view</button>
            <button class="btn btn-secondary" id="btnExportCsv" type="button">Export CSV</button>
            <button class="btn btn-secondary" id="printModeToggle" type="button">Print-friendly view</button>
            <button class="btn btn-secondary" id="btnDownloadHtml" type="button">Download snapshot</button>
            <button class="btn btn-secondary" id="btnShareView" type="button">Copy shareable link</button>
            <button class="btn btn-secondary btn-print-now-hidden" id="btnPrintNow" type="button">Print</button>
          </div>
        </div>
      </section>

      <p class="footnote">
        This dashboard is initially empty. Upload a CSV or Excel file or load a CSV from a URL to populate it.
        Expected logical columns (order) are:
        Project Name, Capability, Status, RAG, Start_Date, End_Date, Duration (months), Territory, Client,
        Multi Tower, Team Resources, Industry, LoS, Partner, Team Utilization %, Project Scope, Risks/Challenges.
        Duration is calculated automatically from Start_Date and End_Date; Team Utilization % is taken
        from the data and normalised to a percentage.
      </p>
    </div>
  </main>
</div>

<footer class="site-footer">
  <div class="site-footer-inner">
    <span></span>
    <span>© Copyright Omar Eleraky</span>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // Optional embedded data hooks for offline snapshots
  window.embeddedData = window.embeddedData || [];
  window.embeddedFilters = window.embeddedFilters || null;
  window.embeddedSort = window.embeddedSort || null;
</script>

<script>
/* Register Chart.js DataLabels plugin if available */
(function registerDatalabels() {
  if (window.Chart && window.ChartDataLabels) {
    try {
      window.Chart.register(window.ChartDataLabels);
    } catch (e) {
      console.error('Failed to register ChartDataLabels plugin:', e);
    }
  }
})();

/* DASHBOARD MODULE */
const Dashboard = (function() {
  /* Utility helpers ------------------------------------------------------- */
  function safeMatchMedia(query) {
    try {
      return window.matchMedia && window.matchMedia(query);
    } catch {
      return null;
    }
  }

  function parseDate(value) {
    if (value == null) return null;
    let s = String(value).trim();
    if (!s) return null;

    if (value instanceof Date && !isNaN(value)) {
      return value;
    }

    s = s.replace(/[.]/g, '/').replace(/-/g, '/');

    let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) {
      const day = parseInt(m[1], 10);
      const month = parseInt(m[2], 10) - 1;
      const year = parseInt(m[3], 10);
      const d = new Date(year, month, day);
      if (!isNaN(d) && d.getDate() === day && d.getMonth() === month && d.getFullYear() === year) {
        return d;
      }
    }

    m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
    if (m) {
      const year = parseInt(m[1], 10);
      const month = parseInt(m[2], 10) - 1;
      const day = parseInt(m[3], 10);
      const d = new Date(year, month, day);
      if (!isNaN(d) && d.getDate() === day && d.getMonth() === month && d.getFullYear() === year) {
        return d;
      }
    }

    m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2})$/);
    if (m) {
      const day = parseInt(m[1], 10);
      const month = parseInt(m[2], 10) - 1;
      let year = parseInt(m[3], 10);
      year = year <= 50 ? 2000 + year : 1900 + year;
      const d = new Date(year, month, day);
      if (!isNaN(d) && d.getDate() === day && d.getMonth() === month && d.getFullYear() === year) {
        return d;
      }
    }

    m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) {
      const part1 = parseInt(m[1], 10);
      const part2 = parseInt(m[2], 10);
      const year = parseInt(m[3], 10);

      if (part2 > 12) {
        const month = part1 - 1;
        const day = part2;
        const d = new Date(year, month, day);
        if (!isNaN(d) && d.getDate() === day && d.getMonth() === month && d.getFullYear() === year) {
          return d;
        }
      }
    }

    const fallback = new Date(s);
    return isNaN(fallback) ? null : fallback;
  }

  function fmtDate(d) {
    if (!d) return '';
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${day}-${m}-${y}`;
  }

  function normalizeXlsxDateValue(v) {
    if (!window.XLSX) {
      if (v instanceof Date && !isNaN(v)) return fmtDate(v);
      if (typeof v === 'string') return v;
      return '';
    }

    if (v instanceof Date && !isNaN(v)) {
      return fmtDate(v);
    }

    if (typeof v === 'number' && isFinite(v)) {
      try {
        const d = XLSX.SSF.parse_date_code(v);
        if (!d) return '';
        const jsDate = new Date(d.y, d.m - 1, d.d);
        if (isNaN(jsDate)) return '';
        return fmtDate(jsDate);
      } catch {
        return '';
      }
    }

    if (typeof v === 'string') return v;
    return '';
  }

  function escapeHtml(s) {
    return String(s ?? '').replace(/[&<>"']/g, c => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[c]));
  }

  function getChartColors() {
    const cs = getComputedStyle(document.documentElement);
    return {
      accent: cs.getPropertyValue('--accent').trim(),
      green: cs.getPropertyValue('--green').trim(),
      amber: cs.getPropertyValue('--amber').trim(),
      red: cs.getPropertyValue('--red').trim(),
      hold: cs.getPropertyValue('--hold').trim(),
      axis: cs.getPropertyValue('--chart-axis').trim(),
      grid: cs.getPropertyValue('--chart-grid').trim(),
      label: cs.getPropertyValue('--chart-label').trim()
    };
  }

  function statusColor(status) {
    const colors = getChartColors();
    const s = (status || '').toLowerCase();
    if (s === 'active') return colors.accent;
    if (s === 'closed') return '#9ca3af';
    if (s === 'on hold') return colors.hold;
    return '#9ca3af';
  }

  function ragColor(rag) {
    const colors = getChartColors();
    const r = (rag || '').toLowerCase();
    if (r === 'green') return colors.green;
    if (r === 'amber') return colors.amber;
    if (r === 'red') return colors.red;
    return '#9ca3af';
  }

  function compare(a, b, key) {
    const va = a[key], vb = b[key];
    if (key === 'utilisation') {
      const na = parseFloat(String(a.utilisation || '').replace('%','')) || 0;
      const nb = parseFloat(String(b.utilisation || '').replace('%','')) || 0;
      return na - nb;
    }
    if (key === 'duration' || key === 'durationMonths') {
      const na = a.durationMonths || 0;
      const nb = b.durationMonths || 0;
      return na - nb;
    }
    if (va == null && vb == null) return 0;
    if (va == null) return 1;
    if (vb == null) return -1;
    if (va instanceof Date && vb instanceof Date) return va - vb;
    return String(va).localeCompare(String(vb));
  }

  function debounce(fn, wait) {
    let t = null;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  /* Message utility ------------------------------------------------------- */
  const Message = (function() {
    const bar = document.getElementById('messageBarInner');
    const textEl = document.getElementById('messageBarText');
    const closeBtn = document.getElementById('messageBarClose');
    if (closeBtn && bar) {
      closeBtn.addEventListener('click', () => {
        bar.style.display = 'none';
      });
    }
    function show(message, type = 'info', autoHideMs = 5000) {
      if (!bar || !textEl) return;
      textEl.textContent = message;
      bar.className = 'message-bar-inner ' + type;
      bar.style.display = 'flex';
      if (autoHideMs) {
        setTimeout(() => {
          if (bar.style.display === 'flex') bar.style.display = 'none';
        }, autoHideMs);
      }
    }
    return { show };
  })();

  /* Data parsing / normalisation ------------------------------------------ */
  const DataService = (function() {
    const headerMap = {
      'project name': 'name',
      'project': 'name',
      'name': 'name',
      'capability': 'capability',
      'capabilities': 'capability',
      'status': 'status',
      'rag': 'rag',
      'start_date': 'start',
      'start date': 'start',
      'start': 'start',
      'end_date': 'end',
      'end date': 'end',
      'end': 'end',
      'territory': 'territory',
      'region': 'territory',
      'country': 'territory',
      'client': 'client',
      'customer': 'client',
      'multi tower': 'multiTower',
      'multi-tower': 'multiTower',
      'multitower': 'multiTower',
      'team resources': 'resources',
      'resources': 'resources',
      'ba resources': 'resources',
      'ba resource': 'resources',
      'industry': 'industry',
      'sector': 'industry',
      'los': 'los',
      'line of service': 'los',
      'partner': 'partner',
      'partner name': 'partner',
      'team utilization %': 'utilisationRaw',
      'team utilisation %': 'utilisationRaw',
      'current utilization %': 'utilisationRaw',
      'current utilisation %': 'utilisationRaw',
      'current utilization': 'utilisationRaw',
      'utilisation': 'utilisationRaw',
      'utilization': 'utilisationRaw',
      'notes': 'notes',
      'description': 'notes',
      'project scope': 'scope',
      'scope': 'scope',
      'risks/challenges': 'risks',
      'risks & challenges': 'risks',
      'risks': 'risks',
      'issues': 'risks'
    };

    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim().length);
      if (!lines.length) return [];

      const parseLine = (line) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (ch === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += ch;
          }
        }
        result.push(current);
        return result.map(v => v.trim());
      };

      const rawHeader = parseLine(lines[0]);
      const header = rawHeader.map(h => String(h || '').trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = parseLine(lines[i]);
        if (!cols.length || !cols[0].trim()) continue;
        const row = {};
        header.forEach((h, idx) => {
          row[h] = cols[idx] !== undefined ? cols[idx] : '';
        });
        rows.push(row);
      }

      return rows;
    }

    function normaliseUtilisation(utilRaw) {
      if (utilRaw == null || utilRaw === '') return '';
      let s = String(utilRaw).trim();
      if (!s) return '';
      const hadPercent = s.endsWith('%');
      if (hadPercent) s = s.slice(0, -1).trim();
      const n = parseFloat(s.replace(',', '.'));
      if (!isFinite(n)) return '';
      if (n > 0 && n <= 1) return Math.round(n * 100) + '%';
      if (n >= 0 && n <= 100) return Math.round(n) + '%';
      return '';
    }

    function normalizeRow(row) {
      const lowerKeys = Object.keys(row).reduce((acc, key) => {
        acc[key.toLowerCase()] = key;
        return acc;
      }, {});

      const get = (logicalName, fallbackKeys = []) => {
        const srcKey = Object.entries(headerMap)
          .filter(([k, v]) => v === logicalName)
          .map(([k]) => lowerKeys[k])
          .find(Boolean);
        if (srcKey) return row[srcKey];
        for (const fk of fallbackKeys) {
          if (row[fk] != null && row[fk] !== '') return row[fk];
        }
        return '';
      };

      const rawName = get('name', ['Project Name', 'Project']);
      const rawCapability = get('capability', ['Capability']);
      const rawStatus = get('status', ['Status']);
      const rawRag = get('rag', ['RAG']);
      const rawStart = get('start', ['Start_Date', 'Start Date']);
      const rawEnd = get('end', ['End_Date', 'End Date']);
      const rawTerritory = get('territory', ['Territory']);
      const rawClient = get('client', ['Client']);
      const rawMultiTower = get('multiTower', ['Multi Tower', 'Multi-Tower', 'MultiTower']);
      const rawResources = get('resources', ['Team Resources', 'BA Resources', 'Resources']);
      const rawIndustry = get('industry', ['Industry']);
      const rawLoS = get('los', ['LoS']);
      const rawPartner = get('partner', ['Partner', 'Partner Name']);
      const rawUtil = get('utilisationRaw', [
        'Team Utilization %', 'Team Utilisation %',
        'Current Utilization %', 'Current Utilisation %',
        'Current Utilization', 'Utilisation', 'Utilization'
      ]);
      const rawNotes = get('notes', ['Notes', 'Description']);
      const rawScope = get('scope', ['Project Scope', 'Scope']);
      const rawRisks = get('risks', ['Risks/Challenges', 'Risks', 'Issues']);

      const utilisationDisplay = normaliseUtilisation(rawUtil);

      const startDate = parseDate(rawStart);
      const endDate = parseDate(rawEnd);

      let durationMonths = null;
      if (startDate && endDate && endDate >= startDate) {
        const days = (endDate - startDate) / 86400000;
        durationMonths = days / 30.44;
      }

      return {
        name: (rawName || '').trim(),
        capability: (rawCapability || '').trim(),
        status: (rawStatus || '').trim(),
        rag: (rawRag || '').trim() || null,
        start: startDate,
        end: endDate,
        durationMonths,
        territory: (rawTerritory || '').trim() || 'Unspecified',
        client: (rawClient || '').trim(),
        multiTower: (rawMultiTower || '').trim(),
        resources: (rawResources || '').toString().trim(),
        industry: (rawIndustry || '').trim() || 'Unspecified',
        los: (rawLoS || '').trim(),
        partner: (rawPartner || '').trim(),
        utilisation: utilisationDisplay,
        notes: (rawNotes || '').trim(),
        scope: (rawScope || '').trim(),
        risks: (rawRisks || '').trim()
      };
    }

    function computeMetrics(rows) {
      const total = rows.length;

      const normalizeStatus = (v) => {
        const s = (v || '').toString().trim().toLowerCase();
        if (!s) return 'Unspecified';
        if (s === 'on hold' || s === 'on-hold') return 'On hold';
        if (s === 'active') return 'Active';
        if (s === 'closed') return 'Closed';
        return v.toString().trim();
      };

      const normalizeRag = (v) => {
        const s = (v || '').toString().trim().toLowerCase();
        if (!s) return 'Unspecified';
        if (s === 'green') return 'Green';
        if (s === 'amber') return 'Amber';
        if (s === 'red') return 'Red';
        return v.toString().trim();
      };

      const statusCounts = rows.reduce((a, r) => {
        const k = normalizeStatus(r.status);
        a[k] = (a[k] || 0) + 1;
        return a;
      }, {});

      const ragCounts = rows.reduce((a, r) => {
        const k = normalizeRag(r.rag);
        a[k] = (a[k] || 0) + 1;
        return a;
      }, {});

      const industryCounts = rows.reduce((a, r) => {
        const k = (r.industry || 'Unspecified');
        a[k] = (a[k] || 0) + 1;
        return a;
      }, {});

      const territoryCounts = rows.reduce((a, r) => {
        const k = (r.territory || 'Unspecified');
        a[k] = (a[k] || 0) + 1;
        return a;
      }, {});

      const losCounts = rows.reduce((a, r) => {
        const k = (r.los || 'Unspecified');
        a[k] = (a[k] || 0) + 1;
        return a;
      }, {});

      const today = new Date();
      const upcoming30 = new Date(today.getTime() + 30 * 86400000);
      const upcoming = rows.filter(r => r.end && r.end >= today && r.end <= upcoming30).length;

      const durations = rows
        .map(r => (r.start && r.end ? (r.end - r.start) / 86400000 : null))
        .filter(x => x != null && x >= 0);
      const avgDuration = durations.length
        ? Math.round(durations.reduce((a, b) => a + b, 0) / durations.length)
        : 0;

      const clients = new Set(
        rows.map(r => (r.client || '').trim()).filter(Boolean)
      );
      const industries = Object.keys(industryCounts).length;

      const atRisk = (ragCounts['Amber'] || 0) + (ragCounts['Red'] || 0);

      const multiTowerCount = rows.filter(r => {
        const v = (r.multiTower || '').toString().trim().toLowerCase();
        return v && v !== 'no' && v !== 'n';
      }).length;

      const closed = statusCounts['Closed'] || 0;

      return {
        total,
        statusCounts,
        ragCounts,
        industryCounts,
        territoryCounts,
        losCounts,
        upcoming,
        avgDuration,
        uniqueClients: clients.size,
        industries,
        atRisk,
        multiTowerCount,
        closed
      };
    }

    return { parseCsv, normalizeRow, computeMetrics };
  })();

  /* Multi-select filters -------------------------------------------------- */
  const MultiSelect = (function() {
    const STORAGE_KEY = 'dashboard-filters-multi-v1';

    const KEYS = [
      'status',
      'rag',
      'territory',
      'industry',
      'capability',
      'multiTower',
      'resources',
      'utilisation',
      'los'
    ];

    function getState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveState(state) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state || {}));
      } catch {}
    }

    function getValues() {
      const state = getState();
      const res = {};
      KEYS.forEach(k => {
        res[k] = Array.isArray(state[k]) ? state[k] : [];
      });
      return res;
    }

    function setValues(newValues) {
      const state = getState();
      KEYS.forEach(k => {
        if (newValues[k]) state[k] = Array.from(newValues[k]);
        else state[k] = [];
      });
      saveState(state);
    }

    function createOptions(elementId, options) {
      const container = document.getElementById(elementId);
      if (!container) return;
      const menu = container.querySelector('.multiselect-menu');
      if (!menu) return;

      if (!options || !options.length) {
        menu.innerHTML = '<div class="multiselect-empty">No values available</div>';
        return;
      }

      const unique = Array.from(new Set(options.filter(Boolean))).sort();
      if (!unique.length) {
        menu.innerHTML = '<div class="multiselect-empty">No values available</div>';
        return;
      }

      menu.innerHTML = unique.map(v => `
        <label class="multiselect-option">
          <input type="checkbox" value="${escapeHtml(v)}">
          <span>${escapeHtml(v)}</span>
        </label>
      `).join('');
    }

    function applySelectionsToDom() {
      const state = getState();
      KEYS.forEach(k => {
        const root = document.getElementById('filter' + k.charAt(0).toUpperCase() + k.slice(1));
        if (!root) return;
        const menu = root.querySelector('.multiselect-menu');
        const display = root.querySelector('.multiselect-display-items');
        const displayWrapper = root.querySelector('.multiselect-display');
        if (!menu || !display || !displayWrapper) return;
        const want = Array.isArray(state[k]) ? state[k] : [];

        Array.from(menu.querySelectorAll('input[type="checkbox"]')).forEach(input => {
          input.checked = want.includes(input.value);
        });

        if (!want.length) {
          display.innerHTML = '<span class="placeholder">All</span>';
          displayWrapper.setAttribute('aria-expanded', 'false');
        } else if (want.length <= 2) {
          display.innerHTML = want.map(v =>
            `<span class="multiselect-pill">${escapeHtml(v)}</span>`
          ).join('');
          displayWrapper.setAttribute('aria-expanded', 'false');
        } else {
          const [first, second, ...rest] = want;
          display.innerHTML =
            `<span class="multiselect-pill">${escapeHtml(first)}</span>` +
            `<span class="multiselect-pill">${escapeHtml(second)}</span>` +
            `<span class="multiselect-pill">+${rest.length}</span>`;
          displayWrapper.setAttribute('aria-expanded', 'false');
        }
      });
    }

    function clearFilter(key) {
      const state = getState();
      state[key] = [];
      saveState(state);
      applySelectionsToDom();
    }

    function attachHandlers(onChange) {
      KEYS.forEach(key => {
        const id = 'filter' + key.charAt(0).toUpperCase() + key.slice(1);
        const root = document.getElementById(id);
        if (!root) return;
        const display = root.querySelector('.multiselect-display');
        const menu = root.querySelector('.multiselect-menu');
        const clearBtn = root.querySelector('.multiselect-clear');

        const toggleMenu = (open) => {
          if (!menu || !display) return;
          menu.dataset.open = open ? 'true' : 'false';
          display.setAttribute('aria-expanded', open ? 'true' : 'false');
        };

        if (display) {
          display.addEventListener('click', () => {
            toggleMenu(menu.dataset.open !== 'true');
          });
          display.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              toggleMenu(menu.dataset.open !== 'true');
            } else if (e.key === 'Escape') {
              toggleMenu(false);
              display.blur();
            }
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            clearFilter(key);
            if (typeof onChange === 'function') onChange();
          });
        }

        if (menu) {
          menu.addEventListener('change', () => {
            const state = getState();
            const selected = Array.from(menu.querySelectorAll('input[type="checkbox"]:checked'))
              .map(i => i.value);
            state[key] = selected;
            saveState(state);
            applySelectionsToDom();
            if (typeof onChange === 'function') onChange();
          });
        }

        document.addEventListener('click', (e) => {
          if (!root.contains(e.target)) {
            toggleMenu(false);
          }
        });
      });
    }

    return {
      KEYS,
      getValues,
      setValues,
      createOptions,
      applySelectionsToDom,
      clearFilter,
      attachHandlers
    };
  })();

  /* Filters (simple + multi) ---------------------------------------------- */
  const Filters = (function() {
    const STORAGE_KEY_SIMPLE = 'dashboard-filters-simple-v1';

    function getElsSimple() {
      return {
        durationEl: document.getElementById('filterDuration'),
        searchEl: document.getElementById('filterSearch')
      };
    }

    function getValues() {
      const { durationEl, searchEl } = getElsSimple();
      const multi = MultiSelect.getValues();
      return {
        status: multi.status,
        rag: multi.rag,
        territory: multi.territory,
        industry: multi.industry,
        resources: multi.resources,
        utilisation: multi.utilisation,
        capability: multi.capability,
        multiTower: multi.multiTower,
        los: multi.los,
        duration: durationEl?.value || '',
        search: (searchEl?.value || '').trim().toLowerCase()
      };
    }

    function applyToInputs(values) {
      const { durationEl, searchEl } = getElsSimple();
      if (!values) return;
      if (durationEl) durationEl.value = values.duration || '';
      if (searchEl) searchEl.value = values.search || '';

      const multi = {};
      MultiSelect.KEYS.forEach(k => {
        multi[k] = Array.isArray(values[k]) ? values[k] : [];
      });
      MultiSelect.setValues(multi);
      MultiSelect.applySelectionsToDom();
    }

    function clear() {
      const { durationEl, searchEl } = getElsSimple();
      if (durationEl) durationEl.value = '';
      if (searchEl) searchEl.value = '';

      const cleared = {};
      MultiSelect.KEYS.forEach(k => { cleared[k] = []; });
      MultiSelect.setValues(cleared);
      MultiSelect.applySelectionsToDom();
      save();
    }

    function save() {
      try {
        const { durationEl, searchEl } = getElsSimple();
        const simpleState = {
          duration: durationEl?.value || '',
          search: (searchEl?.value || '')
        };
        localStorage.setItem(STORAGE_KEY_SIMPLE, JSON.stringify(simpleState));
      } catch {}
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_SIMPLE);
        const simple = raw ? JSON.parse(raw) : {};
        const multi = MultiSelect.getValues();
        return { ...simple, ...multi };
      } catch {
        return null;
      }
    }

    function renderChips() {
      const container = document.getElementById('activeFilters');
      const summaryBadge = document.getElementById('filtersSummary');
      if (!container || !summaryBadge) return;
      const v = getValues();
      const chips = [];

      if (v.status && v.status.length) chips.push({ key: 'status', label: 'Status', value: v.status.join(', ') });
      if (v.rag && v.rag.length) chips.push({ key: 'rag', label: 'RAG', value: v.rag.join(', ') });
      if (v.territory && v.territory.length) chips.push({ key: 'territory', label: 'Territory', value: v.territory.join(', ') });
      if (v.industry && v.industry.length) chips.push({ key: 'industry', label: 'Industry', value: v.industry.join(', ') });
      if (v.resources && v.resources.length) chips.push({ key: 'resources', label: 'Team Resources', value: v.resources.join(', ') });
      if (v.utilisation && v.utilisation.length) chips.push({ key: 'utilisation', label: 'Team Utilization %', value: v.utilisation.join(', ') });
      if (v.capability && v.capability.length) chips.push({ key: 'capability', label: 'Capability', value: v.capability.join(', ') });
      if (v.multiTower && v.multiTower.length) chips.push({ key: 'multiTower', label: 'Multi Tower', value: v.multiTower.join(', ') });
      if (v.los && v.los.length) chips.push({ key: 'los', label: 'LoS', value: v.los.join(', ') });
      if (v.duration) chips.push({ key: 'duration', label: 'Duration', value: v.duration });
      if (v.search) chips.push({ key: 'search', label: 'Search', value: v.search });

      const root = document.documentElement;

      if (!chips.length) {
        container.innerHTML = '<span>No filters applied.</span>';
        summaryBadge.textContent = 'No filters applied';
        root.classList.remove('filters-active');
        return;
      }

      const summaryText = `${chips.length} filter${chips.length === 1 ? '' : 's'}${v.search ? ' + search' : ''} applied`;
      summaryBadge.textContent = summaryText;

      container.innerHTML = `
        <span>${summaryText}</span>
        ${chips.map(ch => `
          <span class="filter-chip" data-filter-key="${ch.key}">
            <span class="filter-chip-label">${escapeHtml(ch.label)}:</span>
            <span>${escapeHtml(ch.value)}</span>
            <button class="filter-chip-clear" type="button" aria-label="Clear ${escapeHtml(ch.label)} filter">×</button>
          </span>
        `).join('')}
        <button class="filter-chip-clear-all" type="button" aria-label="Clear all filters">Clear all</button>
      `;

      root.classList.add('filters-active');
    }

    function attachChipHandlers(onChange) {
      const container = document.getElementById('activeFilters');
      if (!container) return;
      container.addEventListener('click', (e) => {
        const clearAllBtn = e.target.closest('.filter-chip-clear-all');
        if (clearAllBtn) {
          clear();
          if (typeof onChange === 'function') onChange();
          return;
        }
        const btn = e.target.closest('.filter-chip-clear');
        if (!btn) return;
        const chip = btn.closest('.filter-chip');
        if (!chip) return;
        const key = chip.getAttribute('data-filter-key');
        if (!key) return;

        const { durationEl, searchEl } = getElsSimple();

        if (key === 'duration' && durationEl) durationEl.value = '';
        if (key === 'search' && searchEl) searchEl.value = '';

        if (MultiSelect.KEYS.includes(key)) {
          MultiSelect.clearFilter(key);
        }

        save();
        if (typeof onChange === 'function') onChange();
      });
    }

    return { getValues, applyToInputs, clear, save, loadFromStorage, renderChips, attachChipHandlers };
  })();

  /* UI state + rendering -------------------------------------------------- */
  const UI = (function() {
    let allRows = [];
    let filteredRows = [];
    let sortKey = 'name';
    let sortDir = 'asc';
    let compact = false;

    const KPI_CONFIG = [
      { id: 'kpiTotal', valueKey: 'total' },
      { id: 'kpiAtRisk', valueKey: 'atRisk' },
      { id: 'kpiUpcoming', valueKey: 'upcoming' },
      { id: 'kpiClosed', valueKey: 'closed' }
    ];

    function setData(rows) {
      allRows = rows || [];
      filteredRows = [...allRows];
      updateGettingStartedVisibility();
    }

    function getAllRows() { return allRows; }
    function getFilteredRows() { return filteredRows; }
    function setFilteredRows(rows) { filteredRows = rows || []; }

    function getSort() { return { sortKey, sortDir }; }
    function setSort(key, dir) { sortKey = key; sortDir = dir; }

    function updateKpis(m) {
      KPI_CONFIG.forEach(({ id, valueKey }) => {
        const el = document.getElementById(id);
        if (!el) return;
        const v = m[valueKey];
        el.textContent = (v || v === 0) ? v.toLocaleString() : '–';
      });

      const multiEl = document.getElementById('kpiMultiTower');
      if (multiEl) {
        if (m.total && m.total > 0) {
          const pct = (m.multiTowerCount / m.total) * 100;
          multiEl.textContent = pct.toFixed(0) + '%';
        } else {
          multiEl.textContent = '–';
        }
      }

      const summary = document.getElementById('metricsSummary');
      if (summary) {
        summary.textContent = m.total
          ? `${m.total.toLocaleString()} project${m.total === 1 ? '' : 's'} in view across ` +
            `${m.industries.toLocaleString()} industr${m.industries === 1 ? 'y' : 'ies'} and ` +
            `${m.uniqueClients.toLocaleString()} client${m.uniqueClients === 1 ? '' : 's'}.`
          : 'No projects in view. Upload data or load a CSV from URL to get started.';
      }
    }

    function updatePortfolioChips(m) {
      const pc = document.getElementById('portfolioProjectsChip');
      const ic = document.getElementById('portfolioIndustriesChip');
      if (pc) pc.textContent = m.total
        ? `${m.total.toLocaleString()} project${m.total === 1 ? '' : 's'} in view`
        : '0 projects in view';
      if (ic) ic.textContent = `${m.industries.toLocaleString()} industr${m.industries === 1 ? 'y' : 'ies'}`;
    }

    function populateFilterOptions(rows) {
      const territories = Array.from(new Set(rows.map(r => r.territory).filter(Boolean))).sort();
      const industries = Array.from(new Set(rows.map(r => r.industry).filter(Boolean))).sort();
      const resources = Array.from(new Set(rows.map(r => r.resources).filter(Boolean))).sort();
      const utilisations = Array.from(new Set(rows.map(r => r.utilisation).filter(Boolean))).sort();
      const capabilities = Array.from(new Set(rows.map(r => r.capability).filter(Boolean))).sort();
      const multiTowers = Array.from(new Set(rows.map(r => r.multiTower).filter(Boolean))).sort();
      const losValues = Array.from(new Set(rows.map(r => r.los).filter(Boolean))).sort();
      const statuses = Array.from(new Set(rows.map(r => r.status).filter(Boolean))).sort();
      const ragValues = Array.from(new Set(rows.map(r => r.rag).filter(Boolean))).sort();

      MultiSelect.createOptions('filterStatus', statuses.length ? statuses : ['Active','On hold','Closed']);
      MultiSelect.createOptions('filterRag', ragValues.length ? ragValues : ['Green','Amber','Red']);
      MultiSelect.createOptions('filterTerritory', territories);
      MultiSelect.createOptions('filterIndustry', industries);
      MultiSelect.createOptions('filterCapability', capabilities);
      MultiSelect.createOptions('filterMultiTower', multiTowers);
      MultiSelect.createOptions('filterResources', resources);
      MultiSelect.createOptions('filterUtilisation', utilisations);
      MultiSelect.createOptions('filterLoS', losValues);

      MultiSelect.applySelectionsToDom();
    }

    function renderTable() {
      const tbody = document.querySelector('#projectsTable tbody');
      if (!tbody) return;
      const rows = filteredRows;

      if (!rows.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="17" style="text-align:center; padding:16px; color:var(--muted); font-size:11px;">
              No projects to display. Upload a dataset or load one from URL.
            </td>
          </tr>`;
      } else {
        tbody.innerHTML = rows.map(r => {
          const sc = statusColor(r.status);
          const rc = ragColor(r.rag);
          const ragLabel = r.rag || 'Unspecified';
          const statusLabel = r.status || 'Unspecified';
          const durationText = r.durationMonths != null
            ? (Math.round(r.durationMonths * 10) / 10).toFixed(1)
            : '–';
          return `
            <tr>
              <td class="col-name">${escapeHtml(r.name)}</td>
              <td class="col-capability">${escapeHtml(r.capability || '')}</td>
              <td class="col-status">
                <span class="status-pill" style="color:${sc}">
                  <span class="status-dot" style="background:${sc}"></span>${escapeHtml(statusLabel)}
                </span>
              </td>
              <td class="col-rag">
                <span class="rag-pill" style="color:${rc}">
                  <span class="rag-dot" style="background:${rc}"></span>${escapeHtml(ragLabel)}
                </span>
              </td>
              <td class="col-date">${fmtDate(r.start)}</td>
              <td class="col-date">${fmtDate(r.end)}</td>
              <td class="col-date">${durationText}</td>
              <td class="col-territory">${escapeHtml(r.territory || '')}</td>
              <td class="col-client">${escapeHtml(r.client || '')}</td>
              <td class="col-short">${escapeHtml(r.multiTower || '')}</td>
              <td class="col-short">${escapeHtml(r.resources || '')}</td>
              <td class="col-capability">${escapeHtml(r.industry || '')}</td>
              <td class="col-short">${escapeHtml(r.los || '')}</td>
              <td class="col-short">${escapeHtml(r.partner || '')}</td>
              <td class="col-short">${escapeHtml(r.utilisation || '')}</td>
              <td class="col-notes">${escapeHtml(r.scope || '')}</td>
              <td class="col-notes">${escapeHtml(r.risks || '')}</td>
            </tr>`;
        }).join('');
      }

      const totalFiltered = rows.length;
      const totalAll = allRows.length;
      const projectsCountEl = document.getElementById('projectsCount');
      const tableInfoEl = document.getElementById('tableInfo');

      if (projectsCountEl) {
        projectsCountEl.textContent = `${totalFiltered.toLocaleString()} project${totalFiltered === 1 ? '' : 's'}`;
      }
      if (tableInfoEl) {
        if (!totalAll) {
          tableInfoEl.textContent = 'No projects loaded yet.';
        } else if (!totalFiltered) {
          tableInfoEl.textContent =
            `No projects match the current filters (out of ${totalAll.toLocaleString()} total).`;
        } else {
          tableInfoEl.textContent =
            `Showing ${totalFiltered.toLocaleString()} of ${totalAll.toLocaleString()} projects`;
        }
      }
    }

    function updateSortIndicators() {
      const { sortKey: sk, sortDir: sd } = getSort();
      document.querySelectorAll('#projectsTable thead th').forEach(th => {
        const key = th.getAttribute('data-key');
        const indicator = th.querySelector('.sort-indicator');
        if (!indicator) return;
        if (key === sk) {
          indicator.textContent = sd === 'asc' ? '▲' : '▼';
          th.setAttribute('aria-sort', sd === 'asc' ? 'ascending' : 'descending');
        } else {
          indicator.textContent = '';
          th.setAttribute('aria-sort', 'none');
        }
      });
    }

    function exportCsv() {
      const rows = filteredRows;
      if (!rows.length) {
        Message.show('No projects in the current view to export.', 'info');
        return;
      }

      const headers = [
        'Project Name','Capability','Status','RAG','Start_Date','End_Date',
        'Duration (months)','Territory','Client','Multi Tower','Team Resources',
        'Industry','LoS','Partner','Team Utilization %','Project Scope','Risks/Challenges'
      ];

      const records = rows.map(r => ({
        'Project Name': r.name,
        'Capability': r.capability || '',
        'Status': r.status,
        'RAG': r.rag || '',
        'Start_Date': r.start ? fmtDate(r.start) : '',
        'End_Date': r.end ? fmtDate(r.end) : '',
        'Duration (months)': r.durationMonths != null
          ? (Math.round(r.durationMonths * 10) / 10).toFixed(1)
          : '',
        'Territory': r.territory || '',
        'Client': r.client || '',
        'Multi Tower': r.multiTower || '',
        'Team Resources': r.resources || '',
        'Industry': r.industry || '',
        'LoS': r.los || '',
        'Partner': r.partner || '',
        'Team Utilization %': r.utilisation || '',
        'Project Scope': r.scope || '',
        'Risks/Challenges': r.risks || ''
      }));

      const escapeField = (v) => {
        const s = String(v ?? '');
        if (/[",\n]/.test(s)) {
          return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
      };

      const csvLines = [headers.join(',')];
      records.forEach(row => {
        csvLines.push(headers.map(h => escapeField(row[h])).join(','));
      });

      const blob = new Blob([csvLines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const now = new Date();
      const ts = now.toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `portfolio_export_${ts}.csv`;
      a.href = url;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      Message.show('CSV exported for current view.', 'success', 3000);
    }

    function toggleDensity() {
      const btn = document.getElementById('toggleDensity');
      const table = document.getElementById('projectsTable');
      if (!btn || !table) return;
      compact = !compact;
      btn.setAttribute('aria-pressed', compact ? 'true' : 'false');
      btn.textContent = compact ? 'Comfortable view' : 'Compact view';
      table.classList.toggle('compact', compact);
    }

    function updateGettingStartedVisibility() {
      const panel = document.getElementById('gettingStarted');
      if (!panel) return;
      const visible = !allRows.length;
      panel.classList.toggle('is-hidden', !visible);
      panel.setAttribute('aria-hidden', visible ? 'false' : 'true');
    }

    return {
      setData, getAllRows, getFilteredRows, setFilteredRows,
      getSort, setSort, updateKpis, updatePortfolioChips,
      populateFilterOptions, renderTable, updateSortIndicators,
      exportCsv, toggleDensity, updateGettingStartedVisibility
    };
  })();

  /* Charts --------------------------------------------------------------- */
  const Charts = (function() {
    let statusChart = null;
    let industryChart = null;
    let territoryChart = null;
    let ragChart = null;
    let losChart = null;

    function ensureChartAvailable() {
      return typeof Chart !== 'undefined';
    }

    function hasDatalabels() {
      return !!(window.Chart && window.ChartDataLabels);
    }

    function buildStatusChart(_statusCounts, onClickFilter, rowsForDurations) {
      if (!ensureChartAvailable()) return;
      const ctx = document.getElementById('statusChart');
      const emptyOverlay = document.getElementById('statusEmpty');
      if (!ctx) return;

      const labels = ['0 – 6 months', '6 – 12 months', 'More than 1 year'];

      const durationCounts = { '0-6': 0, '6-12': 0, '12+': 0 };

      (rowsForDurations || []).forEach(r => {
        if (r.durationMonths == null || r.durationMonths < 0) return;
        const m = r.durationMonths;
        if (m >= 0 && m <= 6) durationCounts['0-6'] += 1;
        else if (m > 6 && m <= 12) durationCounts['6-12'] += 1;
        else if (m > 12) durationCounts['12+'] += 1;
      });

      const data = [
        durationCounts['0-6'],
        durationCounts['6-12'],
        durationCounts['12+']
      ];

      const hasData = data.some(v => v > 0);
      if (emptyOverlay) emptyOverlay.style.display = hasData ? 'none' : 'flex';

      if (!hasData) {
        if (statusChart) statusChart.destroy();
        statusChart = null;
        return;
      }

      const colors = getChartColors();
      const dataset = {
        data,
        backgroundColor: [colors.accent, '#9ca3af', colors.hold],
        borderWidth: 0,
        borderRadius: 12
      };

      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              label: (c) => {
                const count = c.parsed.y || 0;
                return `${c.label}: ${count} project${count === 1 ? '' : 's'}`;
              }
            }
          },
          datalabels: hasDatalabels() ? {
            anchor: 'end',
            align: 'end',
            offset: 4,
            color: colors.label,
            font: { size: 11, weight: '500' },
            formatter: (v) => {
              if (!v) return '';
              return `${v} proj`;
            }
          } : {}
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: colors.label }
          },
          y: {
            beginAtZero: true,
            ticks: { color: colors.label },
            grid: { color: colors.grid },
            title: {
              display: true,
              text: 'Number of projects',
              color: colors.label,
              font: { size: 11 }
            }
          }
        },
        onClick: (evt, elements) => {
          if (!elements || !elements.length) return;
          const idx = elements[0].index;
          const label = labels[idx];
          const durationEl = document.getElementById('filterDuration');
          if (!durationEl) return;
          if (label === '0 – 6 months') durationEl.value = '0-6';
          else if (label === '6 – 12 months') durationEl.value = '6-12';
          else if (label === 'More than 1 year') durationEl.value = '12+';
          Filters.save();
          applyFiltersAndRender();
        }
      };

      if (statusChart) {
        statusChart.data.labels = labels;
        statusChart.data.datasets[0] = dataset;
        statusChart.options = baseOptions;
        statusChart.update();
      } else {
        statusChart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [dataset] },
          options: baseOptions
        });
      }
    }

    function buildIndustryChart(industryCounts) {
      if (!ensureChartAvailable()) return;
      const ctx = document.getElementById('industryChart');
      const emptyOverlay = document.getElementById('industryEmpty');
      if (!ctx) return;

      const entries = Object.entries(industryCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      const labels = entries.map(([k]) => k || 'Unspecified');
      const data = entries.map(([, v]) => v);
      const total = data.reduce((a, b) => a + b, 0);
      const totalEl = document.getElementById('industryTotalProjects');
      if (totalEl) totalEl.textContent = total ? total.toLocaleString() : '–';

      if (emptyOverlay) emptyOverlay.style.display = total ? 'none' : 'flex';
      if (!total) {
        if (industryChart) industryChart.destroy();
        industryChart = null;
        return;
      }

      const colors = getChartColors();
      const palette = [
        colors.accent, '#10b981', '#3b82f6', '#ec4899',
        '#a855f7', '#f97316', '#22c55e', '#0ea5e9'
      ];
      const barColors = data.map((_, i) => palette[i % palette.length]);

      const dataset = {
        data,
        backgroundColor: barColors,
        borderWidth: 0,
        borderRadius: 6,
        barThickness: 14,
        maxBarThickness: 18
      };

      const baseOptions = {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              title: (items) => items[0]?.label || '',
              label: (c) => {
                const v = c.parsed.x || 0;
                const pct = total ? (v / total * 100) : 0;
                return `${v.toLocaleString()} project${v === 1 ? '' : 's'} (${pct.toFixed(1)}%)`;
              }
            }
          },
          datalabels: hasDatalabels() ? {
            anchor: 'end',
            align: 'right',
            clamp: true,
            clip: true,
            color: colors.label,
            font: { size: 9, weight: '500' },
            formatter: (v) => v ? v.toLocaleString() : ''
          } : {}
        },
        scales: {
          x: {
            ticks: { color: colors.label },
            grid: { color: colors.grid }
          },
          y: {
            ticks: { color: colors.label },
            grid: { display: false }
          }
        }
      };

      if (industryChart) {
        industryChart.data.labels = labels;
        industryChart.data.datasets[0] = dataset;
        industryChart.options = baseOptions;
        industryChart.update();
      } else {
        industryChart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [dataset] },
          options: baseOptions
        });
      }
    }

    function buildTerritoryChart(territoryCounts) {
      if (!ensureChartAvailable()) return;
      const ctx = document.getElementById('territoryChart');
      const emptyOverlay = document.getElementById('territoryEmpty');
      if (!ctx) return;

      const entries = Object.entries(territoryCounts).sort((a, b) => b[1] - a[1]);
      const labels = entries.map(([k]) => k || 'Unspecified');
      const data = entries.map(([, v]) => v);
      const total = data.reduce((a, b) => a + b, 0);

      if (emptyOverlay) emptyOverlay.style.display = total ? 'none' : 'flex';
      if (!total) {
        if (territoryChart) territoryChart.destroy();
        territoryChart = null;
        return;
      }

      const colors = getChartColors();
      const accent = colors.accent;
      const secondary = '#10b981';
      const neutral = '#e5e7eb';

      const barColors = data.map((_, i) => {
        if (i === 0) return accent;
        if (i === 1) return secondary;
        return neutral;
      });

      const dataset = {
        data,
        backgroundColor: barColors,
        borderWidth: 0,
        borderRadius: 6,
        barThickness: 14,
        maxBarThickness: 18
      };

      const baseOptions = {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              title: (items) => items[0]?.label || '',
              label: (c) => {
                const v = c.parsed.x || 0;
                const pct = total ? (v / total * 100) : 0;
                return `${v.toLocaleString()} project${v === 1 ? '' : 's'} (${pct.toFixed(1)}%)`;
              }
            }
          },
          datalabels: hasDatalabels() ? {
            anchor: 'end',
            align: 'right',
            clamp: true,
            clip: true,
            color: colors.label,
            font: { size: 9, weight: '500' },
            formatter: (v) => v ? v.toLocaleString() : ''
          } : {}
        },
        scales: {
          x: {
            ticks: { color: colors.label },
            grid: { color: colors.grid }
          },
          y: {
            ticks: { color: colors.label },
            grid: { display: false }
          }
        }
      };

      if (territoryChart) {
        territoryChart.data.labels = labels;
        territoryChart.data.datasets[0] = dataset;
        territoryChart.options = baseOptions;
        territoryChart.update();
      } else {
        territoryChart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [dataset] },
          options: baseOptions
        });
      }
    }

    function buildLoSChart(losCounts) {
      if (!ensureChartAvailable()) return;
      const ctx = document.getElementById('losChart');
      const emptyOverlay = document.getElementById('losEmpty');
      if (!ctx) return;

      const entries = Object.entries(losCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      const labels = entries.map(([k]) => k || 'Unspecified');
      const data = entries.map(([, v]) => v);
      const total = data.reduce((a, b) => a + b, 0);

      if (emptyOverlay) emptyOverlay.style.display = total ? 'none' : 'flex';
      if (!total) {
        if (losChart) losChart.destroy();
        losChart = null;
        return;
      }

      const colors = getChartColors();
      const palette = [
        colors.accent, '#10b981', '#3b82f6', '#ec4899',
        '#a855f7', '#f97316', '#22c55e', '#0ea5e9'
      ];
      const barColors = data.map((_, i) => palette[i % palette.length]);

      const dataset = {
        data,
        backgroundColor: barColors,
        borderWidth: 0,
        borderRadius: 6,
        barThickness: 14,
        maxBarThickness: 18
      };

      const baseOptions = {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              title: items => items[0]?.label || '',
              label: c => {
                const v = c.parsed.x || 0;
                const pct = total ? (v / total * 100) : 0;
                return `${v.toLocaleString()} project${v === 1 ? '' : 's'} (${pct.toFixed(1)}%)`;
              }
            }
          },
          datalabels: hasDatalabels() ? {
            anchor: 'end',
            align: 'right',
            clamp: true,
            clip: true,
            color: colors.label,
            font: { size: 9, weight: '500' },
            formatter: v => v ? v.toLocaleString() : ''
          } : {}
        },
        scales: {
          x: {
            ticks: { color: colors.label },
            grid: { color: colors.grid }
          },
          y: {
            ticks: { color: colors.label },
            grid: { display: false }
          }
        }
      };

      if (losChart) {
        losChart.data.labels = labels;
        losChart.data.datasets[0] = dataset;
        losChart.options = baseOptions;
        losChart.update();
      } else {
        losChart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [dataset] },
          options: baseOptions
        });
      }
    }

    function buildRagDonut(ragCounts, onClickFilter) {
      if (!ensureChartAvailable()) return;
      const ctx = document.getElementById('ragDonut');
      const centerEl = document.getElementById('ragDonutCenter');
      const emptyOverlay = document.getElementById('ragEmpty');
      if (!ctx || !centerEl) return;

      const labels = ['Green', 'Amber', 'Red'];
      const theData = labels.map(l => ragCounts[l] || 0);
      const colors = getChartColors();
      const ringColors = [colors.green, colors.amber, colors.red];
      const totalDefined = theData.reduce((a, b) => a + b, 0);

      if (centerEl.firstChild) {
        centerEl.firstChild.nodeValue = totalDefined ? totalDefined.toLocaleString() : '–';
      } else {
        centerEl.textContent = totalDefined ? totalDefined.toLocaleString() : '–';
      }

      if (emptyOverlay) emptyOverlay.style.display = totalDefined ? 'none' : 'flex';
      if (!totalDefined) {
        if (ragChart) ragChart.destroy();
        ragChart = null;
        return;
      }

      const baseOptions = {
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              label: (c) => {
                const v = c.parsed || 0;
                const ds = c.chart.data.datasets?.[c.datasetIndex];
                const total = ds && Array.isArray(ds.data)
                  ? ds.data.reduce((a, b) => a + (b || 0), 0)
                  : 0;
                const pct = total ? (v / total * 100) : 0;
                return `${c.label}: ${v.toLocaleString()} project${v === 1 ? '' : 's'} (${pct.toFixed(1)}%)`;
              }
            }
          },
          datalabels: { display: false }
        },
        maintainAspectRatio: false,
        onClick: (evt, elements) => {
          if (!elements || !elements.length || !onClickFilter) return;
          const idx = elements[0].index;
          const label = labels[idx];
          if (label) onClickFilter('rag', label);
        }
      };

      const dataset = {
        data: theData,
        backgroundColor: ringColors,
        borderWidth: 0,
        cutout: '65%'
      };

      if (ragChart) {
        ragChart.data.labels = labels;
        ragChart.data.datasets[0] = dataset;
        ragChart.options = baseOptions;
        ragChart.update();
      } else {
        ragChart = new Chart(ctx, {
          type: 'doughnut',
          data: { labels, datasets: [dataset] },
          options: baseOptions
        });
      }
    }

    function exportChartPng(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) {
        Message.show('Chart not found for export.', 'error');
        return;
      }
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      const now = new Date();
      const ts = now.toISOString().slice(0,19).replace(/[:T]/g,'-');
      link.download = `${canvasId}_${ts}.png`;
      link.click();
    }

    function rebuildAll(m, onClickFilter, rows) {
      buildStatusChart(m.statusCounts, onClickFilter, rows);
      buildIndustryChart(m.industryCounts);
      buildTerritoryChart(m.territoryCounts);
      buildLoSChart(m.losCounts);
      buildRagDonut(m.ragCounts, onClickFilter);
    }

    return { rebuildAll, exportChartPng };
  })();

  /* Main App orchestration ------------------------------------------------ */
  const App = (function() {
    function applyStoredTheme() {
      let stored = null;
      try {
        stored = window.localStorage && localStorage.getItem('dashboard-theme');
      } catch {}
      const mm = safeMatchMedia('(prefers-color-scheme: dark)');
      const theme = stored || (mm && mm.matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
      const toggle = document.getElementById('themeToggle');
      if (toggle) toggle.checked = theme === 'dark';
    }

    function applyFiltersAndRender() {
      const allRows = UI.getAllRows();
      const f = Filters.getValues();

      const filtered = allRows.filter(r => {
        if (f.status && f.status.length && !f.status.includes(r.status)) return false;
        if (f.rag && f.rag.length && !f.rag.includes(r.rag || '')) return false;
        if (f.territory && f.territory.length && !f.territory.includes(r.territory)) return false;
        if (f.industry && f.industry.length && !f.industry.includes(r.industry)) return false;
        if (f.resources && f.resources.length && !f.resources.includes(r.resources)) return false;
        if (f.utilisation && f.utilisation.length && !f.utilisation.includes(r.utilisation)) return false;
        if (f.capability && f.capability.length && !f.capability.includes(r.capability)) return false;
        if (f.multiTower && f.multiTower.length && !f.multiTower.includes(r.multiTower)) return false;
        if (f.los && f.los.length && !f.los.includes(r.los)) return false;

        if (f.duration && r.durationMonths != null) {
          const m = r.durationMonths;
          if (f.duration === '0-6' && !(m >= 0 && m <= 6)) return false;
          if (f.duration === '6-12' && !(m > 6 && m <= 12)) return false;
          if (f.duration === '12+' && !(m > 12)) return false;
        } else if (f.duration && r.durationMonths == null) {
          return false;
        }

        if (f.search) {
          const text = (
            r.name + ' ' + (r.capability || '') + ' ' + (r.client || '') + ' ' +
            (r.notes || '') + ' ' + (r.scope || '') + ' ' + (r.risks || '') + ' ' +
            (r.resources || '') + ' ' + (r.utilisation || '') + ' ' +
            (r.multiTower || '') + ' ' + (r.los || '') + ' ' + (r.partner || '')
          ).toLowerCase();
          if (!text.includes(f.search)) return false;
        }

        return true;
      });

      const { sortKey, sortDir } = UI.getSort();
      const dir = sortDir === 'asc' ? 1 : -1;
      filtered.sort((a, b) => compare(a, b, sortKey) * dir);

      UI.setFilteredRows(filtered);
      const m = DataService.computeMetrics(filtered);
      UI.updateKpis(m);
      UI.updatePortfolioChips(m);
      Charts.rebuildAll(m, handleChartClickFilter, filtered);
      UI.renderTable();
      UI.updateSortIndicators();
      Filters.renderChips();
    }

    const applyFiltersDebounced = debounce(applyFiltersAndRender, 150);

    function handleChartClickFilter(type, value) {
      if (type === 'rag') {
        const values = MultiSelect.getValues();
        if (!values.rag.includes(value)) {
          values.rag = [value];
        } else {
          values.rag = values.rag.filter(v => v !== value);
        }
        MultiSelect.setValues(values);
        MultiSelect.applySelectionsToDom();
      }
      Filters.save();
      applyFiltersAndRender();
      Message.show(`Filter applied from chart: ${type.toUpperCase()} = ${value}`, 'info', 3000);
    }

    function parseExcel(file, callback, errorCallback) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          if (!window.XLSX) throw new Error('XLSX library not loaded.');
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];

          const rawRows = XLSX.utils.sheet_to_json(sheet, {
            defval: '',
            raw: true
          });

          const normalizedRows = rawRows.map(row => {
            const newRow = { ...row };
            Object.keys(newRow).forEach(key => {
              const lk = key.toLowerCase();
              if (lk === 'start_date' || lk === 'start date' || lk === 'start') {
                newRow[key] = normalizeXlsxDateValue(newRow[key]);
              }
              if (lk === 'end_date' || lk === 'end date' || lk === 'end') {
                newRow[key] = normalizeXlsxDateValue(newRow[key]);
              }
            });
            return newRow;
          });

          callback(normalizedRows);
        } catch (err) {
          console.error(err);
          if (errorCallback) errorCallback(err);
        }
      };
      reader.onerror = (err) => {
        if (errorCallback) errorCallback(err);
      };
      reader.readAsArrayBuffer(file);
    }

    function handleUpload(file) {
      const name = file.name.toLowerCase();
      const isExcel = name.endsWith('.xls') || name.endsWith('.xlsx');
      const isCsv = name.endsWith('.csv');

      const postProcessRows = (rawRows, label) => {
        if (!rawRows || !rawRows.length) {
          Message.show(`No rows detected in the uploaded ${label}.`, 'error');
          return;
        }
        const rows = rawRows.map(DataService.normalizeRow);
        UI.setData(rows);
        UI.populateFilterOptions(rows);
        Filters.clear();
        applyFiltersAndRender();
        Message.show(
          `Loaded ${rows.length.toLocaleString()} rows from uploaded ${label}.`,
          'success',
          4000
        );
      };

      if (isExcel) {
        if (!window.XLSX) {
          Message.show('Excel support library is not available. Please use CSV.', 'error');
          return;
        }
        parseExcel(
          file,
          (rawRows) => postProcessRows(rawRows, 'Excel file'),
          () => Message.show('Error parsing uploaded Excel file.', 'error')
        );
        return;
      }

      if (isCsv) {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const text = e.target.result;
            const rawRows = DataService.parseCsv(text);
            postProcessRows(rawRows, 'CSV file');
          } catch (err) {
            console.error(err);
            Message.show('Error parsing uploaded CSV file.', 'error');
          }
        };
        reader.readAsText(file);
        return;
      }

      Message.show('Unsupported file type. Please upload a CSV or Excel (.xls, .xlsx) file.', 'error');
    }

    async function loadDataFromUrl(url) {
      try {
        Message.show('Loading data from URL…', 'info', 4000);
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const rawRows = DataService.parseCsv(text);
        if (!rawRows.length) {
          Message.show('No rows detected in the CSV at the provided URL.', 'error');
          return;
        }
        const rows = rawRows.map(DataService.normalizeRow);
        UI.setData(rows);
        UI.populateFilterOptions(rows);
        Filters.clear();
        applyFiltersAndRender();
        Message.show(`Loaded ${rows.length.toLocaleString()} rows from URL.`, 'success', 4000);
      } catch (err) {
        console.error(err);
        Message.show('Error loading data from URL: ' + err.message, 'error');
      }
    }

    function initTheme() {
      applyStoredTheme();
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.addEventListener('change', () => {
          const theme = themeToggle.checked ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', theme);
          try {
            localStorage.setItem('dashboard-theme', theme);
          } catch {}
          const m = DataService.computeMetrics(UI.getFilteredRows());
          Charts.rebuildAll(m, handleChartClickFilter, UI.getFilteredRows());
        });
      }
    }

    function initAsOf() {
      const asOfEl = document.getElementById('asOf');
      const asOfTopEl = document.getElementById('asOfTop');
      const now = new Date();
      const fmtIntl = new Intl.DateTimeFormat('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
      const text = 'As of ' + fmtIntl.format(now);
      if (asOfEl) asOfEl.textContent = text;
      if (asOfTopEl) asOfTopEl.textContent = text;
    }

    function initFilters() {
      MultiSelect.attachHandlers(() => {
        Filters.save();
        applyFiltersDebounced();
      });

      const durationEl = document.getElementById('filterDuration');
      const searchEl = document.getElementById('filterSearch');

      const onChangeSimple = () => {
        Filters.save();
        applyFiltersDebounced();
      };

      if (durationEl) durationEl.addEventListener('change', onChangeSimple);
      if (searchEl) searchEl.addEventListener('input', onChangeSimple);

      const headerClearBtn = document.getElementById('filtersHeaderClear');
      const clearAll = () => {
        Filters.clear();
        applyFiltersAndRender();
      };
      if (headerClearBtn) headerClearBtn.addEventListener('click', clearAll);

      Filters.attachChipHandlers(applyFiltersAndRender);
    }

    function initTableSorting() {
      document.querySelectorAll('#projectsTable thead th').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (!key || !UI.getAllRows().length) return;
          const { sortKey, sortDir } = UI.getSort();
          if (sortKey === key) {
            UI.setSort(key, sortDir === 'asc' ? 'desc' : 'asc');
          } else {
            UI.setSort(key, 'asc');
          }
          applyFiltersAndRender();
        });
        th.tabIndex = 0;
        th.setAttribute('aria-sort', 'none');
        th.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            th.click();
          }
        });
      });

      const toggleDensityBtn = document.getElementById('toggleDensity');
      if (toggleDensityBtn) toggleDensityBtn.addEventListener('click', UI.toggleDensity);
    }

    function initOtherControls() {
      const toggleFiltersBtn = document.getElementById('toggleFilters');
      const filterBar = document.getElementById('filterBar');
      const filtersHeader = document.getElementById('filtersHeader');

      if (toggleFiltersBtn && filterBar) {
        toggleFiltersBtn.addEventListener('click', () => {
          const isVisible = filterBar.style.display !== 'none';
          const nextVisible = !isVisible;

          filterBar.style.display = nextVisible ? 'block' : 'none';
          if (filtersHeader) {
            filtersHeader.style.display = nextVisible ? 'flex' : 'none';
          }

          const labelSpan = toggleFiltersBtn.querySelector('span:last-child');
          if (labelSpan) {
            labelSpan.textContent = nextVisible ? 'Hide filters' : 'Show filters';
          }
          toggleFiltersBtn.setAttribute('aria-expanded', String(nextVisible));
        });
      }

      const uploadInput = document.getElementById('uploadData');
      if (uploadInput) {
        uploadInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          handleUpload(file);
          e.target.value = '';
        });
      }

      const loadUrlBtn = document.getElementById('btnLoadFromUrl');
      if (loadUrlBtn) {
        loadUrlBtn.addEventListener('click', async () => {
          const url = prompt('Enter the URL to a CSV file (must be publicly accessible or CORS-enabled):');
          if (!url) return;
          await loadDataFromUrl(url.trim());
        });
      }

      const resetBtn = document.getElementById('btnResetDashboard');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          if (!confirm('This will clear all currently loaded data and reset the view. Continue?')) return;
          UI.setData([]);
          UI.populateFilterOptions([]);
          Filters.clear();
          const m = DataService.computeMetrics([]);
          UI.updateKpis(m);
          UI.updatePortfolioChips(m);
          Charts.rebuildAll(m, handleChartClickFilter, []);
          UI.renderTable();
          UI.updateSortIndicators();
          Filters.renderChips();
          Message.show('Dashboard reset. No data is loaded.', 'info', 4000);
        });
      }

      const exportBtn = document.getElementById('btnExportCsv');
      if (exportBtn) exportBtn.addEventListener('click', UI.exportCsv);

      const printModeToggle = document.getElementById('printModeToggle');
      const printNowBtn = document.getElementById('btnPrintNow');
      if (printModeToggle) {
        printModeToggle.addEventListener('click', () => {
          const current = document.documentElement.getAttribute('data-print-mode') || 'off';
          const next = current === 'on' ? 'off' : 'on';
          document.documentElement.setAttribute('data-print-mode', next);
          if (next === 'on') {
            printModeToggle.textContent = 'Exit print-friendly view';
            if (printNowBtn) printNowBtn.classList.remove('btn-print-now-hidden');
            document.documentElement.setAttribute('data-theme', 'light');
            const themeToggleEl = document.getElementById('themeToggle');
            if (themeToggleEl) themeToggleEl.checked = false;
          } else {
            printModeToggle.textContent = 'Print-friendly view';
            if (printNowBtn) printNowBtn.classList.add('btn-print-now-hidden');
            applyStoredTheme();
          }
          const rows = UI.getFilteredRows();
          const m = DataService.computeMetrics(rows);
          Charts.rebuildAll(m, handleChartClickFilter, rows);
        });
      }

      if (printNowBtn) {
        printNowBtn.addEventListener('click', () => {
          window.print();
        });
      }

      const downloadHtmlBtn = document.getElementById('btnDownloadHtml');
      if (downloadHtmlBtn) {
        downloadHtmlBtn.addEventListener('click', () => {
          const rows = UI.getAllRows();
          const filtersValues = Filters.getValues();
          const sort = UI.getSort();
          let html = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;

          if (rows && rows.length) {
            const rawEmbedded = rows.map(r => ({
              "Project Name": r.name,
              "Capability": r.capability,
              "Status": r.status,
              "RAG": r.rag,
              "Start_Date": r.start ? fmtDate(r.start) : null,
              "End_Date": r.end ? fmtDate(r.end) : null,
              "Duration (months)": r.durationMonths != null
                ? (Math.round(r.durationMonths * 10) / 10).toFixed(1)
                : null,
              "Territory": r.territory,
              "Client": r.client,
              "Multi Tower": r.multiTower,
              "Team Resources": r.resources,
              "Industry": r.industry,
              "LoS": r.los,
              "Partner": r.partner,
              "Team Utilization %": r.utilisation,
              "Project Scope": r.scope,
              "Risks/Challenges": r.risks,
              "Notes": r.notes
            }));

            const json = JSON.stringify(rawEmbedded, null, 2);
            const newEmbeddedSnippet = "window.embeddedData = " + json + ";";
            if (/window\.embeddedData\s*=\s*\[[\s\S]*?\];/.test(html)) {
              html = html.replace(
                /window\.embeddedData\s*=\s*\[[\s\S]*?\];/,
                newEmbeddedSnippet
              );
            } else {
              html = html.replace(
                /window\.embeddedData\s*=\s*window\.embeddedData\s*\|\|\s*\[\];/,
                newEmbeddedSnippet
              );
            }

            const filterJson = JSON.stringify(filtersValues, null, 2);
            const sortJson = JSON.stringify(sort, null, 2);
            const newStateSnippet =
              newEmbeddedSnippet +
              "\n window.embeddedFilters = " + filterJson + ";\n" +
              " window.embeddedSort = " + sortJson + ";\n";
            html = html.replace(newEmbeddedSnippet, newStateSnippet);
            html = html.replace(/#data=[^'"]*/g, '');
          }

          const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const now = new Date();
          const ts = now.toISOString().slice(0,19).replace(/[:T]/g,'-');
          a.download = `executive_dashboard_${ts}.html`;
          a.href = url;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }

      const shareViewBtn = document.getElementById('btnShareView');
      if (shareViewBtn) {
        shareViewBtn.addEventListener('click', () => {
          const rows = UI.getAllRows();
          if (!rows || !rows.length) {
            Message.show('No data loaded. Load data before sharing a view.', 'info', 4000);
            return;
          }
          const filtersValues = Filters.getValues();
          const sort = UI.getSort();

          const state = (function serializeState(rows, filtersValues, sort) {
            const plainRows = rows.map(r => ({
              name: r.name,
              capability: r.capability,
              status: r.status,
              rag: r.rag,
              start: r.start ? fmtDate(r.start) : null,
              end: r.end ? fmtDate(r.end) : null,
              durationMonths: r.durationMonths,
              territory: r.territory,
              client: r.client,
              multiTower: r.multiTower,
              resources: r.resources,
              industry: r.industry,
              los: r.los,
              partner: r.partner,
              utilisation: r.utilisation,
              notes: r.notes,
              scope: r.scope,
              risks: r.risks
            }));
            return { rows: plainRows, filters: filtersValues, sort };
          })(rows, filtersValues, sort);

          if (!window.LZString) {
            Message.show('Unable to generate shareable link (compression library missing).', 'error', 5000);
            return;
          }

          const encoded = LZString.compressToEncodedURIComponent(JSON.stringify(state));
          const base = window.location.origin + window.location.pathname + (window.location.search || '');
          const shareUrl = base + '#data=' + encoded;
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(shareUrl)
                .then(() => Message.show('Shareable link copied to clipboard.', 'success', 4000))
                .catch(() => { prompt('Copy this URL:', shareUrl); });
            } else {
              prompt('Copy this URL:', shareUrl);
            }
          } catch {
            prompt('Copy this URL:', shareUrl);
          }
        });
      }

      let resizeTimeout = null;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const rows = UI.getFilteredRows();
          const m = DataService.computeMetrics(rows);
          Charts.rebuildAll(m, handleChartClickFilter, rows);
        }, 150);
      });

      document.querySelectorAll('[data-export-chart]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-export-chart');
          Charts.exportChartPng(id);
        });
      });
    }

    function tryRestoreFromShareLink() {
      const hash = window.location.hash || '';
      if (!hash.startsWith('#data=')) return false;
      if (!window.LZString) return false;
      try {
        const encoded = hash.slice('#data='.length);
        const json = LZString.decompressFromEncodedURIComponent(encoded);
        if (!json) return false;
        const state = JSON.parse(json);
        if (!state || !Array.isArray(state.rows)) return false;

        const rows = state.rows.map(r => DataService.normalizeRow(r));
        UI.setData(rows);
        UI.populateFilterOptions(rows);
        Filters.applyToInputs(state.filters || {});
        UI.setSort(state.sort?.sortKey || 'name', state.sort?.sortDir || 'asc');
        applyFiltersAndRender();
        UI.updateGettingStartedVisibility();
        Message.show('View restored from shared link.', 'success', 5000);
        return true;
      } catch {
        return false;
      }
    }

    function tryRestoreFromEmbeddedOrStorage() {
      const hasEmbeddedData = Array.isArray(window.embeddedData) && window.embeddedData.length;
      const hasEmbeddedFilters = !!window.embeddedFilters;
      const hasEmbeddedSort = !!window.embeddedSort;

      if (hasEmbeddedData) {
        const rows = window.embeddedData.map(DataService.normalizeRow);
        UI.setData(rows);
        UI.populateFilterOptions(rows);

        if (hasEmbeddedFilters) {
          Filters.applyToInputs(window.embeddedFilters || {});
        } else {
          const stored = Filters.loadFromStorage();
          if (stored) Filters.applyToInputs(stored);
        }

        if (hasEmbeddedSort && window.embeddedSort && window.embeddedSort.sortKey) {
          UI.setSort(window.embeddedSort.sortKey, window.embeddedSort.sortDir || 'asc');
        }

        applyFiltersAndRender();
        UI.updateGettingStartedVisibility();
        Message.show('Loaded embedded dataset and view from this HTML file.', 'info', 5000);
        return true;
      }

      const storedFilters = Filters.loadFromStorage();
      if (storedFilters) {
        Filters.applyToInputs(storedFilters);
      }
      return false;
    }

    function init() {
      initTheme();
      initAsOf();
      initFilters();
      initTableSorting();
      initOtherControls();

      const restoredFromLink = tryRestoreFromShareLink();
      if (restoredFromLink) return;

      const restoredFromEmbedded = tryRestoreFromEmbeddedOrStorage();
      if (restoredFromEmbedded) return;

      UI.setData([]);
      UI.populateFilterOptions([]);
      Filters.clear();
      const m = DataService.computeMetrics([]);
      UI.updateKpis(m);
      UI.updatePortfolioChips(m);
      Charts.rebuildAll(m, handleChartClickFilter, []);
      UI.renderTable();
      UI.updateSortIndicators();
      Filters.renderChips();
      UI.updateGettingStartedVisibility();
      Message.show(
        'No data loaded. Upload a CSV/Excel or load a CSV from URL to populate this dashboard.',
        'info',
        8000
      );
    }

    return { init };
  })();

  return { App };
})();

/* Bootstrapping ----------------------------------------------------------- */
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => Dashboard.App.init());
} else {
  Dashboard.App.init();
}
</script>
</body>
</html>